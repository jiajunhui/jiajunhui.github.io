<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;always&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script><script src="/js/config.js"></script>
<meta name="description" content="PackageManagerService是android系统核心服务之一，它主要负责的工作如下：一.  解析AndroidManifest.xml文件，解析清单文件中的所有节点信息。二.  扫描.apk文件，安装系统应用，本地应用等。三.  管理本地应用，主要有：安装、卸载、应用信息查询等。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android PKMS核心分析">
<meta property="og:url" content="http://example.com/2019/08/29/android_pms/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="PackageManagerService是android系统核心服务之一，它主要负责的工作如下：一.  解析AndroidManifest.xml文件，解析清单文件中的所有节点信息。二.  扫描.apk文件，安装系统应用，本地应用等。三.  管理本地应用，主要有：安装、卸载、应用信息查询等。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/android_pms_01.png">
<meta property="og:image" content="http://example.com/images/android_pms_02.png">
<meta property="og:image" content="http://example.com/images/android_pms_03.png">
<meta property="og:image" content="http://example.com/images/android_pms_04.png">
<meta property="og:image" content="http://example.com/images/android_pms_05.png">
<meta property="og:image" content="http://example.com/images/android_pms_06.png">
<meta property="og:image" content="http://example.com/images/android_pms_07.png">
<meta property="og:image" content="http://example.com/images/android_pms_08.png">
<meta property="og:image" content="http://example.com/images/android_pms_09.png">
<meta property="og:image" content="http://example.com/images/android_pms_10.png">
<meta property="og:image" content="http://example.com/images/android_pms_11.png">
<meta property="og:image" content="http://example.com/images/android_pms_12.png">
<meta property="og:image" content="http://example.com/images/android_pms_13.png">
<meta property="article:published_time" content="2019-08-29T13:41:00.000Z">
<meta property="article:modified_time" content="2023-01-04T07:33:16.933Z">
<meta property="article:author" content="小贾">
<meta property="article:tag" content="系统机制">
<meta property="article:tag" content="PKMS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/android_pms_01.png">


<link rel="canonical" href="http://example.com/2019/08/29/android_pms/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2019&#x2F;08&#x2F;29&#x2F;android_pms&#x2F;&quot;,&quot;path&quot;:&quot;2019&#x2F;08&#x2F;29&#x2F;android_pms&#x2F;&quot;,&quot;title&quot;:&quot;Android PKMS核心分析&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Android PKMS核心分析 | 奔跑的蜗牛</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">奔跑的蜗牛</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PKMS%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.</span> <span class="nav-text">PKMS架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9B%BE%E5%85%B3%E7%B3%BB"><span class="nav-number">2.1.</span> <span class="nav-text">类图关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-number">2.2.</span> <span class="nav-text">继承关系</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PKMS%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">PKMS启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SystemServer%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.</span> <span class="nav-text">SystemServer的启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SystemServer%E4%B8%83%E9%83%A8%E6%9B%B2"><span class="nav-number">3.1.1.</span> <span class="nav-text">SystemServer七部曲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8startBootstrapServices-%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.1.2.</span> <span class="nav-text">调用startBootstrapServices()服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8startOtherServices-%E6%96%B9%E6%B3%95"><span class="nav-number">3.1.3.</span> <span class="nav-text">调用startOtherServices()方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PKMS%E6%9E%84%E9%80%A0%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">PKMS构造初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PKMS-main"><span class="nav-number">3.2.1.</span> <span class="nav-text">PKMS.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PKMS%E6%9E%84%E9%80%A0"><span class="nav-number">3.2.2.</span> <span class="nav-text">PKMS构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E4%B8%AA%E9%98%B6%E6%AE%B5"><span class="nav-number">3.2.3.</span> <span class="nav-text">五个阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%80"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">阶段一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%8C"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">阶段二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%89"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">阶段三</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E5%9B%9B"><span class="nav-number">3.2.3.4.</span> <span class="nav-text">阶段四</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%94"><span class="nav-number">3.2.3.5.</span> <span class="nav-text">阶段五</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%94%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93"><span class="nav-number">3.2.3.6.</span> <span class="nav-text">五阶段总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PKMS%E6%9E%84%E5%BB%BA%E6%88%90%E5%8A%9F%E4%B9%8B%E5%90%8E"><span class="nav-number">3.3.</span> <span class="nav-text">PKMS构建成功之后</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0%E6%80%BB%E7%BB%93"><span class="nav-number">3.4.</span> <span class="nav-text">简述总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APK%E7%9A%84%E6%89%AB%E6%8F%8F"><span class="nav-number">4.</span> <span class="nav-text">APK的扫描</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APK%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-number">5.</span> <span class="nav-text">APK的安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%89%AB%E6%8F%8F"><span class="nav-number">6.</span> <span class="nav-text">权限扫描</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小贾"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">小贾</p>
  <div class="site-description" itemprop="description">Just do IT</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiajunhui" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiajunhui" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:junhui_jia@163.com" title="E-Mail → mailto:junhui_jia@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/jiajunhui" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/08/29/android_pms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="小贾">
      <meta itemprop="description" content="Just do IT">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="奔跑的蜗牛">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android PKMS核心分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-29 21:41:00" itemprop="dateCreated datePublished" datetime="2019-08-29T21:41:00+08:00">2019-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>PackageManagerService是android系统核心服务之一，它主要负责的工作如下：<br>一.  解析AndroidManifest.xml文件，解析清单文件中的所有节点信息。<br>二.  扫描.apk文件，安装系统应用，本地应用等。<br>三.  管理本地应用，主要有：安装、卸载、应用信息查询等。</p>
<span id="more"></span>

<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Android系统启动时，会启动（应用程序管理服务器PKMS），此服务负责扫描系统中特定的目录，寻找里面的APK格式的文件，并对这些文件进行解析，然后得到应用程序相关信息，最后完成应用程序的安装</p>
<p>PKMS在安装应用过程中, 会全面解析应用程序的AndroidManifest.xml文件,  来得到Activity, Service, BroadcastReceiver, ContextProvider 等信息, 在结合PKMS服务就可以在OS中正常的使用应用程序了</p>
<p>在Android系统中, 系统启动时由SystemServer启动PKMS服务, 启动该服务后会执行应用程序的安装过程</p>
<h1 id="PKMS架构设计"><a href="#PKMS架构设计" class="headerlink" title="PKMS架构设计"></a>PKMS架构设计</h1><h2 id="类图关系"><a href="#类图关系" class="headerlink" title="类图关系"></a>类图关系</h2><p><img src="/images/android_pms_01.png" alt="image"></p>
<h2 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h2><p><img src="/images/android_pms_02.png" alt="image"></p>
<blockquote>
<p>注意：<br>客户端可通过Context.getPackageManager()获得ApplicationPackageManager对象,<br>而mPM指向的是Proxy代理，当调用到mPM.方法后，将会调用到IPackageManager的Proxy代理方法，<br>然后通过Binder机制中的mRemote与服务端PackageManagerService通信<br>并调用到PackageManagerService的方法；<br>自我总结：PKMS是属于Binder机制的服务端角色</p>
</blockquote>
<h1 id="PKMS启动过程"><a href="#PKMS启动过程" class="headerlink" title="PKMS启动过程"></a>PKMS启动过程</h1><blockquote>
<p>启动过程描述：<br>SystemServer启动PKMS：先是在SystemServer.startBootstrapServices()函数中启动PKMS服务，再调用startOtherServices()函数中对dex优化，磁盘管理功能，让PKMS进入SystemReady状态。</p>
</blockquote>
<p><img src="/images/android_pms_03.png" alt="image"></p>
<h2 id="SystemServer的启动"><a href="#SystemServer的启动" class="headerlink" title="SystemServer的启动"></a>SystemServer的启动</h2><h3 id="SystemServer七部曲"><a href="#SystemServer七部曲" class="headerlink" title="SystemServer七部曲"></a>SystemServer七部曲</h3><p><img src="/images/android_pms_04.png" alt="image"></p>
<h3 id="调用startBootstrapServices-服务"><a href="#调用startBootstrapServices-服务" class="headerlink" title="调用startBootstrapServices()服务"></a>调用startBootstrapServices()服务</h3><blockquote>
<p>SystemServer启动Boot服务</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) 启动Installer服务：mSystemServiceManager.startService(Installer.class);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">2</span>) 获取设备是否加密(手机设置密码),如果设备加密了，则只解析<span class="string">&quot;core&quot;</span>应用</span><br><span class="line">String cryptState = VoldProperties.decrypt().orElse(<span class="string">&quot;&quot;</span>); </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">3</span>) 调用PKMS.main()方法初始化PackageManagerService</span><br><span class="line">PackageManagerService.main(mSystemContext,installer,mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);       </span><br><span class="line">PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer, factoryTest, onlyCore); <span class="comment">// 构造PackageManagerService对象</span></span><br><span class="line">ServiceManager.addService(<span class="string">&quot;package&quot;</span>,m); <span class="comment">// 把实例化出来的PKMS丢给ServiceManager进行注册</span></span><br><span class="line"><span class="keyword">final</span> PackageManagerNative pmn = m.<span class="function">new <span class="title">PackageManagerNative</span><span class="params">()</span></span>; <span class="comment">// 构造PackageManagerNative对象</span></span><br><span class="line">ServiceManager.addService(<span class="string">&quot;package_native&quot;</span>, pmn); <span class="comment">// 启动package_native服务</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">4</span>) 如果设备没有加密，操作它。管理A/<span class="function">B OTA dexopting</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(!mOnlyCore)</span>  <span class="comment">// 判断是否只是核心应用</span></span></span><br></pre></td></tr></table></figure>

<p><strong>startBootstrapServices源码</strong></p>
<blockquote>
<p>SystemServer.java startBootstrapServices()<br>说明：startBootstrapServices()首先启动Installer服务，也就是安装器，随后判断当前的设备是否是出于加密状态。如果是出于加密状态则只是解析核心应用，接着调用PackageManagerService的静态方法main来创建PKMS对象。<br>(1) 启动Installer对象<br>(2) 获取设备是否加密(手机设置密码)，如果设备加密了，则只解析”core”应用。<br>(3) 调用PKMS main方法初始化PackageManagerService，其中调用PackageManagerService()构造方法创建了PKMS对象。<br>(4) 如果设备没有加密，操作它。管理A/B OTA dexopting。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// （1）启动Installer服务</span></span><br><span class="line">        <span class="comment">// 阻塞等待installed完成启动，以便有机会创建具有适当权限的关键目录，</span></span><br><span class="line">        <span class="comment">// 如/data/user。我们需要在初始化其他服务之前完成此任务。</span></span><br><span class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化AMS</span></span><br><span class="line">        mActivityManagerService = ActivityManagerService.Lifecycle.startService(</span><br><span class="line">                mSystemServiceManager, atm);</span><br><span class="line">        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">        <span class="comment">// 我们需要在初始化其他服务之前完成此任务</span></span><br><span class="line">        mActivityManagerService.setInstaller(installer);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Only run &quot;core&quot; apps if we&#x27;re encrypting the device.</span></span><br><span class="line">        <span class="comment">// (2).获取设备是否加密</span></span><br><span class="line">        <span class="comment">// 如果设备加密了，则只解析 &quot;core&quot; 应用</span></span><br><span class="line">        <span class="comment">// mOnlyCore = true，后面会频繁使用该变量进行条件判断</span></span><br><span class="line">        String cryptState = VoldProperties.decrypt().orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Detected encryption in progress - only parsing core apps&quot;</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Device encrypted - only parsing core apps&quot;</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">       </span><br><span class="line">        <span class="comment">// (3) 调用PKMS的main方法，初始化PKMS</span></span><br><span class="line">            mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">                    mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// PKMS 是否是第一次启动</span></span><br><span class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">        <span class="comment">// 通过context.getPackageManager()来获得PackageManager对象</span></span><br><span class="line">        mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// (4) 如果设备没有加密，操作它。管理A/B OTA dexopting</span></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">&quot;config.disable_otadexopt&quot;</span>,</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">                t.traceBegin(<span class="string">&quot;StartOtaDexOptService&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Watchdog.getInstance().pauseWatchingCurrentThread(<span class="string">&quot;moveab&quot;</span>);</span><br><span class="line">                    OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">&quot;starting OtaDexOptService&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Watchdog.getInstance().resumeWatchingCurrentThread(<span class="string">&quot;moveab&quot;</span>);</span><br><span class="line">                    t.traceEnd();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用startOtherServices-方法"><a href="#调用startOtherServices-方法" class="headerlink" title="调用startOtherServices()方法"></a>调用startOtherServices()方法</h3><blockquote>
<p>SystemServer启动其他服务，并使一些核心服务处于ready状态</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">5</span>) <span class="comment">// 如果设备没有加密，执行performDexoptUpgrade，完成dexopt优化</span></span><br><span class="line">mPackageManagerService.updatePackagesIfNeeded();   </span><br><span class="line">该方法，作用：检查是否需要去更新Packages并进行dex优化。</span><br><span class="line"></span><br><span class="line">条件：没有OTA升级，没有大版本升级，</span><br><span class="line">          没有清除过dalvik虚拟机的缓存，可以去更新Packages。</span><br><span class="line">更新Packages的优先级：core app &gt; system app &gt; other app,调用performDexOptUpgrade()方法进行更新</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">6</span>) mPackageManagerService.performFstrimIfNeeded(); <span class="comment">// 执行performFstrimIfNeeded(),完成磁盘维护</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">7</span>) mPackageManagerService.systemReady(mActivityManagerService.getAppOpsService());<span class="comment">// PackageManagerNative 准备就绪</span></span><br><span class="line">     DefaultPermissionPolicy.grantDefaultPermissions(userId); <span class="comment">// 启动之前授予默认所有权限</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>startOtherServices源码</strong></p>
<blockquote>
<p>[SystemServer.java] startOtherServices()<br>(5) 执行updatePackageIfNeeded，完成dex优化<br>(6) 执行performFstrimIfNeeded，完成磁盘维护<br>(7) 调用systemReady，准备就绪</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Watchdog.getInstance().pauseWatchingCurrentThread(<span class="string">&quot;dexopt&quot;</span>);</span><br><span class="line">                <span class="comment">// (5) 如果设备没有加密，执行performDexoptUpgrade，完成dexopt优化</span></span><br><span class="line">                mPackageManagerService.updatePackagesIfNeeded();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">&quot;update packages&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Watchdog.getInstance().resumeWatchingCurrentThread(<span class="string">&quot;dexopt&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// (6) 执行performFstrim，完成磁盘维护</span></span><br><span class="line">            mPackageManagerService.performFstrimIfNeeded();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;performing fstrim&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// (7) PackageManagerService准备就绪</span></span><br><span class="line">        mPackageManagerService.systemReady();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="PKMS构造初始化"><a href="#PKMS构造初始化" class="headerlink" title="PKMS构造初始化"></a>PKMS构造初始化</h2><h3 id="PKMS-main"><a href="#PKMS-main" class="headerlink" title="PKMS.main"></a>PKMS.main</h3><p>main函数主要工作：<br>(1) 检查Package编译相关系统属性<br>(2) 调用PackageManagerService构造方法<br>(3) 启用部分应用服务于多用户场景<br>(4) 往ServiceManager中注册 “package” 和 “package_native’。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">        <span class="comment">// (1) 检查Package编译相关系统属性</span></span><br><span class="line">        PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// (2) 构造PackageManagerService对象</span></span><br><span class="line">        PackageManagerService m = <span class="keyword">new</span> PackageManagerService(injector, onlyCore, factoryTest);</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 基于用户类型，为所有用户安装/卸载系统应用</span></span><br><span class="line">        m.installWhitelistedSystemPackages();</span><br><span class="line">        <span class="comment">// 向ServiceManager注册PKMS(启动package服务)</span></span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package&quot;</span>, m);</span><br><span class="line">        <span class="comment">// 构造PackageManagerNative对象</span></span><br><span class="line">        <span class="keyword">final</span> PackageManagerNative pmn = m.<span class="function">new <span class="title">PackageManagerNative</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">// 启动package_native服务</span></span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package_native&quot;</span>, pmn);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">创建PackageManagerService并向ServiceManager注册</span><br><span class="line">创建PackageManagerNative并向ServiceManager注册</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="PKMS构造"><a href="#PKMS构造" class="headerlink" title="PKMS构造"></a>PKMS构造</h3><blockquote>
<p>PKMS 初始化时的核心部分为PackageManagerService的构造函数的内容，现在我们来看一下该函数。</p>
</blockquote>
<p>此函数由两个重要的锁（mInstallLock和mLock）和五个阶段构成。在Android 11.0源码中是由(mInstallLock和mPackages)两个锁</p>
<p>mInstallLock、mLock：用来保护所有安装apk的访问权限，此操作通常涉及繁重的磁盘数据读写等操作。并且是单线程操作，所以有时候会处理很慢。此锁不会在已经持有了mLock锁的情况下加锁，反之，在已经持有mInstallLock锁的情况下，立即获得mLock是安全的。</p>
<p>mPackages（mLock）：用来解析内存中所有apk的package信息及相关状态。</p>
<p>PKMS服务也是通过Binder进行通信，IPackageManager.aidl由工具转换后自动生成Binder的服务端IPackageManager.Stub和客户端IPackageManager.Stub.Proxy。</p>
<p>Binder服务端：PackageManagerService继承自IPackageManager.Stub</p>
<p>Binder客户端：ApplicationPackageManager(简称APM)的成员变量mPm继承于IPackageManager.Stub.Proxy。本身APM继承与PackageManager对象。</p>
<h3 id="五个阶段"><a href="#五个阶段" class="headerlink" title="五个阶段"></a>五个阶段</h3><p><img src="/images/android_pms_05.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">5个阶段构成，下面会详细的来分析这些内容。</span><br><span class="line">    阶段1：BOOT_PROGRESS_PMS_START  开始阶段</span><br><span class="line">    阶段2：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 系统扫描阶段</span><br><span class="line">    阶段3：BOOT_PROGRESS_PMS_DATA_SCAN_START Data扫描阶段</span><br><span class="line">    阶段4：BOOT_PROGRESS_PMS_SCAN_END 扫描结束</span><br><span class="line">    阶段5：BOOT_PROGRESS_PMS_READY 就绪阶段</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>阶段1，阶段2，阶段3，阶段4，阶段5 的 EventLog</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public PackageManagerService(Context context, Installer installer,</span><br><span class="line">        boolean factoryTest, boolean onlyCore) &#123;</span><br><span class="line">        ...</span><br><span class="line">        // 阶段1：BOOT_PROGRESS_PMS_START</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line"> </span><br><span class="line">        // 阶段2：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">                    startTime);</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        // 阶段3：BOOT_PROGRESS_PMS_DATA_SCAN_STAR</span><br><span class="line">        if (!mOnlyCore) &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        // 阶段4：BOOT_PROGRESS_PMS_SCAN_END</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">        ...</span><br><span class="line">        // 阶段5：BOOT_PROGRESS_PMS_READY</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="阶段一"><a href="#阶段一" class="headerlink" title="阶段一"></a>阶段一</h4><blockquote>
<p>BOOT_PROGRESS_PMS_START 开始阶段</p>
</blockquote>
<p>主要工作：<br>(1) 构造 DisplayMetrics，保存分辨率相关信息。<br>(2) 创建Installer对象，与installd交互<br>(3) 创建mPermissionManager对象，进行权限管理<br>(4) 构造Settings类，保存安装包信息，清除路径不存在的孤立应用，主要涉及/data/system/目录的packages.xml,<br>     packages-backup.xml,packages.list,packages-stopped.xml,packages-stopped-backup.xml等文件。<br>(5) 构造PackageDexOptimizer及DexManager类，处理dex优化；<br>(6) 创建SystemConfig实例，获取系统配置信息，配置共享lib库；<br>(7) 创建PackageManager的Handler线程，循环处理外部安装相关消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Injector injector, <span class="keyword">boolean</span> onlyCore, <span class="keyword">boolean</span> factoryTest)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 第一阶段</span></span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line">        <span class="comment">// mSdkVersion是编译的SDK版本</span></span><br><span class="line">        <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;**** ro.build.version.sdk not set!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        mFactoryTest = factoryTest;    <span class="comment">// 假设为false，即运行在非工厂模式下</span></span><br><span class="line">        mOnlyCore = onlyCore;<span class="comment">// 假设为false，即运行在普通模式下。标记是否只加载核心服务</span></span><br><span class="line">        <span class="comment">// (1) mMetrics用于存储与显示屏相关的一些属性，例如屏幕的宽高尺寸、分辨率等信息</span></span><br><span class="line">        mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">        <span class="comment">// (2) 构建Installer对象，与installed交互</span></span><br><span class="line">        mInstaller = injector.getInstaller();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 本地服务</span></span><br><span class="line">        LocalServices.addService(PackageManagerInternal.class, mPmInternal);</span><br><span class="line">        <span class="comment">// 构建多用户管理服务</span></span><br><span class="line">        mUserManager = injector.getUserManagerService();</span><br><span class="line">        mComponentResolver = injector.getComponentResolver();</span><br><span class="line">        <span class="comment">// (3) 构建权限管理服务</span></span><br><span class="line">        mPermissionManager = injector.getPermissionManagerServiceInternal();</span><br><span class="line">        <span class="comment">// 创建Settings对象，Settings是一个非常重要的类，用于存储系统运行过程中的一些设置</span></span><br><span class="line">        mSettings = injector.getSettings();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// (4)构造Settings类，保存安装包信息，清除路径不存在的孤立应用，主要涉</span></span><br><span class="line">        <span class="comment">// 及/data/system/目录的packages.xml，packages-backup.xml， packages.list，</span></span><br><span class="line">        <span class="comment">// packages-stopped.xml，packages-stopped-backup.xml等文件。</span></span><br><span class="line">        <span class="comment">// 添加system，phone，log，nfc，bluetooth，shell，se，networkstack这八种shareUserId到settings对象中</span></span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.system&quot;</span>, Process.SYSTEM_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.phone&quot;</span>, RADIO_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.log&quot;</span>, LOG_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.nfc&quot;</span>, NFC_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.bluetooth&quot;</span>, BLUETOOTH_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.shell&quot;</span>, SHELL_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.se&quot;</span>, SE_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.networkstack&quot;</span>, NETWORKSTACK_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// (5)构造PackageDexOptimizer及DexManager类，处理dex优化</span></span><br><span class="line">        mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(mInstaller, mInstallLock, mContext,</span><br><span class="line">                <span class="string">&quot;*dexopt*&quot;</span>);</span><br><span class="line">        mDexManager =</span><br><span class="line">                <span class="keyword">new</span> DexManager(mContext, <span class="keyword">this</span>, mPackageDexOptimizer, mInstaller, mInstallLock);</span><br><span class="line">        <span class="comment">// 创建ATR虚拟机管理服务</span></span><br><span class="line">        mArtManagerService = <span class="keyword">new</span> ArtManagerService(mContext, <span class="keyword">this</span>, mInstaller, mInstallLock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取默认分辨率</span></span><br><span class="line">        getDefaultDisplayMetrics(mInjector.getDisplayManager(), mMetrics);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// (6)创建SystemConfig实例，获取系统配置信息，配置共享lib库；</span></span><br><span class="line">        <span class="comment">//拿到SystemConfig()的对象，其中会调用SystemConfig的readPermissions()完成权限的读取</span></span><br><span class="line">        SystemConfig systemConfig = SystemConfig.getInstance();        </span><br><span class="line">        <span class="comment">// CHECKSTYLE:OFF IndentationCheck</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//(7)创建PackageManager的handler线程，循环处理外部安装相关消息</span></span><br><span class="line">            <span class="comment">//启动PackageManager线程，负责apk的安装、卸载</span></span><br><span class="line">            mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">                    Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">            mHandlerThread.start();</span><br><span class="line">            <span class="comment">// 应用Handler</span></span><br><span class="line">            mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">            <span class="comment">// 进程记录handler</span></span><br><span class="line">            mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">            <span class="comment">// WatchDog监听ServiceThread是否超时：10分钟</span></span><br><span class="line">            Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line">            <span class="comment">// Instant应用注册</span></span><br><span class="line">            mInstantAppRegistry = <span class="keyword">new</span> InstantAppRegistry(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 共享lib库配置</span></span><br><span class="line">            ArrayMap&lt;String, SystemConfig.SharedLibraryEntry&gt; libConfig</span><br><span class="line">                    = systemConfig.getSharedLibraries();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> builtInLibCount = libConfig.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; builtInLibCount; i++) &#123;</span><br><span class="line">                String name = libConfig.keyAt(i);</span><br><span class="line">                SystemConfig.SharedLibraryEntry entry = libConfig.valueAt(i);</span><br><span class="line">                addBuiltInSharedLibraryLocked(entry.filename, name);</span><br><span class="line">            &#125;         </span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 读取安装SELinux相关策略</span></span><br><span class="line">            SELinuxMMAC.readInstallPolicy();</span><br><span class="line">            <span class="comment">// 返回栈加载</span></span><br><span class="line">            FallbackCategoryProvider.loadFallbacks();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 这句很重要，解析系统配置文件package.xml</span></span><br><span class="line">            <span class="comment">// 读取并解析/data/system下的XML文件</span></span><br><span class="line">            mFirstBoot = !mSettings.readLPw(mInjector.getUserManagerInternal().getUsers(<span class="keyword">false</span>));</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Clean up orphaned packages for which the code path doesn&#x27;t exist</span></span><br><span class="line">            <span class="comment">// and they are an update to a system app - caused by bug/32321269</span></span><br><span class="line">            <span class="comment">// 清理代码路径不存在的孤立软件包</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                        &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSettings.mPackages.removeAt(i);</span><br><span class="line">                    mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果不是首次启动，也不是CORE应用，则拷贝预编译的DEX文件</span></span><br><span class="line">            <span class="keyword">if</span> (!mOnlyCore &amp;&amp; mFirstBoot) &#123;</span><br><span class="line">                requestCopyPreoptedFiles();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line"> </span><br><span class="line">         &#125;    <span class="comment">// synchronized (mPackages) </span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这里主要是对一些属性和子服务进行了创建或赋值，其中比较重要的有mInstaller、mSettings、mPackageDexOptimizer等。</span><br><span class="line">在之前的有些版本，mSettings等有些属性是在这里直接new的，而现在采用传入Injector的方式来获取。另外、这里还开启了工作线程。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>readLPw()会扫描下面5个文件</p>
<ol>
<li>“/data/system/packages.xml”                                       // 所有安装app信息</li>
<li>“/data/system/packages-backup.xml”                          // 所有安装app信息的备份的信息记录</li>
<li>“/data/system/packages.list”                                        // 所有安装app信息</li>
<li>“/data/system/packages-stopped.xml”                        // 所有强制停止app信息 </li>
<li>“/data/system/packages-stopped-backup.xml”           // 所以强制停止app信息的备份的信息记录</li>
</ol>
<p>5个文件共分为三组，简单的作用描述如下：</p>
<ol>
<li>packages.xml: PKMS扫描完成目标文件夹之后会创建该文件。当系统进行程序安装、卸载和更新等操作时，均会更新该文件。该文件保存了系统中与 package相关的一些信息。</li>
<li>packages.list: 描述系统中存在的所有非系统自带的apk的信息。当这些程序有变动时 PKMS 就会更新该文件。</li>
<li>packages-stopped.xml : 从系统自带的设置程序中进入应用程序页面，然后再选择强制停止(ForceStop) 某个应用时，系统会将该应用的相关信息记录到此文件中。也就是该文件保存系统中被用户强制停止的 package 的信息。</li>
</ol>
<p>这些目录的指向，都在settings中的构造函数中完成，如下所示，得到目录后调用readLpw()进行扫描。</p>
<p>看一下settings的构造函数（package com.android.server.pm）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Settins类的几个重要属性</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mSettingsFilename;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mBackupSettingsFilename;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mPackageListFilename;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mStoppedPackagesFilename;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mBackupStoppedPackagesFilename;</span><br><span class="line"><span class="comment">/** The top level directory in configfs for sdcardfs to push the package-&gt;uid,userId mappings */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File mKernelMappingFilename;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 已经安装的App的信息 */</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, PackageSetting&gt; mPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Settings的构造方法</span></span><br><span class="line">Settings(File dataDir, PermissionSettings permission,</span><br><span class="line">            Object lock) &#123;</span><br><span class="line">        mLock = lock;</span><br><span class="line">        mPermissions = permission;</span><br><span class="line">        mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line"> </span><br><span class="line">        mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">&quot;system&quot;</span>);                <span class="comment">//mSystemDir指向目录&quot;/data/system&quot;</span></span><br><span class="line">        mSystemDir.mkdirs();        <span class="comment">//创建 &quot;/data/system&quot;</span></span><br><span class="line">        <span class="comment">// 设置权限</span></span><br><span class="line">        FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">                FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">                |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//(1)指向目录&quot;/data/system/packages.xml&quot;</span></span><br><span class="line">        mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">&quot;packages.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//(2)指向目录&quot;/data/system/packages-backup.xml&quot;</span></span><br><span class="line">        mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">&quot;packages-backup.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//(3)指向目录&quot;/data/system/packages.list&quot;</span></span><br><span class="line">        mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">&quot;packages.list&quot;</span>);</span><br><span class="line">        FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">&quot;/config/sdcardfs&quot;</span>);</span><br><span class="line">        mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Deprecated: Needed for migration</span></span><br><span class="line">        <span class="comment">//(4)指向目录&quot;/data/system/packages-stopped.xml&quot;</span></span><br><span class="line">        mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">&quot;packages-stopped.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//(5)指向目录&quot;/data/system/packages-stopped-backup.xml&quot;</span></span><br><span class="line">        mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">&quot;packages-stopped-backup.xml&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解析上面这几个xml的内容，建立对应的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Setting.<span class="function">java</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">readLPw</span><span class="params">(<span class="meta">@NonNull</span> List&lt;UserInfo&gt; users)</span> </span>&#123;</span><br><span class="line">        FileInputStream str = <span class="keyword">null</span>;   </span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">           str = <span class="keyword">new</span> FileInputStream(mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 &quot;/data/system/packages.xml</span></span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, StandardCharsets.UTF_8.name());</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">&quot;No start tag found in settings file\n&quot;</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                   <span class="string">&quot;No start tag found in package manager settings&quot;</span>);</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                    <span class="string">&quot;No start tag found in package manager settings&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">           <span class="comment">// 解析xml</span></span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                    &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据xml的各个节点进行各种操作，例如读取权限、shared-user等</span></span><br><span class="line">                String tagName = parser.getName();</span><br><span class="line">                <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;package&quot;</span>)) &#123;</span><br><span class="line">                    readPackageLPw(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;permissions&quot;</span>)) &#123;</span><br><span class="line">                    mPermissions.readPermissions(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;permission-trees&quot;</span>)) &#123;</span><br><span class="line">                    mPermissions.readPermissionTrees(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;shared-user&quot;</span>)) &#123;</span><br><span class="line">                    readSharedUserLPw(parser);</span><br><span class="line">                &#125; .....</span><br><span class="line"> </span><br><span class="line">            str.close();       </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting p = mPendingPackages.get(i);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sharedUserId = p.getSharedUserId();</span><br><span class="line">            <span class="keyword">final</span> Object idObj = getSettingLPr(sharedUserId);</span><br><span class="line">            <span class="keyword">if</span> (idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123;</span><br><span class="line">                <span class="comment">// 创建SharedUserSetting对象并添加到Settings的成员变量mSharedUsers中，</span></span><br><span class="line">                <span class="comment">// 在Android系统中，多个Package通过设置SharedUserId属性可以运行在同一个进程，共享同一个UID</span></span><br><span class="line">                <span class="keyword">final</span> SharedUserSetting sharedUser = (SharedUserSetting) idObj;</span><br><span class="line">                p.sharedUser = sharedUser;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line">                addPackageSettingLPw(p, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明：创建 SharedUserSetting 对象并添加到 Settings 的成员变量 mSharedUsers 中，在 Android 系统中，<br>多个 package 通过设置 sharedUserId 属性可以运行在同一个进程，共享同一个 UID。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.system&quot;</span>, <span class="comment">// 字符串</span></span><br><span class="line">                            Process.SYSTEM_UID, <span class="comment">//系统进程使用的用户id，值为1000</span></span><br><span class="line">                            ApplicationInfo.FLAG_SYSTEM, <span class="comment">//标志系统 Package</span></span><br><span class="line">                            ApplicationInfo.PRIVATE_FLAG_PRIVILEGED); <span class="comment">//特权系统应用  </span></span><br><span class="line"> </span><br><span class="line"> <span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// mSharedUsers是一个HashMap，key是字符串，值为 SharedUserSetting对象</span></span><br><span class="line">        SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">                <span class="keyword">return</span> s;</span><br><span class="line">            &#125;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">&quot;Adding duplicate shared user, keeping first: &quot;</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个 SharedUserSetting对象，并设置userId为UID</span></span><br><span class="line">        s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">        s.userId = uid;</span><br><span class="line">        <span class="keyword">if</span> (registerExistingAppIdLPw(uid, s, name)) &#123;</span><br><span class="line">            mSharedUsers.put(name, s);<span class="comment">// 将name与键值对添加到mSharedUsers中保存</span></span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">初始化PMS的各个子组件/子服务以及相关属性</span><br><span class="line">解析package.xml，获取已经安装的App信息，存储到Settings的mPackages中</span><br><span class="line">创建了后台工作线程及其Handler</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="阶段二"><a href="#阶段二" class="headerlink" title="阶段二"></a>阶段二</h4><blockquote>
<p>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 系统扫描阶段</p>
</blockquote>
<p>主要工作：<br>(1) 从init.rc中获取环境变量BOOTCLASSPATH和SYSTEMSERVERCLASSPATH；<br>(2) 对于旧版本升级的情况，将安装时获取权限变更为运行时申请权限；<br>(3) 扫描system/vendor/product/odm/oem等目录的priv-app、app、overlay包；<br>(4) 清除安装时临时文件以及其他不必要的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">           <span class="comment">// 记录扫描开始时间</span></span><br><span class="line">           <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"> </span><br><span class="line">           <span class="comment">// 第二阶段</span></span><br><span class="line">           EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">                    startTime);</span><br><span class="line">            <span class="comment">// 获取环境变量，init.rc</span></span><br><span class="line">            <span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">&quot;BOOTCLASSPATH&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取system/frameworks目录</span></span><br><span class="line">            File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">&quot;framework&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取内部版本</span></span><br><span class="line">            <span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line">            <span class="comment">// 判断fingerprint是否更新</span></span><br><span class="line">            mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);           </span><br><span class="line">            <span class="comment">// 对于Android M之前版本升级上来的情况，需要将系统应用程序权限从安装升级到运行时</span></span><br><span class="line">            mPromoteSystemApps =</span><br><span class="line">                    mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 对于Android N之前版本升级上来的情况，需要像首次启动一样处理package</span></span><br><span class="line">            mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"> </span><br><span class="line">            mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line">            mIsPreQUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.Q;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 在扫描之前保存预先存在的系统Package的名称，这样我们可以确定哪些系统包在升级后是全新的。</span></span><br><span class="line">            <span class="keyword">if</span> (isDeviceUpgrading()) &#123;</span><br><span class="line">                mExistingPackages = <span class="keyword">new</span> ArraySet&lt;&gt;(mSettings.mPackages.size());</span><br><span class="line">                <span class="keyword">for</span> (PackageSetting ps : mSettings.mPackages.values()) &#123;</span><br><span class="line">                    mExistingPackages.add(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 准备解析Package的缓存</span></span><br><span class="line">            mCacheDir = preparePackageParserCache();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line">            <span class="comment">// scanning install directories.</span></span><br><span class="line">            <span class="comment">// 设置Flag，而不在扫描安装时更改文件路径</span></span><br><span class="line">            <span class="keyword">int</span> scanFlags = SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 在Android 11.0 中，此处会扫描以下路径</span></span><br><span class="line">            <span class="comment">//扫描以下路径：/vendor/overlay、/product/overlay、/product_services/overlay、                  </span></span><br><span class="line">            <span class="comment">// /odm/overlay、/oem/overlay、/system/framework、/system/priv-app、</span></span><br><span class="line">            <span class="comment">// /system/app、/vendor/priv-app、/vendor/app、/odm/priv-app、/odm/app、</span></span><br><span class="line">            <span class="comment">// /oem/app、/oem/priv-app、/product/priv-app、/product/app、</span></span><br><span class="line">            <span class="comment">// /product_services/priv-app、/product_services/app、</span></span><br><span class="line">            <span class="comment">// /product_services/priv-app</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = mDirsToScanAsSystem.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> ScanPartition partition = mDirsToScanAsSystem.get(i);</span><br><span class="line">                <span class="keyword">if</span> (partition.getOverlayFolder() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 扫描overlay包</span></span><br><span class="line">                scanDirTracedLI(partition.getOverlayFolder(), systemParseFlags,</span><br><span class="line">                        systemScanFlags | partition.scanFlag, <span class="number">0</span>,</span><br><span class="line">                        packageParser, executorService);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            scanDirTracedLI(frameworkDir, systemParseFlags,</span><br><span class="line">                    systemScanFlags | SCAN_NO_DEX | SCAN_AS_PRIVILEGED, <span class="number">0</span>,</span><br><span class="line">                    packageParser, executorService);</span><br><span class="line">            <span class="keyword">if</span> (!mPackages.containsKey(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">&quot;Failed to load frameworks package; check log for warnings&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = mDirsToScanAsSystem.size(); i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ScanPartition partition = mDirsToScanAsSystem.get(i);</span><br><span class="line">                <span class="keyword">if</span> (partition.getPrivAppFolder() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 扫描priv-app路径</span></span><br><span class="line">                    scanDirTracedLI(partition.getPrivAppFolder(), systemParseFlags,</span><br><span class="line">                            systemScanFlags | SCAN_AS_PRIVILEGED | partition.scanFlag, <span class="number">0</span>,</span><br><span class="line">                            packageParser, executorService);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 扫描app路径</span></span><br><span class="line">                scanDirTracedLI(partition.getAppFolder(), systemParseFlags,</span><br><span class="line">                        systemScanFlags | partition.scanFlag, <span class="number">0</span>,</span><br><span class="line">                        packageParser, executorService);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 删掉不存在的package</span></span><br><span class="line">            <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                <span class="comment">// do this first before mucking with mPackages for the &quot;expecting better&quot; case</span></span><br><span class="line">                <span class="keyword">final</span> Iterator&lt;AndroidPackage&gt; pkgIterator = mPackages.values().iterator();</span><br><span class="line">                <span class="comment">// 这里把mSettings.mPackages（也就是packages.xml文件中读取的记录）和mPackages（实时扫描得到的记录）做比较，看看有哪些变化 </span></span><br><span class="line">                 <span class="comment">// 有变化的情况往往是OTA升级</span></span><br><span class="line">                <span class="keyword">while</span> (pkgIterator.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> AndroidPackage pkg = pkgIterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (pkg.isStub()) &#123;</span><br><span class="line">                        stubSystemApps.add(pkg.getPackageName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">final</span> Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">                <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">                    PackageSetting ps = psit.next();</span><br><span class="line">                    <span class="comment">// 非系统App跳过</span></span><br><span class="line">                    <span class="comment">// 如果不是系统应用，则不被允许禁用其他应用</span></span><br><span class="line">                    <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果应用被扫描，则不允许被擦除</span></span><br><span class="line">                    <span class="keyword">final</span> AndroidPackage scannedPkg = mPackages.get(ps.name);</span><br><span class="line">                    <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       </span><br><span class="line">                        <span class="comment">// 如果系统应用被扫描，且存在于disable应用列表中，那它一定是通过OTA添加的</span></span><br><span class="line">                        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                            logCriticalInfo(Log.WARN,</span><br><span class="line">                                    <span class="string">&quot;Expecting better updated system app for &quot;</span> + ps.name</span><br><span class="line">                                    + <span class="string">&quot;; removing system app.  Last known&quot;</span></span><br><span class="line">                                    + <span class="string">&quot; codePath=&quot;</span> + ps.codePathString</span><br><span class="line">                                    + <span class="string">&quot;, versionCode=&quot;</span> + ps.versionCode</span><br><span class="line">                                    + <span class="string">&quot;; scanned versionCode=&quot;</span> + scannedPkg.getLongVersionCode());</span><br><span class="line">                            removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                            mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 删除没有关联应用的共享UID标识</span></span><br><span class="line">            mSettings.pruneSharedUsersLPw();</span><br><span class="line">            </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析上面调用的 scanDirTracedLI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirTracedLI</span><span class="params">(File scanDir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">long</span> currentTime, PackageParser2 packageParser, ExecutorService executorService)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;scanDir [&quot;</span> + scanDir.getAbsolutePath() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这个方法几乎没有做其他的事情，除了日志，就是直接调用scanDirLI</span></span><br><span class="line">        scanDirLI(scanDir, parseFlags, scanFlags, currentTime, packageParser, executorService);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File scanDir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime,</span></span></span><br><span class="line"><span class="params"><span class="function">        PackageParser2 packageParser, ExecutorService executorService)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File[] files = scanDir.listFiles();</span><br><span class="line">    <span class="comment">// 空文件夹直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;No files in app dir &quot;</span> + scanDir);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Scanning app dir &quot;</span> + scanDir + <span class="string">&quot; scanFlags=&quot;</span> + scanFlags</span><br><span class="line">                + <span class="string">&quot; flags=0x&quot;</span> + Integer.toHexString(parseFlags));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把传进来的PackageParser2对象和线程池封装成ParallelPackageParser对象</span></span><br><span class="line">    ParallelPackageParser parallelPackageParser =</span><br><span class="line">            <span class="keyword">new</span> ParallelPackageParser(packageParser, executorService);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fileCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">        <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">            <span class="comment">// Ignore entries which are not packages</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析包的关键代码</span></span><br><span class="line">        parallelPackageParser.submit(file, parseFlags);</span><br><span class="line">        fileCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析完成之后，取出结果挨个处理</span></span><br><span class="line">    <span class="keyword">for</span> (; fileCount &gt; <span class="number">0</span>; fileCount--) &#123;</span><br><span class="line">        ParallelPackageParser.ParseResult parseResult = parallelPackageParser.take();</span><br><span class="line">        Throwable throwable = parseResult.throwable;</span><br><span class="line">        <span class="keyword">int</span> errorCode = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// TODO(toddke): move lower in the scan chain</span></span><br><span class="line">            <span class="comment">// Static shared libraries have synthetic package names</span></span><br><span class="line">            <span class="keyword">if</span> (parseResult.parsedPackage.isStaticSharedLibrary()) &#123;</span><br><span class="line">                renameStaticSharedLibraryPackage(parseResult.parsedPackage);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//  addForInitLI --&gt; commitReconciledScanResultLocked --&gt; commitPackageSettings --&gt; </span></span><br><span class="line">               <span class="comment">// 更新mSettings中相关包的数据</span></span><br><span class="line">                <span class="comment">// 把包的信息存储到mPackages里面</span></span><br><span class="line">                addForInitLI(parseResult.parsedPackage, parseFlags, scanFlags,</span><br><span class="line">                        currentTime, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除无效的用户App</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_AS_SYSTEM) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; errorCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            logCriticalInfo(Log.WARN,</span><br><span class="line">                    <span class="string">&quot;Deleting invalid package at &quot;</span> + parseResult.scanFile);</span><br><span class="line">            removeCodePathLI(parseResult.scanFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上函数的【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通过ParallelPackageParser解析扫描目录下的包</span><br><span class="line">取出解析结果，执行addForInitLI</span><br><span class="line">删除无效的用户App</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">扫描各个系统分区的的App</span><br><span class="line">解析系统App信息</span><br><span class="line">把解析结果存储起来，存储在PMS的相关属性和mSettings里</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="阶段三"><a href="#阶段三" class="headerlink" title="阶段三"></a>阶段三</h4><blockquote>
<p>BOOT_PROGRESS_PMS_DATA_SCAN_START Data扫描阶段<br>扫描/data/app下的App，也就是用户安装的App</p>
</blockquote>
<p>主要工作<br>对于不仅仅解析核心应用的情况下，还处理data目录的应用信息，及时更新，去除不必要的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">PackageManagerService.packageManagerService()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">// 第三阶段</span></span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                        SystemClock.uptimeMillis());         </span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 扫描用户安装的App，/data/app目录</span></span><br><span class="line">    scanDirTracedLI(sAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>,</span><br><span class="line">            packageParser, executorService);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 移除通过OTA删除的更新系统应用程序的禁用package设置</span></span><br><span class="line">    <span class="comment">// 如果更新不存在，则完全删除该应用。否则，撤销其系统权限</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = possiblyDeletedUpdatedSystemApps.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">         <span class="keyword">final</span> String packageName = possiblyDeletedUpdatedSystemApps.get(i);</span><br><span class="line">         <span class="keyword">final</span> AndroidPackage pkg = mPackages.get(packageName);</span><br><span class="line">         <span class="keyword">final</span> String msg;</span><br><span class="line"> </span><br><span class="line">         mSettings.removeDisabledSystemPackageLPw(packageName);</span><br><span class="line">        </span><br><span class="line">         .....</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line">                </span><br><span class="line">     <span class="comment">// 确保期望在userdata分区上显示的所有系统应用程序实际显示了。</span></span><br><span class="line">     <span class="comment">// 如果从未出现过，需要回滚以恢复系统版本</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">         <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">         <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">                        </span><br><span class="line">             mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"> </span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 扫描APK</span></span><br><span class="line">                  scanPackageTracedLI(scanFile, reparseFlags, rescanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">             &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                  Slog.e(TAG, <span class="string">&quot;Failed to parse original system package: &quot;</span></span><br><span class="line">                                    + e.getMessage());</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 解压缩并安装任何存根系统应用程序。必须最后执行此操作以确保禁用或替换所有存根</span></span><br><span class="line">      installSystemStubPackages(stubSystemApps, scanFlags);</span><br><span class="line">                </span><br><span class="line">      ......</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Resolve the storage manager.</span></span><br><span class="line">      <span class="comment">// 获取Storage manager包名</span></span><br><span class="line">      mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line">            </span><br><span class="line">      <span class="comment">// 解决受保护的action过滤器。只允许setup wizard(开机向导)为这些action设置高优先级过滤器</span></span><br><span class="line">      mSetupWizardPackage = getSetupWizardPackageNameImpl();</span><br><span class="line">            </span><br><span class="line">      <span class="comment">// 更新客户端，以确保持有正确的共享库路径</span></span><br><span class="line">      updateAllSharedLibrariesLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, Collections.unmodifiableMap(mPackages));</span><br><span class="line"> </span><br><span class="line">      ......</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 读取并更新要保留的package的上次使用时间</span></span><br><span class="line">      mPackageUsage.read(mSettings.mPackages);</span><br><span class="line">      mCompilerStats.read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这里就是对/data/app进行了扫描，主要工作与扫描系统App目录是一样的，只是细节处理上有些不同。初次之外还做了一些扫尾工作</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="阶段四"><a href="#阶段四" class="headerlink" title="阶段四"></a>阶段四</h4><blockquote>
<p>BOOT_PROGRESS_PMS_SCAN_END  扫描结束</p>
</blockquote>
<p>主要工作：<br>(1) sdk版本变更，更新权限；<br>(2) OTA升级后首次启动，清除不必要的缓存数据；<br>(3) 权限等默认项更新完后，清理相关数据；<br>(4) 更新package.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">PackageManagerService.packageManager()</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 第四阶段</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,SystemClock.uptimeMillis());</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 如果SDK版本发生了变化（升级系统），重新对App进行授权</span></span><br><span class="line"><span class="comment">// 如果自上次启动以来，平台SDK已改变，则需要重新授予应用程序权限以捕获出现的任何新权限</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> sdkUpdated = (ver.sdkVersion != mSdkVersion);</span><br><span class="line"><span class="keyword">if</span> (sdkUpdated) &#123;</span><br><span class="line">   </span><br><span class="line">     mPermissionManager.updateAllPermissions(StorageManager.UUID_PRIVATE_INTERNAL, sdkUpdated);</span><br><span class="line">     ver.sdkVersion = mSdkVersion;</span><br><span class="line">            </span><br><span class="line">      <span class="comment">// 如果是首次启动或者从6.0以前的系统升级，初始化用户首选App</span></span><br><span class="line">     <span class="comment">// 如果这是第一次启动或这是来自Android M之前的版本升级，并且它是正常启动，</span></span><br><span class="line">     <span class="comment">// 那需要在所有已定义的用户初始化默认的首选应用程序</span></span><br><span class="line">     <span class="keyword">if</span> (!mOnlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">          <span class="keyword">for</span> (UserInfo user : mInjector.getUserManagerInternal().getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                mSettings.applyDefaultPreferredAppsLPw(user.id);</span><br><span class="line">                primeDomainVerificationsLPw(user.id);</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 为系统用户准备存储空间，因为SettingsProvider和SystemUI等核心系统App不可能等用户去启动</span></span><br><span class="line">     <span class="comment">// 在启动期间尽早为系统用户准备存储，因为像SettingsProvider和systemUI这样的核心系统应用程序无法等待用户启动</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line">     <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">          storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 如果是升级后第一次正常启动，需要清除代码缓存，但不是会清除应用的配置文件</span></span><br><span class="line">     <span class="comment">// 如果是在OTA之后首次启动，并且正常启动，那需要清除代码缓存目录，但不清除应用程序配置文件</span></span><br><span class="line">     <span class="keyword">if</span> (mIsUpgrade &amp;&amp; !mOnlyCore) &#123;</span><br><span class="line">         Slog.i(TAG, <span class="string">&quot;Build fingerprint changed; clearing code caches&quot;</span>);</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">              <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">              <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">                  <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">                  clearAppDataLIF(ps.pkg, UserHandle.USER_ALL, FLAG_STORAGE_DE | FLAG_STORAGE_CE | FLAG_STORAGE_EXTERNAL | Installer.FLAG_CLEAR_CODE_CACHE_ONLY</span><br><span class="line">| Installer.FLAG_CLEAR_APP_DATA_KEEP_ART_PROFILES);</span><br><span class="line">              &#125;</span><br><span class="line">         &#125;</span><br><span class="line">              ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 安装Android-Q前的非系统应用程序在Luncher中隐藏他们的图标</span></span><br><span class="line">     <span class="keyword">if</span> (!mOnlyCore &amp;&amp; mIsPreQUpgrade) &#123;</span><br><span class="line">         Slog.i(TAG, <span class="string">&quot;Whitelisting all existing apps to hide their icons&quot;</span>);</span><br><span class="line">         <span class="keyword">int</span> size = mSettings.mPackages.size();</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">              <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">              <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line">                    </span><br><span class="line">              ps.disableComponentLPw(PackageManager.APP_DETAILS_ACTIVITY_CLASS_NAME,</span><br><span class="line">                     UserHandle.USER_SYSTEM);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 仅在权限或其他默认配置更新后清除</span></span><br><span class="line">     mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">     <span class="comment">// 所有变化都在扫描过程中完成</span></span><br><span class="line">     ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">// 把更新后的mSettings中更新后的相关信息写入packages.xml等对应文件中 </span></span><br><span class="line">    mSettings.writeLPr();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果SDK版本发生了变化（升级系统），重新对App进行授权</span><br><span class="line">为系统核心服务准备存储空间</span><br><span class="line">如果是升级后第一次正常启动，需要清除代码缓存，但不是会清除应用的配置文件</span><br><span class="line">把更新后的信息写回对应的xml文件中</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="阶段五"><a href="#阶段五" class="headerlink" title="阶段五"></a>阶段五</h4><blockquote>
<p>BOOT_PROGRESS_PMS_READY 就绪阶段</p>
</blockquote>
<p>主要工作：<br>(1)创建PackageInstallerService对象<br>(2)GC回收内存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第五阶段</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">         SystemClock.uptimeMillis());</span><br><span class="line"> </span><br><span class="line"><span class="comment">// PermissionController 包含磨人的授予和角色管理，所以它是一个核心系统的关键部分</span></span><br><span class="line">mRequiredPermissionControllerPackage = getRequiredPermissionControllerLPr();</span><br><span class="line">            </span><br><span class="line">.......</span><br><span class="line"> </span><br><span class="line">updateInstantAppInstallerLocked(<span class="keyword">null</span>);</span><br><span class="line">           </span><br><span class="line"><span class="comment">// 阅读并更新dex文件的用法</span></span><br><span class="line"><span class="comment">// 在 PM init结束时执行此操作，以便所有程序包都已协调其数据目录</span></span><br><span class="line"><span class="comment">// 此时知道了包的代码路径，因此可以验证磁盘文件并构建内部缓存</span></span><br><span class="line"><span class="comment">// 使用文件预计很小，因为与其他活动(例如包扫描)相比，加载和验证它应该花费相当小的时间</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;Integer, List&lt;PackageInfo&gt;&gt; userPackages = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> userId : userIds) &#123;</span><br><span class="line">     userPackages.put(userId, getInstalledPackages(<span class="comment">/*flags*/</span> <span class="number">0</span>, userId).getList());</span><br><span class="line">&#125;</span><br><span class="line">mDexManager.load(userPackages);</span><br><span class="line"><span class="keyword">if</span> (mIsUpgrade) &#123;</span><br><span class="line">    FrameworkStatsLog.write(</span><br><span class="line">    FrameworkStatsLog.BOOT_TIME_EVENT_DURATION_REPORTED,</span><br><span class="line">                 BOOT_TIME_EVENT_DURATION__EVENT__OTA_PACKAGE_MANAGER_INIT_TIME,</span><br><span class="line">                 SystemClock.uptimeMillis() - startTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// synchronized (mLock)</span></span><br><span class="line">&#125; <span class="comment">// synchronized (mInstallLock)</span></span><br><span class="line">        </span><br><span class="line">......        </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 打开应用之后，及时的回收处理</span></span><br><span class="line">Runtime.getRuntime().gc();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对一些属性进行了赋值，最重要的是初始化PackageInstallerService。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="五阶段总结"><a href="#五阶段总结" class="headerlink" title="五阶段总结"></a>五阶段总结</h4><p>阶段一：开始阶段：BOOT_PROGRESS_PMS_START。这个阶段的主要工作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一件事：初始化PMS的各个子组件/子服务以及相关属性</span><br><span class="line">第二件事：解析package.xml，获取已经安装的App信息，存储到Settings的mPackages中</span><br><span class="line">第三件事：创建了后台工作线程及其Handler</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>阶段二：系统扫描阶段：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START。这个阶段的主要工作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一件事：扫描各个系统分区的的App</span><br><span class="line">第二件事：解析系统App信息</span><br><span class="line">第三件事：把解析结果存储起来，存储在PMS的相关属性和mSettings里</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>阶段三：Data扫描阶段：BOOT_PROGRESS_PMS_DATA_SCAN_START。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个阶段对/data/app进行了扫描，主要工作与扫描系统App目录是一样的，</span><br><span class="line">只是细节处理上有些不同。初次之外还做了一些扫尾工作。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>阶段四：扫描结束：BOOT_PROGRESS_PMS_SCAN_END。这个阶段主要工作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第一件事：如果SDK版本发生了变化（升级系统），重新对App进行授权</span><br><span class="line">第二件事：为系统核心服务准备存储空间</span><br><span class="line">第三件事：如果是升级后第一次正常启动，需要清除代码缓存，但不是会清除应用的配置文件</span><br><span class="line">第四讲事：把更新后的信息写回对应的xml文件中</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>阶段五：就绪阶段：BOOT_PROGRESS_PMS_READY。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个阶段又对一些属性进行了赋值，最重要的是初始化PackageInstallerService</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="PKMS构建成功之后"><a href="#PKMS构建成功之后" class="headerlink" title="PKMS构建成功之后"></a>PKMS构建成功之后</h2><p>在SystemServer中，PMS构建完成之后，仍然后一些额外的操作(通过查找mPackageManagerService看它在哪些地方用到了)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class="line">    t.traceBegin(<span class="string">&quot;startOtherServices&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 优化Dex</span></span><br><span class="line">        mPackageManagerService.updatePackagesIfNeeded();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t.traceBegin(<span class="string">&quot;PerformFstrimIfNeeded&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 磁盘清理</span></span><br><span class="line">        mPackageManagerService.performFstrimIfNeeded();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">&quot;performing fstrim&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    t.traceEnd();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    t.traceBegin(<span class="string">&quot;MakePackageManagerServiceReady&quot;</span>);</span><br><span class="line">    <span class="comment">// 通知mPackageManagerService及其子组件系统已就绪</span></span><br><span class="line">    mPackageManagerService.systemReady();</span><br><span class="line">    t.traceEnd();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We now tell the activity manager it is okay to run third party</span></span><br><span class="line">    <span class="comment">// code.  It will call back into us once it has gotten to the state</span></span><br><span class="line">    <span class="comment">// where third party code can really run (but before it has actually</span></span><br><span class="line">    <span class="comment">// started launching the initial applications), for us to complete our</span></span><br><span class="line">    <span class="comment">// initialization.</span></span><br><span class="line">    mActivityManagerService.systemReady(() -&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待PMS中为App的启动做好准备工作</span></span><br><span class="line">        mPackageManagerService.waitForAppDataPrepared();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;, t);</span><br><span class="line"></span><br><span class="line">    t.traceEnd(); <span class="comment">// startOtherServices</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【总结回顾】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在startOtherServices中，PKMS做了几件事情：</span><br><span class="line">在需要的情况下进行dex优化</span><br><span class="line">在需要的情况下进行磁盘清理</span><br><span class="line">通知PMS及其子组件系统已就绪</span><br><span class="line">ActivityManagerService启动Launcher之前等待PMS中为App的启动做好准备工作</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="简述总结"><a href="#简述总结" class="headerlink" title="简述总结"></a>简述总结</h2><p>总的来说，PMS在SystemServer里面创建，并向ServiceManager注册。<br>其创建过程分为五个阶段，在此过程中会从packages.xml等相关文件中读取上次保存的包列表和实时扫描的列表进行比较和更新，<br>处理升级事宜，最后把更新后的包列表重新持久化。<br>另外，创建完成之后还进行了一些dex优化、磁盘清理等等一些列额外操作。</p>
<h1 id="APK的扫描"><a href="#APK的扫描" class="headerlink" title="APK的扫描"></a>APK的扫描</h1><p>PKMS的构造函数中调用了 <strong>scanDirTracedLI</strong>方法 来扫描某个目录的apk文件。 </p>
<p>APK的扫描，整体描述图：</p>
<p><img src="/images/android_pms_06.png" alt="image"></p>
<p>PKMS.<strong>scanDirTracedLi</strong>：首先加入了一些systtrace的日志追踪，然后调用scanDirLI()进行分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirTracedLI</span><span class="params">(File scanDir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;scanDir [&quot;</span> + scanDir.getAbsolutePath() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 【注意】会调用此 scanDirLI函数</span></span><br><span class="line">        scanDirLI(scanDir, parseFlags, scanFlags, currentTime);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>PKMS.<strong>scanDirLI</strong>： 使用了ParallelPackageParser的对象，ParallelPackageParser是一个队列，我们这里手机所有系统的apk，然后从这些队列里面取出apk，再调用<strong>PackageParser</strong> 解析进行解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File scanDir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File[] files = scanDir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;No files in app dir &quot;</span> + scanDir);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Scanning app dir &quot;</span> + scanDir + <span class="string">&quot; scanFlags=&quot;</span> + scanFlags</span><br><span class="line">                + <span class="string">&quot; flags=0x&quot;</span> + Integer.toHexString(parseFlags));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// parallelPackageParser是一个队列，收集系统 apk 文件，</span></span><br><span class="line">    <span class="comment">// 然后从这个队列里面一个个取出 apk ，调用 PackageParser 解析</span></span><br><span class="line">     <span class="keyword">try</span> (ParallelPackageParser parallelPackageParser = <span class="keyword">new</span> ParallelPackageParser(</span><br><span class="line">            mSeparateProcesses, mOnlyCore, mMetrics, mCacheDir,</span><br><span class="line">            mParallelPackageParserCallback)) &#123;</span><br><span class="line">        <span class="comment">// Submit files for parsing in parallel</span></span><br><span class="line">        <span class="keyword">int</span> fileCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="comment">// 是Apk文件，或者是目录</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                    &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">            过滤掉非　apk　文件，如果不是则跳过继续扫描</span><br><span class="line">            <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">                <span class="comment">// Ignore entries which are not packages</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 把APK信息存入parallelPackageParser中的对象mQueue，PackageParser()函数赋给了队列中的pkg成员</span></span><br><span class="line">            <span class="comment">// 【们注意】 这里的 submit 函数 很重要，下面就会分析此函数</span></span><br><span class="line">            parallelPackageParser.submit(file, parseFlags);</span><br><span class="line">            fileCount++;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Process results one by one</span></span><br><span class="line">        <span class="keyword">for</span> (; fileCount &gt; <span class="number">0</span>; fileCount--) &#123;</span><br><span class="line">        <span class="comment">// 从parallelPackageParser中取出队列apk的信息</span></span><br><span class="line">            ParallelPackageParser.ParseResult parseResult = parallelPackageParser.take();</span><br><span class="line">            Throwable throwable = parseResult.throwable;</span><br><span class="line">            <span class="keyword">int</span> errorCode = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// TODO(toddke): move lower in the scan chain</span></span><br><span class="line">                <span class="comment">// Static shared libraries have synthetic package names</span></span><br><span class="line">                <span class="keyword">if</span> (parseResult.pkg.applicationInfo.isStaticSharedLibrary()) &#123;</span><br><span class="line">                    renameStaticSharedLibraryPackage(parseResult.pkg);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//调用 scanPackageChildLI 方法扫描一个特定的 apk 文件</span></span><br><span class="line">                    <span class="comment">// 该类的实例代表一个 APK 文件，所以它就是和 apk 文件对应的数据结构。</span></span><br><span class="line">                    scanPackageChildLI(parseResult.pkg, parseFlags, scanFlags,</span><br><span class="line">                            currentTime, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                    errorCode = e.error;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Failed to scan &quot;</span> + parseResult.scanFile + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> PackageParser.PackageParserException) &#123;</span><br><span class="line">                PackageParser.PackageParserException e = (PackageParser.PackageParserException)</span><br><span class="line">                        throwable;</span><br><span class="line">                errorCode = e.error;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Failed to parse &quot;</span> + parseResult.scanFile + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unexpected exception occurred while parsing &quot;</span></span><br><span class="line">                        + parseResult.scanFile, throwable);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Delete invalid userdata apps</span></span><br><span class="line">            <span class="comment">//如果是非系统 apk 并且解析失败</span></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_AS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    errorCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">&quot;Deleting invalid package at &quot;</span> + parseResult.scanFile);</span><br><span class="line">                 <span class="comment">// 非系统 Package 扫描失败，删除文件</span></span><br><span class="line">                removeCodePathLI(parseResult.scanFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ParallelPackageParser.<strong>submit</strong> : </p>
<p>把扫描路径中的APK等内容，放入队列mQueue，</p>
<p>并把parsePackage() pp 赋给ParseResult，用于后面的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags)</span> </span>&#123;</span><br><span class="line">    mService.submit(() -&gt; &#123;</span><br><span class="line">        ParseResult pr = <span class="keyword">new</span> ParseResult();</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;parallel parsePackage [&quot;</span> + scanFile + <span class="string">&quot;]&quot;</span>); <span class="comment">// 日志打印</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">            pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">            pp.setOnlyCoreApps(mOnlyCore);</span><br><span class="line">            pp.setDisplayMetrics(mMetrics);</span><br><span class="line">            pp.setCacheDir(mCacheDir);</span><br><span class="line">            pp.setCallback(mPackageParserCallback);</span><br><span class="line">            pr.scanFile = scanFile;</span><br><span class="line">            <span class="comment">// 并把parsePackage()与pp 赋值ParseResult，用于后面的调用</span></span><br><span class="line">            pr.pkg = parsePackage(pp, scanFile, parseFlags); <span class="comment">// 【注意】parsePackage下面会分析</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            pr.throwable = e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 把扫描路径中的APK等内容，放入队列mQueue</span></span><br><span class="line">            mQueue.put(pr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="comment">// Propagate result to callers of take().</span></span><br><span class="line">            <span class="comment">// This is helpful to prevent main thread from getting stuck waiting on</span></span><br><span class="line">            <span class="comment">// ParallelPackageParser to finish in case of interruption</span></span><br><span class="line">            mInterruptedInThread = Thread.currentThread().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过 PackageParser.<strong>parsePackage</strong> 进行apk解析：</p>
<p>​        如果传入的packageFile是目录，        调用parseClusterPackage()解析</p>
<p>​        如果传入的packageFile是APK文件， 调用parseMonolithicPackage()解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> useCaches)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">    <span class="comment">//如果传入的packageFile是目录，调用parseClusterPackage()解析</span></span><br><span class="line">        parsed = parseClusterPackage(packageFile, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果是APK文件，就调用parseMonolithicPackage()解析</span></span><br><span class="line">        parsed = parseMonolithicPackage(packageFile, flags);  <span class="comment">// 【注意】下面我们分析此函数</span></span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">return</span> parsed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>PackageParser.<strong>parseMonolithicPackage</strong>()，它的作用是解析给定的APK文件，将其作为单个单块包处理，最终调用parseBaseApk()进行解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lite.coreApp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                    <span class="string">&quot;Not a coreApp: &quot;</span> + apkFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> SplitAssetLoader assetLoader = <span class="keyword">new</span> DefaultSplitAssetLoader(lite, flags);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// 对核心应用解析 【注意】 最终调用parseBaseApk()进行解析，我们下面来分析</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assetLoader.getBaseAssetManager(), flags);</span><br><span class="line">        pkg.setCodePath(apkFile.getCanonicalPath());</span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">&quot;Failed to get path: &quot;</span> + apkFile, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assetLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>PackageParser.<strong>parseBaseApk</strong>()主要是对AndroidManifest.xml进行解析，解析后所有的信息放在Package对象中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"> 	 ...</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line">  	...</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cookie = assets.findCookieForPath(apkPath);</span><br><span class="line">        <span class="keyword">if</span> (cookie == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                    <span class="string">&quot;Failed adding asset path: &quot;</span> + apkPath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获得一个 XML 资源解析对象，该对象解析的是 APK 中的 AndroidManifest.xml 文件。</span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line">        <span class="keyword">final</span> Resources res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">     </span><br><span class="line">    	<span class="comment">// 再调用重载函数parseBaseApk()最终到parseBaseApkCommon()，解析AndroidManifest.xml 后得到一个Package对象</span></span><br><span class="line">	    <span class="comment">// 【注意】解析后所有的信息放在Package对象中</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(apkPath, res, parser, flags, outError);</span><br><span class="line">    	...</span><br><span class="line">        pkg.setVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setApplicationVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setBaseCodePath(apkPath);</span><br><span class="line">        pkg.setSigningDetails(SigningDetails.UNKNOWN);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>parseBaseApk —–&gt;  <strong>parseBaseApkCommon</strong> ,   parseBaseApk省略了</p>
<p>PackageParser.<strong>parseBaseApkCommon</strong> 从AndroidManifest.xml中获取标签名，解析标签中的各个item的内容，存入Package对象中</p>
<p>例如：获取标签  “application”、”permission”、”package”、”manifest”   ，太多了，省略了哈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="params"><span class="function">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">  TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">  <span class="comment">//拿到AndroidManifest.xml 中的sharedUserId, 一般情况下有“android.uid.system”等信息</span></span><br><span class="line">  String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_sharedUserId, <span class="number">0</span>);</span><br><span class="line">      </span><br><span class="line">  <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">    <span class="comment">//从AndroidManifest.xml中获取标签名</span></span><br><span class="line">    String tagName = parser.getName();</span><br><span class="line">    <span class="comment">//如果读到AndroidManifest.xml中的tag是&quot;application&quot;,执行parseBaseApplication()进行解析</span></span><br><span class="line">    <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">        ...</span><br><span class="line">            &#125;</span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">      		<span class="comment">// 解析&quot;application&quot;的信息，赋值给pkg </span></span><br><span class="line">        	<span class="comment">// 【注意】这里解析到的是&quot;application&quot; &lt;application 包含了 四大组件，下面分析此操作</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">//如果标签是&quot;permission&quot;</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123;</span><br><span class="line">      		<span class="comment">//进行&quot;permission&quot;的解析</span></span><br><span class="line">            <span class="keyword">if</span> (!parsePermission(pkg, res, parser, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">     	 ....</span><br><span class="line">     &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上面解析AndroidManifest.xml，会得到 “<strong>application</strong>“、”overlay”、”permission”、”uses-permission” 等信息</p>
<p>我们下面就针对”<strong>application</strong>“进行展开分析一下，进入 PackageParser.<strong>parseBaseApplication</strong>()函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="params"><span class="function">            XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">  <span class="title">while</span> <span class="params">((type = parser.next()</span>) !</span>= XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">    <span class="comment">// 获取&quot;application&quot;子标签的标签内容</span></span><br><span class="line">    String tagName = parser.getName();</span><br><span class="line">    <span class="comment">// 如果标签是&quot;activity&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;activity&quot;</span>)) &#123; <span class="comment">// 解析Activity的信息，把activity加入Package对象</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, cachedArgs, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            hasActivityOrder |= (a.order != <span class="number">0</span>);</span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;receiver&quot;</span>)) &#123; <span class="comment">// 如果标签是&quot;receiver&quot;，获取receiver信息，加入Package对象</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, cachedArgs, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            hasReceiverOrder |= (a.order != <span class="number">0</span>);</span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;service&quot;</span>)) &#123; <span class="comment">// 如果标签是&quot;service&quot;，获取service信息，加入Package对象</span></span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError, cachedArgs);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            hasServiceOrder |= (s.order != <span class="number">0</span>);</span><br><span class="line">            owner.services.add(s);</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;provider&quot;</span>)) &#123; <span class="comment">// 如果标签是&quot;provider&quot;，获取provider信息，加入Package对象</span></span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError, cachedArgs);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            owner.providers.add(p);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 PackageParser 扫描完一个 APK 后，此时系统已经根据该 APK 中 AndroidManifest.xml，创建了一个完整的 Package 对象</p>
<p><strong>APK的扫描，自我总结：</strong></p>
<p>第一步：扫描APK，解析AndroidManifest.xml文件，得到清单文件各个标签内容</p>
<p>第二步：解析清单文件到的信息由 Package 保存。从该类的成员变量可看出，和 Android 四大组件相关的信息分别由 activites、receivers、providers、services 保存，由于一个 APK 可声明多个组件，因此 activites 和 receivers等均声明为 ArrayList</p>
<h1 id="APK的安装"><a href="#APK的安装" class="headerlink" title="APK的安装"></a>APK的安装</h1><p>安装步骤一: 把Apk的信息通过IO流的形式写入到PackageInstaller.Session中 </p>
<p>安装步骤二: 调用PackageInstaller.Session的commit方法, 把Apk的信息交给PKMS处理</p>
<p>安装步骤三: 进行Apk的Copy操作, 进行安装</p>
<p><strong>安装的三步走, 整体描述图:</strong></p>
<p><img src="/images/android_pms_07.png" alt="image"></p>
<p>用户点击 xxx.apk 文件进行安装,   从 开始安装 到 完成安装 流程如下:</p>
<p><img src="/images/android_pms_08.png" alt="image"></p>
<p>APK的安装, 整体描述图:</p>
<p><img src="/images/android_pms_09.png" alt="image"></p>
<p>点击一个apk后，会弹出安装界面，点击确定按钮后，会进入<strong>PackageInstallerActivity</strong> 的 <strong>bindUi</strong>() 中的mAlert点击事件, 弹出的安装界面底部显示的是一个diaglog，主要由bindUi构成，上面有 ”<strong>取消</strong>“ 和 ”<strong>安装</strong>“ 两个按钮，点击安装后 调用startInstall()进行安装:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindUi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mAlert.setIcon(mAppSnippet.icon);</span><br><span class="line">    mAlert.setTitle(mAppSnippet.label);</span><br><span class="line">    mAlert.setView(R.layout.install_content_view);</span><br><span class="line">    mAlert.setButton(DialogInterface.BUTTON_POSITIVE, getString(R.string.install),</span><br><span class="line">            (ignored, ignored2) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (mOk.isEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                        mInstaller.setPermissionsResult(mSessionId, <span class="keyword">true</span>);</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        startInstall();  <span class="comment">// 进行APK安装  [注意] 下面开始分析 startInstall 做的事情</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">null</span>);</span><br><span class="line">    mAlert.setButton(DialogInterface.BUTTON_NEGATIVE, getString(R.string.cancel),</span><br><span class="line">            (ignored, ignored2) -&gt; &#123;</span><br><span class="line">                <span class="comment">// Cancel and finish</span></span><br><span class="line">                setResult(RESULT_CANCELED);</span><br><span class="line">                <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果mSessionId存在，执行setPermissionsResult()完成取消安装</span></span><br><span class="line">                    mInstaller.setPermissionsResult(mSessionId, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                finish();</span><br><span class="line">            &#125;, <span class="keyword">null</span>);</span><br><span class="line">    setupAlert();</span><br><span class="line"> </span><br><span class="line">    mOk = mAlert.getButton(DialogInterface.BUTTON_POSITIVE);</span><br><span class="line">    mOk.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> <strong>startInstall</strong>方法组装了一个Intent，并跳转到 InstallInstalling 这个Activity，并关闭掉当前的PackageInstallerActivity。InstallInstalling主要用于向包管理器发送包的信息并处理包管理的回调:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Start subactivity to actually install the application</span></span><br><span class="line">    Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">    newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO,</span><br><span class="line">            mPkgInfo.applicationInfo);</span><br><span class="line">    newIntent.setData(mPackageURI);</span><br><span class="line">    <span class="comment">// 设置Intent中的class为 InstallInstalling，用来进行Activity跳转</span></span><br><span class="line">    <span class="comment">// class InstallInstalling extends AlertActivity  [注意] 下面会分析 InstallInstalling Activity</span></span><br><span class="line">    newIntent.setClass(<span class="keyword">this</span>, InstallInstalling.class);</span><br><span class="line">    String installerPackageName = getIntent().getStringExtra(</span><br><span class="line">            Intent.EXTRA_INSTALLER_PACKAGE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_URI, mOriginatingURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mReferrerURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_REFERRER, mReferrerURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingUid != PackageInstaller.SessionParams.UID_UNKNOWN) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_UID, mOriginatingUid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                installerPackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    newIntent.addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT);</span><br><span class="line">    <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">&quot;downloaded app uri=&quot;</span>+mPackageURI);</span><br><span class="line">    startActivity(newIntent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动 <strong>InstallInstalling</strong>，进入onCreate, 重点是看onCreate函数中的<strong>六步</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">    ApplicationInfo appInfo = getIntent()</span><br><span class="line">            .getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO);</span><br><span class="line">    mPackageURI = getIntent().getData();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(mPackageURI.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getPackageManager().installExistingPackage(appInfo.packageName);</span><br><span class="line">            launchSuccess();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//根据mPackageURI创建一个对应的File</span></span><br><span class="line">        <span class="keyword">final</span> File sourceFile = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line">        PackageUtil.AppSnippet as = PackageUtil.getAppSnippet(<span class="keyword">this</span>, appInfo, sourceFile);</span><br><span class="line"> </span><br><span class="line">        mAlert.setIcon(as.icon);</span><br><span class="line">        mAlert.setTitle(as.label);</span><br><span class="line">        mAlert.setView(R.layout.install_content_view);</span><br><span class="line">        mAlert.setButton(DialogInterface.BUTTON_NEGATIVE, getString(R.string.cancel),</span><br><span class="line">                (ignored, ignored2) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mInstallingTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInstallingTask.cancel(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">if</span> (mSessionId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        getPackageManager().getPackageInstaller().abandonSession(mSessionId);</span><br><span class="line">                        mSessionId = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    setResult(RESULT_CANCELED);</span><br><span class="line">                    finish();</span><br><span class="line">                &#125;, <span class="keyword">null</span>);</span><br><span class="line">        setupAlert();</span><br><span class="line">        requireViewById(R.id.installing).setVisibility(View.VISIBLE);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 第一步.如果savedInstanceState不为null，获取此前保存的mSessionId和mInstallId，其中mSessionId是安装包的会话id，mInstallId是等待的安装事件id</span></span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSessionId = savedInstanceState.getInt(SESSION_ID);</span><br><span class="line">            mInstallId = savedInstanceState.getInt(INSTALL_ID);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Reregister for result; might instantly call back if result was delivered while</span></span><br><span class="line">            <span class="comment">// activity was destroyed</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 第二步.根据mInstallId向InstallEventReceiver注册一个观察者，launchFinishBasedOnResult会接收到安装事件的回调，</span></span><br><span class="line">                <span class="comment">//无论安装成功或者失败都会关闭当前的Activity(InstallInstalling)。如果savedInstanceState为null，代码的逻辑也是类似的</span></span><br><span class="line">                InstallEventReceiver.addObserver(<span class="keyword">this</span>, mInstallId,</span><br><span class="line">                        <span class="keyword">this</span>::launchFinishBasedOnResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (EventResultPersister.OutOfIdsException e) &#123;</span><br><span class="line">                <span class="comment">// Does not happen</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 第三步.创建SessionParams，它用来代表安装会话的参数,组装params</span></span><br><span class="line">            PackageInstaller.SessionParams params = <span class="keyword">new</span> PackageInstaller.SessionParams(</span><br><span class="line">                    PackageInstaller.SessionParams.MODE_FULL_INSTALL);</span><br><span class="line">            params.setInstallAsInstantApp(<span class="keyword">false</span>);</span><br><span class="line">            params.setReferrerUri(getIntent().getParcelableExtra(Intent.EXTRA_REFERRER));</span><br><span class="line">            params.setOriginatingUri(getIntent()</span><br><span class="line">                    .getParcelableExtra(Intent.EXTRA_ORIGINATING_URI));</span><br><span class="line">            params.setOriginatingUid(getIntent().getIntExtra(Intent.EXTRA_ORIGINATING_UID,</span><br><span class="line">                    UID_UNKNOWN));</span><br><span class="line">            params.setInstallerPackageName(getIntent().getStringExtra(</span><br><span class="line">                    Intent.EXTRA_INSTALLER_PACKAGE_NAME));</span><br><span class="line">            params.setInstallReason(PackageManager.INSTALL_REASON_USER);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 第四步.根据mPackageUri对包（APK）进行轻量级的解析，并将解析的参数赋值给SessionParams</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PackageParser.PackageLite pkg = PackageParser.parsePackageLite(file, <span class="number">0</span>);</span><br><span class="line">                params.setAppPackageName(pkg.packageName);</span><br><span class="line">                params.setInstallLocation(pkg.installLocation);</span><br><span class="line">                params.setSize(</span><br><span class="line">                        PackageHelper.calculateInstalledSize(pkg, <span class="keyword">false</span>, params.abiOverride));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageParser.PackageParserException e) &#123;</span><br><span class="line">                Log.e(LOG_TAG, <span class="string">&quot;Cannot parse package &quot;</span> + file + <span class="string">&quot;. Assuming defaults.&quot;</span>);</span><br><span class="line">                Log.e(LOG_TAG,</span><br><span class="line">                        <span class="string">&quot;Cannot calculate installed size &quot;</span> + file + <span class="string">&quot;. Try only apk size.&quot;</span>);</span><br><span class="line">                params.setSize(file.length());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.e(LOG_TAG,</span><br><span class="line">                        <span class="string">&quot;Cannot calculate installed size &quot;</span> + file + <span class="string">&quot;. Try only apk size.&quot;</span>);</span><br><span class="line">                params.setSize(file.length());</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 第五步.向InstallEventReceiver注册一个观察者返回一个新的mInstallId，</span></span><br><span class="line">                <span class="comment">//其中InstallEventReceiver继承自BroadcastReceiver，用于接收安装事件并回调给EventResultPersister。</span></span><br><span class="line">                mInstallId = InstallEventReceiver</span><br><span class="line">                        .addObserver(<span class="keyword">this</span>, EventResultPersister.GENERATE_NEW_ID,</span><br><span class="line">                                <span class="keyword">this</span>::launchFinishBasedOnResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (EventResultPersister.OutOfIdsException e) &#123;</span><br><span class="line">                launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 第六步.PackageInstaller的createSession方法内部会通过IPackageInstaller与PackageInstallerService进行进程间通信，</span></span><br><span class="line">                <span class="comment">//最终调用的是PackageInstallerService的createSession方法来创建并返回mSessionId</span></span><br><span class="line">                mSessionId = getPackageManager().getPackageInstaller().createSession(params);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        mCancelButton = mAlert.getButton(DialogInterface.BUTTON_NEGATIVE);</span><br><span class="line"> </span><br><span class="line">        mSessionCallback = <span class="keyword">new</span> InstallSessionCallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意: 以上<strong>第六步</strong>是重点 PackageInstaller 的 createSession()内部会通过IPackageInstaller与PackageInstallerService进行进程间通信，最终调用的是PackageInstallerService的createSession方法来创建并返回mSessionId</p>
<p><strong>InstallInstalling.onResume</strong>方法中，调用onPostExecute()方法，将APK的信息通过IO流的形式写入到PackageInstaller.Session中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    <span class="comment">// This is the first onResume in a single life of the activity</span></span><br><span class="line">    <span class="keyword">if</span> (mInstallingTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">        PackageInstaller installer = getPackageManager().getPackageInstaller();</span><br><span class="line">        <span class="comment">// 获取sessionInfo</span></span><br><span class="line">        PackageInstaller.SessionInfo sessionInfo = installer.getSessionInfo(mSessionId);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (sessionInfo != <span class="keyword">null</span> &amp;&amp; !sessionInfo.isActive()) &#123;</span><br><span class="line">            <span class="comment">// 【注意】 最终执行onPostExecute() 下面来分析</span></span><br><span class="line">            <span class="comment">// 创建内部类InstallingAsyncTask的对象，调用execute()，最终进入onPostExecute()</span></span><br><span class="line">            mInstallingTask = <span class="keyword">new</span> InstallingAsyncTask();</span><br><span class="line">            mInstallingTask.execute();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// we will receive a broadcast when the install is finished</span></span><br><span class="line">            mCancelButton.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">            setFinishOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Installinstalling.<strong>InstallingAsyncTask：</strong> 关注  第一步  和  第二步</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallingAsyncTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Void</span>, <span class="title">PackageInstaller</span>.<span class="title">Session</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> isDone;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 第一步： doInBackground()会根据包(APK)的Uri，将APK的信息通过IO流的形式写入到PackageInstaller.Session中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> PackageInstaller.<span class="function">Session <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">        PackageInstaller.Session session;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session = getPackageManager().getPackageInstaller().openSession(mSessionId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        session.setStagingProgress(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> (InputStream in = <span class="keyword">new</span> FileInputStream(file)) &#123;</span><br><span class="line">                <span class="keyword">long</span> sizeBytes = file.length();</span><br><span class="line">                <span class="keyword">try</span> (OutputStream out = session</span><br><span class="line">                        .openWrite(<span class="string">&quot;PackageInstaller&quot;</span>, <span class="number">0</span>, sizeBytes)) &#123;</span><br><span class="line">                    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> numRead = in.read(buffer);</span><br><span class="line"> </span><br><span class="line">                        <span class="keyword">if</span> (numRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                            session.fsync(out);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                        <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                            session.close();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//将APK的信息通过IO流的形式写入到PackageInstaller.Session中</span></span><br><span class="line">                        out.write(buffer, <span class="number">0</span>, numRead);</span><br><span class="line">                        <span class="keyword">if</span> (sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) numRead / (<span class="keyword">float</span>) sizeBytes);</span><br><span class="line">                            session.addProgress(fraction);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> session;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | SecurityException e) &#123;</span><br><span class="line">            Log.e(LOG_TAG, <span class="string">&quot;Could not write package&quot;</span>, e);</span><br><span class="line"> </span><br><span class="line">            session.close();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                isDone = <span class="keyword">true</span>;</span><br><span class="line">                notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 第二步：最后在onPostExecute()中 调用PackageInstaller.Session的commit方法，进行安装</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(PackageInstaller.Session session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Intent broadcastIntent = <span class="keyword">new</span> Intent(BROADCAST_ACTION);</span><br><span class="line">            broadcastIntent.setFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            broadcastIntent.setPackage(getPackageName());</span><br><span class="line">            broadcastIntent.putExtra(EventResultPersister.EXTRA_ID, mInstallId);</span><br><span class="line"> </span><br><span class="line">            PendingIntent pendingIntent = PendingIntent.getBroadcast(</span><br><span class="line">                    InstallInstalling.<span class="keyword">this</span>,</span><br><span class="line">                    mInstallId,</span><br><span class="line">                    broadcastIntent,</span><br><span class="line">                    PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 【注意】commit 下面会分析</span></span><br><span class="line">            <span class="comment">// 调用PackageInstaller.Session的commit方法，进行安装</span></span><br><span class="line">            session.commit(pendingIntent.getIntentSender());</span><br><span class="line">            mCancelButton.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">            setFinishOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            getPackageManager().getPackageInstaller().abandonSession(mSessionId);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (!isCancelled()) &#123;</span><br><span class="line">                launchFailure(PackageManager.INSTALL_FAILED_INVALID_APK, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>PackageInstaller的<strong>commit</strong>()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[PackageInstaller.java] <span class="function">commit</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="meta">@NonNull</span> IntentSender statusReceiver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//  mSession的类型为IPackageInstallerSession，这说明要通过IPackageInstallerSession来进行进程间的通信，最终会调用PackageInstallerSession的commit方法，这样代码逻辑就到了Java框架层的。</span></span><br><span class="line">        <span class="comment">// 调用IPackageInstallerSession的commit方法, 跨进程调用到 PackageInstallerSession.commit()</span></span><br><span class="line">        mSession.commit(statusReceiver, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> PackageInstallerSession.**commit()**中 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[PackageInstallerSession.java] commit()</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="meta">@NonNull</span> IntentSender statusReceiver, <span class="keyword">boolean</span> forTransfer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIsPerfLockAcquired &amp;&amp; mPerfBoostInstall != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mPerfBoostInstall.perfLockRelease();</span><br><span class="line">        mIsPerfLockAcquired = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 调用markAsCommitted()</span></span><br><span class="line">    <span class="keyword">if</span> (!markAsCommitted(statusReceiver, forTransfer)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 【注意】向Handler发送一个类型为MSG_COMMIT的消息 ，下面会分析</span></span><br><span class="line">    mHandler.obtainMessage(MSG_COMMIT).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>MSG_COMMIT</strong>在handler中进行处理，进入handleCommit()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MSG_COMMIT:</span><br><span class="line">            handleCommit();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    List&lt;PackageInstallerSession&gt; childSessions = getChildSessions();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//最终调用installStage()，进入PKMS</span></span><br><span class="line">            commitNonStagedLocked(childSessions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        <span class="keyword">final</span> String completeMsg = ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">        Slog.e(TAG, <span class="string">&quot;Commit of session &quot;</span> + sessionId + <span class="string">&quot; failed: &quot;</span> + completeMsg);</span><br><span class="line">        destroyInternal();</span><br><span class="line">        dispatchSessionFinished(e.error, completeMsg, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最终调用 **mPm.installStage()**，进入PKMS 【经过千辛万苦，终于要进入PKMS了】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitNonStagedLocked</span><span class="params">(...)</span><span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isMultiPackage()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mPm.installStage(activeChildSessions); <span class="comment">// 【注意】跨越进程 进入 PKMS.installStage了</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPm.installStage(committingSession);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>PKMS.installStage</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[PackageManagerService.java] </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installStage</span><span class="params">(ActiveInstallSession activeInstallSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTANT) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((activeInstallSession.getSessionParams().installFlags</span><br><span class="line">                &amp; PackageManager.INSTALL_INSTANT_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">&quot;Ephemeral install of &quot;</span> + activeInstallSession.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一步.创建了类型为INIT_COPY的消息</span></span><br><span class="line">    <span class="keyword">final</span> Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 第二步.创建InstallParams，它对应于包的安装数据</span></span><br><span class="line">    <span class="keyword">final</span> InstallParams params = <span class="keyword">new</span> InstallParams(activeInstallSession);</span><br><span class="line">    params.setTraceMethod(<span class="string">&quot;installStage&quot;</span>).setTraceCookie(System.identityHashCode(params));</span><br><span class="line">    msg.obj = params;</span><br><span class="line"> </span><br><span class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;installStage&quot;</span>,</span><br><span class="line">            System.identityHashCode(msg.obj));</span><br><span class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;queueInstall&quot;</span>,</span><br><span class="line">            System.identityHashCode(msg.obj));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 第三步.将InstallParams通过消息发送出去。</span></span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">对INIT_COPY的消息的处理</span><br><span class="line">[PackageManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">            HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">            <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;init_copy: &quot;</span> + params);</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;queueInstall&quot;</span>,</span><br><span class="line">                        System.identityHashCode(params));</span><br><span class="line">                Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;startCopy&quot;</span>);</span><br><span class="line">                <span class="comment">// 【注意】执行APK拷贝动作，这里会执行到  final void startCopy()</span></span><br><span class="line">                params.startCopy();</span><br><span class="line">                Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">		[PKMS.HandlerParams]</span><br><span class="line">		<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;startCopy &quot;</span> + mUser + <span class="string">&quot;: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            handleStartCopy();  </span><br><span class="line">            handleReturnCode();  <span class="comment">// 调用到下面 handleReturnCode</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		[PKMS.MultiPackageInstallParams]</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">handleReturnCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mVerificationCompleted &amp;&amp; mEnableRollbackCompleted) &#123;</span><br><span class="line">                .....</span><br><span class="line">                <span class="keyword">if</span> (mRet == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    mRet = mArgs.copyApk(); <span class="comment">// 【注意】 下面会说到 copyApk</span></span><br><span class="line">                &#125;</span><br><span class="line">                .....</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>APK 拷贝 方法调用步骤如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PKMS </span></span><br><span class="line"><span class="function">	<span class="title">copyApk</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	<span class="title">doCopyApk</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span></span><br><span class="line"><span class="function">				PackageManagerServiceUtils</span></span><br><span class="line"><span class="function">					<span class="title">copyPacakge</span><span class="params">()</span></span></span><br><span class="line"><span class="function">					<span class="title">copyFile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// TODO 通过文件流的操作，把APK拷贝到/data/app等目录</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String sourcePath, File targetDir, String targetName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ErrnoException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!FileUtils.isValidExtFilename(targetName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid filename: &quot;</span> + targetName);</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.d(TAG, <span class="string">&quot;Copying &quot;</span> + sourcePath + <span class="string">&quot; to &quot;</span> + targetName);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> File targetFile = <span class="keyword">new</span> File(targetDir, targetName);</span><br><span class="line">    <span class="keyword">final</span> FileDescriptor targetFd = Os.open(targetFile.getAbsolutePath(),</span><br><span class="line">            O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">    Os.chmod(targetFile.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line">    FileInputStream source = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        source = <span class="keyword">new</span> FileInputStream(sourcePath);</span><br><span class="line">        FileUtils.copy(source.getFD(), targetFd);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>进入 Android 11.0 核心安装环节：</p>
<p><img src="/images/android_pms_10.png" alt="image"></p>
<p>processPendingInstall：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (args.mMultiPackageInstallParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">        args.mMultiPackageInstallParams.tryProcessInstallRequest(args, currentStatus);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//1.设置安装参数</span></span><br><span class="line">        PackageInstalledInfo res = createPackageInstalledInfo(currentStatus);</span><br><span class="line">        <span class="comment">//2.创建一个新线程，处理安装参数，进行安装</span></span><br><span class="line">        processInstallRequestsAsync(</span><br><span class="line">                res.returnCode == PackageManager.INSTALL_SUCCEEDED,</span><br><span class="line">                Collections.singletonList(<span class="keyword">new</span> InstallRequest(args, res)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processInstallRequestsAsync</span><span class="params">(<span class="keyword">boolean</span> success,</span></span></span><br><span class="line"><span class="params"><span class="function">        List&lt;InstallRequest&gt; installRequests)</span> </span>&#123;</span><br><span class="line">    mHandler.post(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="keyword">for</span> (InstallRequest request : installRequests) &#123;</span><br><span class="line">                <span class="comment">//1.如果之前安装失败，清除无用信息</span></span><br><span class="line">                request.args.doPreInstall(request.installResult.returnCode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                <span class="comment">//2. installPackagesTracedLI 是安装过程的核心方法，然后调用 installPackagesLI 进行安装。</span></span><br><span class="line">                <span class="comment">// 【注意】下面会分析此函数 installPackagesTracedLI</span></span><br><span class="line">                installPackagesTracedLI(installRequests);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (InstallRequest request : installRequests) &#123;</span><br><span class="line">                <span class="comment">//3.如果之前安装失败，清除无用信息</span></span><br><span class="line">                request.args.doPostInstall(</span><br><span class="line">                        request.installResult.returnCode, request.installResult.uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (InstallRequest request : installRequests) &#123;</span><br><span class="line">            restoreAndPostInstall(request.args.user.getIdentifier(), request.installResult,</span><br><span class="line">                    <span class="keyword">new</span> PostInstallData(request.args, request.installResult, <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>installPackagesTracedLI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackagesLI</span><span class="params">(List&lt;InstallRequest&gt; requests)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 环节一.Prepare 准备：分析任何当前安装状态，分析包并对其进行初始验证。</span></span><br><span class="line">    prepareResult = preparePackageLI(request.args, request.installResult);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 环节二.Scan  扫描：考虑到prepare中收集的上下文，询问已分析的包。</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;ScanResult&gt; scanResults = scanPackageTracedLI(</span><br><span class="line">                            prepareResult.packageToScan, prepareResult.parseFlags,</span><br><span class="line">                            prepareResult.scanFlags, System.currentTimeMillis(),</span><br><span class="line">                            request.args.user);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 环节三.Reconcile 调和：在彼此的上下文和当前系统状态中验证扫描的包，以确保安装成功。</span></span><br><span class="line">    ReconcileRequest reconcileRequest = <span class="keyword">new</span> ReconcileRequest(preparedScans, installArgs,</span><br><span class="line">            installResults,</span><br><span class="line">            prepareResults,</span><br><span class="line">            mSharedLibraries,</span><br><span class="line">            Collections.unmodifiableMap(mPackages), versionInfos,</span><br><span class="line">            lastStaticSharedLibSettings);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 环节四.Commit 提交：提交所有扫描的包并更新系统状态。这是安装流中唯一可以修改系统状态的地方，必须在此阶段之前确定所有可预测的错误。</span></span><br><span class="line">    commitPackagesLocked(commitRequest);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 环节五.完成APK的安装【注意：下面会分析这个操作】</span></span><br><span class="line">    executePostCommitSteps(commitRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>executePostCommitSteps</strong> 安装APK,并为新的代码路径准备应用程序配置文件,并再次检查是否需要<strong>dex优化</strong></p>
<p>如果是直接安装新包，会为新的代码路径准备应用程序配置文件</p>
<p>如果是替换安装：其主要过程为更新设置，清除原有的某些APP数据，重新生成相关的app数据目录等步骤，同时要区分系统应用替换和非系统应用替换。而安装新包：则直接更新设置，生成APP数据即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[PackageManagerService.java] executePostCommitSteps()</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executePostCommitSteps</span><span class="params">(CommitRequest commitRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ReconciledPackage reconciledPkg : commitRequest.reconciledPackages.values()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//1)进行安装</span></span><br><span class="line">        prepareAppDataAfterInstallLIF(pkg);</span><br><span class="line">        <span class="comment">//2)如果需要替换安装，则需要清楚原有的APP数据</span></span><br><span class="line">        <span class="keyword">if</span> (reconciledPkg.prepareResult.clearCodeCache) &#123;</span><br><span class="line">            clearAppDataLIF(pkg, UserHandle.USER_ALL, FLAG_STORAGE_DE | FLAG_STORAGE_CE</span><br><span class="line">                    | FLAG_STORAGE_EXTERNAL | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="comment">//3)为新的代码路径准备应用程序配置文件。这需要在调用dexopt之前完成，以便任何安装时配置文件都可以用于优化。</span></span><br><span class="line">        mArtManagerService.prepareAppProfiles(</span><br><span class="line">                pkg,</span><br><span class="line">                resolveUserIds(reconciledPkg.installArgs.user.getIdentifier()),</span><br><span class="line">                <span class="comment">/* updateReferenceProfileContent= */</span> <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> performDexopt =</span><br><span class="line">                (!instantApp || Global.getInt(mContext.getContentResolver(),</span><br><span class="line">                Global.INSTANT_APP_DEXOPT_ENABLED, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">                &amp;&amp; ((pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) == <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (performDexopt) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//4)执行dex优化</span></span><br><span class="line">            mPackageDexOptimizer.performDexOpt(pkg,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* instructionSets */</span>,</span><br><span class="line">                    getOrCreateCompilerPackageStats(pkg),</span><br><span class="line">                    mDexManager.getPackageUseInfoOrDefault(packageName),</span><br><span class="line">                    dexoptOptions);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        BackgroundDexOptService.notifyPackageChanged(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>prepareAppDataAfterInstallLIF:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">通过一系列的调用，最终会调用到[Installer.java] createAppData()进行安装，交给installed进程进行APK的安装</span><br><span class="line">调用栈如下：</span><br><span class="line"></span><br><span class="line">prepareAppDataAfterInstallLIF()</span><br><span class="line">      	|</span><br><span class="line">prepareAppDataLIF()</span><br><span class="line">    	|</span><br><span class="line">prepareAppDataLeafLIF()</span><br><span class="line">    	|</span><br><span class="line">[Installer.java]</span><br><span class="line">		createAppData()</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataAfterInstallLIF</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : um.getUsers()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (ps.getInstalled(user.id)) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> when user data is locked, mark that we&#x27;re still dirty</span></span><br><span class="line">            prepareAppDataLIF(pkg, user.id, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;Package was null!&quot;</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    prepareAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        prepareAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用Installd守护进程的入口</span></span><br><span class="line">        ceDataInode = mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                appId, seInfo, app.targetSdkVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.isSystemApp()) &#123;</span><br><span class="line">            destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ceDataInode = mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                        appId, seInfo, app.targetSdkVersion);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Installer.<strong>createAppData</strong> 收尾工作，安装完成后，更新设置，更新安装锁等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Installer.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">createAppData</span><span class="params">(String uuid, String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags, <span class="keyword">int</span> appId,</span></span></span><br><span class="line"><span class="params"><span class="function">        String seInfo, <span class="keyword">int</span> targetSdkVersion)</span> <span class="keyword">throws</span> InstallerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!checkBeforeRemote()) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// mInstalld 为IInstalld的对象，即通过Binder调用到 进程installd，最终调用installd的createAppData()</span></span><br><span class="line">        <span class="comment">// 【注意】 mInstalld是一个aidl文件，通过此aidl文件调用到 Binder机制的服务端，服务端哪里要操控底层....</span></span><br><span class="line">        <span class="keyword">return</span> mInstalld.createAppData(uuid, packageName, userId, flags, appId, seInfo,</span><br><span class="line">                targetSdkVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> InstallerException.from(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>总结：安装的原理：</strong></p>
<p><img src="/images/android_pms_11.png" alt="image"></p>
<h1 id="权限扫描"><a href="#权限扫描" class="headerlink" title="权限扫描"></a>权限扫描</h1><p>PackageManagerService中执行systemReady()后，需求对 /system/etc/permissions中的各种xml进行扫描，进行相应的权限存储，让以后可以使用.</p>
<p>PackageManagerService执行systemReady()时，通过SystemConfig的readPermissionsFromXml()来扫描读取/system/etc/permissions中的xml文件,包括platform.xml和系统支持的各种硬件模块的feature主要工作:</p>
<p>整体图：</p>
<p><img src="/images/android_pms_12.png" alt="image"></p>
<p><strong>SystemConfig 的 readPermissions函数：</strong></p>
<p>此函数目的：（扫描/system/etc/permissions中文件，调用readPermissionsFromXml()进行解析，存入SsytemConfig相应的成员数组变量中）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">readPermissions</span><span class="params">(File libraryDir, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Iterate over the files in the directory and scan .xml files</span></span><br><span class="line">    File platformFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (File f : libraryDir.listFiles()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!f.isFile()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 最后读取platform.xml</span></span><br><span class="line">        <span class="keyword">if</span> (f.getPath().endsWith(<span class="string">&quot;etc/permissions/platform.xml&quot;</span>)) &#123;</span><br><span class="line">            platformFile = f;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        readPermissionsFromXml(f, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Read platform permissions last so it will take precedence</span></span><br><span class="line">    <span class="keyword">if</span> (platformFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        readPermissionsFromXml(platformFile, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>解析xml的标签节点，存入mGlobalGids、mPermissions、mSystemPermissions等成员变量中，供其他进行调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsFromXml</span><span class="params">(File permFile, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    FileReader permReader = <span class="keyword">null</span>;</span><br><span class="line">    permReader = <span class="keyword">new</span> FileReader(permFile);</span><br><span class="line">    ...</span><br><span class="line">    XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">    parser.setInput(permReader);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        String name = parser.getName();</span><br><span class="line">         <span class="keyword">switch</span> (name) &#123;</span><br><span class="line">             <span class="comment">//解析 group 标签，前面介绍的 XML 文件中没有单独使用该标签的地方</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;group&quot;</span>: &#123;</span><br><span class="line">                String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">&quot;gid&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> gid = android.os.Process.getGidForName(gidStr);</span><br><span class="line">                    <span class="comment">//转换 XML 中的 gid字符串为整型，并保存到 mGlobalGids 中</span></span><br><span class="line">                    mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;&lt;&quot;</span> + name + <span class="string">&quot;&gt; without gid in &quot;</span> + permFile + <span class="string">&quot; at &quot;</span>  + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;permission&quot;</span>: &#123; <span class="comment">//解析 permission 标签</span></span><br><span class="line">                <span class="keyword">if</span> (allowPermissions) &#123;</span><br><span class="line">                    String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;&lt;&quot;</span> + name + <span class="string">&quot;&gt; without name in &quot;</span> + permFile + <span class="string">&quot; at &quot;</span> + parser.getPositionDescription());</span><br><span class="line">                        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    perm = perm.intern();</span><br><span class="line">                    readPermission(parser, perm); <span class="comment">//调用 readPermission 处理,存入mPermissions</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logNotAllowedInPartition(name, permFile, parser);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>查看 XML文件：</p>
<p>adb devices</p>
<p>adb shell</p>
<p><img src="/images/android_pms_13.png" alt="image"></p>
<p>然后在导出去：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull /system/etc/permissions</span><br></pre></td></tr></table></figure>



<p>/system/etc/permissions中会存在很多的xml文件，例如我们看下 android.software.webview.xml的文件，内容如下：</p>
<p>里面只只有一个feature “android.software.webview”,大部分的xml都是类似的定义方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">name</span>=<span class="string">&quot;android.software.webview&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>让我们来简单的看下/system/etc/permissions/platform.xml的内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt_admin&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;inet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_LOGS&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;log&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_SURFACE_FLINGER&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line">   <span class="tag">&lt;<span class="name">split-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">new-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">split-permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">split-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">new-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">split-permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">split-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_CONTACTS&quot;</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">targetSdk</span>=<span class="string">&quot;16&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">new-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_CALL_LOG&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">split-permission</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.test.base&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.test.base.jar&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.test.mock&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.test.mock.jar&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">dependency</span>=<span class="string">&quot;android.test.base&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.test.runner&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.test.runner.jar&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">dependency</span>=<span class="string">&quot;android.test.base:android.test.mock&quot;</span> /&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- In BOOT_JARS historically, and now added to legacy applications. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.hidl.base-V1.0-java&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.hidl.base-V1.0-java.jar&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.hidl.manager-V1.0-java&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.hidl.manager-V1.0-java.jar&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">dependency</span>=<span class="string">&quot;android.hidl.base-V1.0-java&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上platform.xml中出现的标签种类则较为多样，它们的含义分别是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">platform.xml中出现的标签种类则较为多样，它们的含义分别是：</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span>&gt;</span>:根据name获取gid</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> &gt;</span>标签：把属性name所描述的权限赋予给<span class="tag">&lt;<span class="name">group</span>&gt;</span>标签中属性gid所表示的用户组，一个权限可以有一个或多个group对象，当一个APK授权于这个这个权限时，它同时属于这几个组</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span>&gt;</span>标签：把属性name所描述的权限赋予给uid属性所表示的用户</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">split-permission</span>&gt;</span>标签：一个权限可以扩展出一个新的权限</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span>&gt;</span>标签：除framework中动态库以外的，所有系统会自动加载的动态库</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">feature</span>&gt;</span>标签：硬件支持的一些feature</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">oem-permission</span>&gt;</span>标签：oem厂商自己定义的一些权限</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">privapp-permission</span>&gt;</span>标签：来自system、vendor、product、system_ext的privapp权限分别存储，这是防止供应商分区中的xml授权于系统分区中的私有应用权限</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">最后将上面xml解析出来的数据做如下存储：</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span>&gt;</span>标签gid属性的值会存放在mGlobalGids数组中;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span>&gt;</span>标签,解析得到的值会存放在mPermissions集合中;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span>&gt;</span>标签解析得到的值会存放在mSystemPermissions中;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">split-permission</span>&gt;</span>存储在mSplitPermissions</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span>&gt;</span>标签解析得到的值会存放在mSharedLibraries中;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">feature</span>&gt;</span>存储在mAvaliableFeatures</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">oem-permission</span>&gt;</span>存储在mOemPermissions</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">privapp-permission</span>&gt;</span>会根据不同的存储路径，分别存储在mVendorPrivAppPermissions、mProductPrivAppPermissions、mSystemExtPrivAppPermissions、mPrivAppPermissions</span><br></pre></td></tr></table></figure>



<p><strong>总结：权限扫描，扫描/system/etc/permissions中的xml，存入相应的结构体中，供之后权限管理使用</strong></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6/" rel="tag"># 系统机制</a>
              <a href="/tags/PKMS/" rel="tag"># PKMS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/08/26/android_layout_draw_performace/" rel="prev" title="Android性能优化-布局与绘制优化">
                  <i class="fa fa-chevron-left"></i> Android性能优化-布局与绘制优化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/09/01/android_wms/" rel="next" title="Android WMS核心分析">
                  Android WMS核心分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小贾</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
