<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;always&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script><script src="/js/config.js"></script>
<meta name="description" content="ANR是应用开发中典型的问题类型，直译为“应用程序无响应”。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android ANR原理分析及解决办法">
<meta property="og:url" content="http://example.com/2019/11/03/android_anr_analyze/index.html">
<meta property="og:site_name" content="小贾的博客">
<meta property="og:description" content="ANR是应用开发中典型的问题类型，直译为“应用程序无响应”。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/android_anr_analyze01.png">
<meta property="og:image" content="http://example.com/images/android_anr_analyze02.png">
<meta property="article:published_time" content="2019-11-03T15:11:00.000Z">
<meta property="article:modified_time" content="2023-01-04T07:29:42.671Z">
<meta property="article:author" content="贾俊辉">
<meta property="article:tag" content="总结">
<meta property="article:tag" content="ANR">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/android_anr_analyze01.png">


<link rel="canonical" href="http://example.com/2019/11/03/android_anr_analyze/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2019&#x2F;11&#x2F;03&#x2F;android_anr_analyze&#x2F;&quot;,&quot;path&quot;:&quot;2019&#x2F;11&#x2F;03&#x2F;android_anr_analyze&#x2F;&quot;,&quot;title&quot;:&quot;Android ANR原理分析及解决办法&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Android ANR原理分析及解决办法 | 小贾的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">小贾的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ANR%E8%AF%B4%E6%98%8E%E5%92%8C%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.</span> <span class="nav-text">ANR说明和原因</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ANR%E7%9A%84%E9%81%BF%E5%85%8D%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="nav-number">2.</span> <span class="nav-text">ANR的避免与检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ANR%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">ANR分析方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ANR%E5%88%86%E6%9E%90%E5%8A%9E%E6%B3%95%E4%B8%80%EF%BC%9A%E7%9C%8Blogcat"><span class="nav-number">3.1.</span> <span class="nav-text">ANR分析办法一：看logcat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANR%E5%88%86%E6%9E%90%E5%8A%9E%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%9C%8Btrace%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">ANR分析办法二：看trace文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANR%E5%88%86%E6%9E%90%E5%8A%9E%E6%B3%95%E4%B8%89%EF%BC%9Ajava%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-number">3.3.</span> <span class="nav-text">ANR分析办法三：java线程调用分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANR%E5%88%86%E6%9E%90%E5%8A%9E%E6%B3%95%E5%9B%9B%EF%BC%9ADDMS%E5%88%86%E6%9E%90ANR%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.</span> <span class="nav-text">ANR分析办法四：DDMS分析ANR问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%A0%E6%88%90ANR%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">造成ANR的原因及解决办法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ANR%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">ANR源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Service%E9%80%A0%E6%88%90%E7%9A%84Service-Timeout"><span class="nav-number">5.1.</span> <span class="nav-text">Service造成的Service Timeout</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="nav-number">5.1.1.</span> <span class="nav-text">发送延时消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E5%85%A5%E7%9B%AE%E6%A0%87%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BAService"><span class="nav-number">5.1.2.</span> <span class="nav-text">进入目标进程的主线程创建Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E5%88%B0system-server%E6%89%A7%E8%A1%8C%E5%8F%96%E6%B6%88AMS-MainHandler%E7%9A%84%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="nav-number">5.1.3.</span> <span class="nav-text">回到system_server执行取消AMS.MainHandler的延时消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BroadcastReceiver%E9%80%A0%E6%88%90%E7%9A%84BroadcastQueue-Timeout"><span class="nav-number">5.2.</span> <span class="nav-text">BroadcastReceiver造成的BroadcastQueue Timeout</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E5%B9%BF%E6%92%AD%E5%87%BD%E6%95%B0-processNextBroadcast-%E4%B8%AD-broadcastTimeoutLocked-false-%E5%8F%91%E9%80%81%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="nav-number">5.2.1.</span> <span class="nav-text">处理广播函数 processNextBroadcast() 中 broadcastTimeoutLocked(false) 发送延时消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setBroadcastTimeoutLocked-long-timeoutTime-%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0timeoutTime%E6%98%AF%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E5%8A%A0%E4%B8%8A%E8%AE%BE%E5%AE%9A%E5%A5%BD%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%E3%80%82"><span class="nav-number">5.2.2.</span> <span class="nav-text">setBroadcastTimeoutLocked(long timeoutTime)函数的参数timeoutTime是当前时间加上设定好的超时时间。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8processNextBroadcast-%E8%BF%87%E7%A8%8B%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%AE%8CperformReceiveLocked%E5%90%8E%E8%B0%83%E7%94%A8cancelBroadcastTimeoutLocked"><span class="nav-number">5.2.3.</span> <span class="nav-text">在processNextBroadcast()过程，执行完performReceiveLocked后调用cancelBroadcastTimeoutLocked</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ContentProvider%E7%9A%84ContentProvider-Timeout"><span class="nav-number">5.3.</span> <span class="nav-text">ContentProvider的ContentProvider Timeout</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-ANR%E7%9A%84%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">6.</span> <span class="nav-text">Android ANR的信息收集</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="贾俊辉"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">贾俊辉</p>
  <div class="site-description" itemprop="description">Just do IT</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiajunhui" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiajunhui" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:junhui_jia@163.com" title="E-Mail → mailto:junhui_jia@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/jiajunhui" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/11/03/android_anr_analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="贾俊辉">
      <meta itemprop="description" content="Just do IT">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小贾的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android ANR原理分析及解决办法
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-03 23:11:00" itemprop="dateCreated datePublished" datetime="2019-11-03T23:11:00+08:00">2019-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ANR是应用开发中典型的问题类型，直译为“应用程序无响应”。</p>
<span id="more"></span>

<h1 id="ANR说明和原因"><a href="#ANR说明和原因" class="headerlink" title="ANR说明和原因"></a>ANR说明和原因</h1><p>ANR全称：<strong>Application Not Responding</strong>，也就是应用程序无响应。</p>
<p>Android系统中，**ActivityManagerService(简称AMS)<strong>和</strong>WindowManagerService(简称WMS)**会检测App的响应时间，如果App在特定时间无法相应屏幕触摸或键盘输入时间，或者特定事件没有处理完毕，就会出现ANR。</p>
<p>以下四个条件都可以造成ANR发生：</p>
<ul>
<li><strong>InputDispatching Timeout</strong>：5秒内无法响应屏幕触摸事件或键盘输入事件</li>
<li><strong>BroadcastQueue Timeout</strong> ：在执行前台广播（BroadcastReceiver）的onReceive()函数时10秒没有处理完成，后台为60秒。</li>
<li><strong>Service Timeout</strong> ：前台服务20秒内，后台服务在200秒内没有执行完毕。</li>
<li><strong>ContentProvider Timeout</strong> ：ContentProvider的publish在10s内没进行完。</li>
</ul>
<p>所以，尽量避免在主线程（UI线程）中作耗时操作。耗时操作就放到子线程中去执行。</p>
<h1 id="ANR的避免与检测"><a href="#ANR的避免与检测" class="headerlink" title="ANR的避免与检测"></a>ANR的避免与检测</h1><p>为了避免在开发中引入可能导致应用发生ANR的问题，除了切记不要在主线程中作耗时操作，我们也可以借助于一些工具来进行检测，从而更有效的避免ANR的引入。</p>
<p>StrictMode</p>
<p>严格模式StrictMode是Android SDK提供的一个用来检测代码中是否存在违规操作的工具类，StrictMode主要检测两大类问题。</p>
<p>线程策略 ThreadPolicy<br>detectCustomSlowCalls：检测自定义耗时操作<br>detectDiskReads：检测是否存在磁盘读取操作 detectDiskWrites：检测是否存在磁盘写入操作<br>detectNetWork：检测是否存在网络操作<br>虚拟机策略VmPolicy<br>detectActivityLeaks：检测是否存在Activity泄露<br>detectLeakedClosableObjects：检测是否存在未关闭的Closeable对象泄露<br>detectLeakedSqlLiteObjects：检测是否存在Sqlite对象泄露<br>setClassInstanceLimit：检测类实例个数是否超过限制</p>
<p>可以看到，ThreadPolicy可以用来检测可能催在的主线程耗时操作，需要注意的是我们只能在Debug版本中使用它，发布到市场上的版本要关闭掉。StrictMode的使用很简单，我们只需要在应用初始化的地方例如Application或者MainActivity类的onCreate方法中执行如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_login);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启线程模式</span></span><br><span class="line">    StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder()</span><br><span class="line">    .detectAll()</span><br><span class="line">    .penaltyLog()</span><br><span class="line">    .penaltyDialog() 打印logcat，当然也可以定位到dropbox，通过文件保存相应的log</span><br><span class="line">    .build());</span><br><span class="line">    <span class="comment">// 开启虚拟机模式</span></span><br><span class="line">    StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder()</span><br><span class="line">    .detectAll()</span><br><span class="line">    .penaltyLog()</span><br><span class="line">    .build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的初始化代码调用penaltyLog表示在Logcat中打印日志，调用detectAll方法表示启动所有的检测策略，我们也可以根据应用的具体要求只开启某些策略，语句如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder()</span><br><span class="line">    .detectDiskReads()</span><br><span class="line">    .detectDiskWrites()</span><br><span class="line">    .detectNetwork()</span><br><span class="line">    .penaltyLog()</span><br><span class="line">    .build());</span><br><span class="line"></span><br><span class="line">StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder()</span><br><span class="line">    .detectLeakedSqlLiteObjects()</span><br><span class="line">    .detectLeakedClosableObjects()</span><br><span class="line">    .detectActivityLeaks()</span><br><span class="line">    .penaltyLog()</span><br><span class="line">    .build());</span><br></pre></td></tr></table></figure>



<h1 id="ANR分析方法"><a href="#ANR分析方法" class="headerlink" title="ANR分析方法"></a>ANR分析方法</h1><p><strong>ANR示例</strong></p>
<p>生成一个按钮跳转到ANRTestActivity，在后者的onCreate()中主线程休眠20秒：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_anr_test);</span><br><span class="line">    <span class="comment">// 这是Android提供线程休眠函数，与Thread.sleep()最大的区别是</span></span><br><span class="line">    <span class="comment">// 该使用该函数不会抛出InterruptedException异常。</span></span><br><span class="line">    SystemClock.sleep(<span class="number">20</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进入ANRTestActivity后黑屏一段时间，大概有七八秒，终于弹出了ANR异常。</p>
<p><img src="/images/android_anr_analyze01.png" alt="img"></p>
<h2 id="ANR分析办法一：看logcat"><a href="#ANR分析办法一：看logcat" class="headerlink" title="ANR分析办法一：看logcat"></a>ANR分析办法一：看logcat</h2><p>产生ANR后，看下Log：</p>
<p><img src="/images/android_anr_analyze02.png" alt="img"></p>
<p>可以看到logcat清晰地记录了ANR发生的时间，以及线程的tid和一句话概括原因：WaitingInMainSignalCatcherLoop，大概意思为主线程等待异常。<br>最后一句The application may be doing too much work on its main thread.告知可能在主线程做了太多的工作。</p>
<h2 id="ANR分析办法二：看trace文件"><a href="#ANR分析办法二：看trace文件" class="headerlink" title="ANR分析办法二：看trace文件"></a>ANR分析办法二：看trace文件</h2><p>刚才的log有第二句Wrote stack traces to ‘/data/anr/traces.txt’，说明ANR异常已经输出到traces.txt文件，使用adb命令把这个文件从手机里导出来：</p>
<ol>
<li>cd到adb.exe所在的目录，也就是<strong>Android SDK</strong>的platform-tools目录，例如：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd D:\Android\AndroidSdk\platform-tools</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此外，除了Windows的cmd以外，还可以使用AndroidStudio的Terminal来输入adb命令。</p>
</blockquote>
<p>2.到指定目录后执行以下adb命令导出traces.txt文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull /data/anr/traces.txt</span><br></pre></td></tr></table></figure>

<p>traces.txt默认会被导出到<strong>Android SDK</strong>的<strong>\platform-tools</strong>目录。一般来说traces.txt文件记录的东西会比较多，分析的时候需要有针对性地去找相关记录。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">----- pid 23346 at 2017-11-07 11:33:57 -----  ----&gt; 进程id和ANR产生时间</span><br><span class="line">Cmd line: com.sky.myjavatest</span><br><span class="line">Build fingerprint: &#x27;google/marlin/marlin:8.0.0/OPR3.170623.007/4286350:user/release-keys&#x27;</span><br><span class="line">ABI: &#x27;arm64&#x27;</span><br><span class="line">Build type: optimized</span><br><span class="line">Zygote loaded classes=4681 post zygote classes=106</span><br><span class="line">Intern table: 42675 strong; 137 weak</span><br><span class="line">JNI: CheckJNI is on; globals=526 (plus 22 weak)</span><br><span class="line">Libraries: /system/lib64/libandroid.so /system/lib64/libcompiler<span class="built_in">_</span>rt.so </span><br><span class="line">/system/lib64/libjavacrypto.so</span><br><span class="line">/system/lib64/libjnigraphics.so /system/lib64/libmedia<span class="built_in">_</span>jni.so /system/lib64/libsoundpool.so</span><br><span class="line">/system/lib64/libwebviewchromium<span class="built_in">_</span>loader.so libjavacore.so libopenjdk.so (9)</span><br><span class="line">Heap: 22<span class="comment">% free, 1478KB/1896KB; 21881 objects    ----&gt; 内存使用情况</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&quot;main&quot; prio=5 tid=1 Sleeping    ----&gt; 原因为Sleeping</span><br><span class="line">  | group=&quot;main&quot; sCount=1 dsCount=0 flags=1 obj=0x733d0670 self=0x74a4abea00</span><br><span class="line">  | sysTid=23346 nice=-10 cgrp=default sched=0/0 handle=0x74a91ab9b0</span><br><span class="line">  | state=S schedstat=( 391462128 82838177 354 ) utm=33 stm=4 core=3 HZ=100</span><br><span class="line">  | stack=0x7fe6fac000-0x7fe6fae000 stackSize=8MB</span><br><span class="line">  | held mutexes=</span><br><span class="line">  at java.lang.Thread.sleep(Native method)</span><br><span class="line">  - sleeping on &lt;0x053fd2c2&gt; (a java.lang.Object)</span><br><span class="line">  at java.lang.Thread.sleep(Thread.java:373)</span><br><span class="line">  - locked &lt;0x053fd2c2&gt; (a java.lang.Object)</span><br><span class="line">  at java.lang.Thread.sleep(Thread.java:314)</span><br><span class="line">  at android.os.SystemClock.sleep(SystemClock.java:122)</span><br><span class="line">  at com.sky.myjavatest.ANRTestActivity.onCreate(ANRTestActivity.java:20) ----&gt; 产生ANR的包名以及具体行数</span><br><span class="line">  at android.app.Activity.performCreate(Activity.java:6975)</span><br><span class="line">  at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1213)</span><br><span class="line">  at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2770)</span><br><span class="line">  at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2892)</span><br><span class="line">  at android.app.ActivityThread.-wrap11(ActivityThread.java:-1)</span><br><span class="line">  at android.app.ActivityThread<span class="built_in">$</span>H.handleMessage(ActivityThread.java:1593)</span><br><span class="line">  at android.os.Handler.dispatchMessage(Handler.java:105)</span><br><span class="line">  at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">  at android.app.ActivityThread.main(ActivityThread.java:6541)</span><br><span class="line">  at java.lang.reflect.Method.invoke(Native method)</span><br><span class="line">  at com.android.internal.os.Zygote<span class="built_in">$</span>MethodAndArgsCaller.run(Zygote.java:240)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767)</span><br></pre></td></tr></table></figure>

<p>在文件中使用 ctrl + F 查找包名可以快速定位相关代码。<br>通过上方log可以看出相关问题：</p>
<ul>
<li>进程id和包名：pid 23346 com.sky.myjavatest</li>
<li>造成ANR的原因：Sleeping</li>
<li>造成ANR的具体行数：ANRTestActivity.java:20类的第20行</li>
</ul>
<p><strong>特别注意：产生新的ANR，原来的 traces.txt 文件会被覆盖。</strong></p>
<h2 id="ANR分析办法三：java线程调用分析"><a href="#ANR分析办法三：java线程调用分析" class="headerlink" title="ANR分析办法三：java线程调用分析"></a>ANR分析办法三：java线程调用分析</h2><p>通过JDK提供的命令可以帮助分析和调试Java应用，命令为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack &#123;pid&#125;</span><br></pre></td></tr></table></figure>

<p>其中pid可以通过jps命令获得，jps命令会列出当前系统中运行的所有Java虚拟机进程，比如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7266</span> Test</span><br><span class="line"><span class="number">7267</span> Jps</span><br></pre></td></tr></table></figure>

<h2 id="ANR分析办法四：DDMS分析ANR问题"><a href="#ANR分析办法四：DDMS分析ANR问题" class="headerlink" title="ANR分析办法四：DDMS分析ANR问题"></a>ANR分析办法四：DDMS分析ANR问题</h2><ul>
<li>使用DDMS——Update Threads工具</li>
<li>阅读Update Threads的输出</li>
</ul>
<h1 id="造成ANR的原因及解决办法"><a href="#造成ANR的原因及解决办法" class="headerlink" title="造成ANR的原因及解决办法"></a>造成ANR的原因及解决办法</h1><p>上面例子只是由于简单的主线程耗时操作造成的ANR，造成ANR的原因还有很多：</p>
<ul>
<li>主线程阻塞或主线程数据读取</li>
</ul>
<blockquote>
<p>解决办法：避免死锁的出现，使用子线程来处理耗时操作或阻塞任务。尽量避免在主线程query provider、不要滥用SharePreferenceS</p>
</blockquote>
<ul>
<li>CPU满负荷，I/O阻塞</li>
</ul>
<blockquote>
<p>解决办法：文件读写或数据库操作放在子线程异步操作。</p>
</blockquote>
<ul>
<li>内存不足</li>
</ul>
<blockquote>
<p>解决办法：AndroidManifest.xml文件<applicatiion>中可以设置 android:largeHeap=”true”，以此增大App使用内存。不过<strong>不建议使用此法</strong>，从根本上防止内存泄漏，优化内存使用才是正道。</p>
</blockquote>
<ul>
<li>各大组件ANR</li>
</ul>
<blockquote>
<p>各大组件生命周期中也应避免耗时操作，注意BroadcastReciever的onRecieve()、后台Service和ContentProvider也不要执行太长时间的任务。</p>
</blockquote>
<h1 id="ANR源码分析"><a href="#ANR源码分析" class="headerlink" title="ANR源码分析"></a>ANR源码分析</h1><h2 id="Service造成的Service-Timeout"><a href="#Service造成的Service-Timeout" class="headerlink" title="Service造成的Service Timeout"></a>Service造成的Service Timeout</h2><p><strong>Service Timeout</strong>是位于**”ActivityManager”**线程中的AMS.MainHandler收到SERVICE_TIMEOUT_MSG消息时触发。</p>
<h3 id="发送延时消息"><a href="#发送延时消息" class="headerlink" title="发送延时消息"></a>发送延时消息</h3><p><strong>Service</strong>进程attach到system_server进程的过程中会调用realStartServiceLocked，紧接着mAm.mHandler.sendMessageAtTime()来发送一个延时消息，延时的时常是定义好的，如前台<strong>Service</strong>的20秒。<strong>ActivityManager</strong>线程中的<strong>AMS.MainHandler</strong>收到SERVICE_TIMEOUT_MSG消息时会触发。</p>
<p><strong>AS.realStartServiceLocked</strong></p>
<blockquote>
<p>ActiveServices.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="params"><span class="function">        ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//发送delay消息(SERVICE_TIMEOUT_MSG)</span></span><br><span class="line">    bumpServiceExecutingLocked(r, execInFg, <span class="string">&quot;create&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//最终执行服务的onCreate()方法</span></span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">        mAm.appDiedLocked(app);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AS.bumpServiceExecutingLocked</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bumpServiceExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> fg, String why)</span> </span>&#123;</span><br><span class="line">    ... </span><br><span class="line">    scheduleServiceTimeoutLocked(r.app);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleServiceTimeoutLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (proc.executingServices.size() == <span class="number">0</span> || proc.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">    Message msg = mAm.mHandler.obtainMessage(</span><br><span class="line">            ActivityManagerService.SERVICE_TIMEOUT_MSG);</span><br><span class="line">    msg.obj = proc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当超时后仍没有remove该SERVICE_TIMEOUT_MSG消息，则执行service Timeout流程</span></span><br><span class="line">    mAm.mHandler.sendMessageAtTime(msg,</span><br><span class="line">        proc.execServicesFg ? (now+SERVICE_TIMEOUT) : (now+ SERVICE_BACKGROUND_TIMEOUT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="进入目标进程的主线程创建Service"><a href="#进入目标进程的主线程创建Service" class="headerlink" title="进入目标进程的主线程创建Service"></a>进入目标进程的主线程创建Service</h3><p><strong>经过Binder等层层调用进入目标进程的主线程 handleCreateService(CreateServiceData data)。</strong></p>
<blockquote>
<p>ActivityThread.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">        Service service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建ContextImpl对象</span></span><br><span class="line">            ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">            context.setOuterContext(service);</span><br><span class="line">            <span class="comment">//创建Application对象</span></span><br><span class="line">            Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">            service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">                    ActivityManagerNative.getDefault());</span><br><span class="line">            <span class="comment">//调用服务onCreate()方法 </span></span><br><span class="line">            service.onCreate();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取消AMS.MainHandler的延时消息</span></span><br><span class="line">            ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                    data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个方法中会创建目标服务对象，以及回调常用的<strong>Service</strong>的onCreate()方法，紧接着通过serviceDoneExecuting()回到system_server执行取消AMS.MainHandler的延时消息。</p>
<h3 id="回到system-server执行取消AMS-MainHandler的延时消息"><a href="#回到system-server执行取消AMS-MainHandler的延时消息" class="headerlink" title="回到system_server执行取消AMS.MainHandler的延时消息"></a>回到system_server执行取消AMS.MainHandler的延时消息</h3><p><strong>AS.serviceDoneExecutingLocked</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line">            <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//当前服务所在进程中没有正在执行的service</span></span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法中Service逻辑处理完成则移除之前延时的消息SERVICE_TIMEOUT_MSG。如果没有执行完毕不调用这个方法，则超时后会发出SERVICE_TIMEOUT_MSG来告知ANR发生。</p>
<h2 id="BroadcastReceiver造成的BroadcastQueue-Timeout"><a href="#BroadcastReceiver造成的BroadcastQueue-Timeout" class="headerlink" title="BroadcastReceiver造成的BroadcastQueue Timeout"></a>BroadcastReceiver造成的BroadcastQueue Timeout</h2><blockquote>
<p>BroadcastReceiver Timeout是位于”ActivityManager”线程中的BroadcastQueue.BroadcastHandler收到BROADCAST_TIMEOUT_MSG消息时触发。</p>
</blockquote>
<h3 id="处理广播函数-processNextBroadcast-中-broadcastTimeoutLocked-false-发送延时消息"><a href="#处理广播函数-processNextBroadcast-中-broadcastTimeoutLocked-false-发送延时消息" class="headerlink" title="处理广播函数 processNextBroadcast() 中 broadcastTimeoutLocked(false) 发送延时消息"></a>处理广播函数 processNextBroadcast() 中 broadcastTimeoutLocked(false) 发送延时消息</h3><p>广播处理顺序为先处理并行广播，再处理当前有序广播。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mService) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 处理当前有序广播</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            r = mOrderedBroadcasts.get(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//获取所有该广播所有的接收者</span></span><br><span class="line">            <span class="keyword">int</span> numReceivers = (r.receivers != <span class="keyword">null</span>) ? r.receivers.size() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (mService.mProcessesReady &amp;&amp; r.dispatchTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">                <span class="keyword">if</span> ((numReceivers &gt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">                        (now &gt; r.dispatchTime + (<span class="number">2</span>*mTimeoutPeriod*numReceivers))) &#123;</span><br><span class="line">                    <span class="comment">//step 1\. 发送延时消息，这个函数处理了很多事情，比如广播处理超时结束广播</span></span><br><span class="line">                    broadcastTimeoutLocked(<span class="keyword">false</span>);</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.receivers == <span class="keyword">null</span> || r.nextReceiver &gt;= numReceivers</span><br><span class="line">                    || r.resultAbort || forceReceive) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//2\. 处理广播消息消息</span></span><br><span class="line">                    performReceiveLocked(r.callerApp, r.resultTo,</span><br><span class="line">                        <span class="keyword">new</span> Intent(r.intent), r.resultCode,</span><br><span class="line">                        r.resultData, r.resultExtras, <span class="keyword">false</span>, <span class="keyword">false</span>, r.userId);</span><br><span class="line">                    r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3\. 取消广播超时ANR消息</span></span><br><span class="line">                cancelBroadcastTimeoutLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (r == <span class="keyword">null</span>);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取下条有序广播</span></span><br><span class="line">        r.receiverTime = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (!mPendingBroadcastTimeoutMessage) &#123;</span><br><span class="line">            <span class="keyword">long</span> timeoutTime = r.receiverTime + mTimeoutPeriod;</span><br><span class="line">            <span class="comment">//设置广播超时</span></span><br><span class="line">            setBroadcastTimeoutLocked(timeoutTime);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>上文的step 1. broadcastTimeoutLocked(false)函数：记录时间信息并调用函数设置发送延时消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">broadcastTimeoutLocked</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (fromMsg) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mDidDexOpt) &#123;</span><br><span class="line">                <span class="comment">// Delay timeouts until dexopt finishes.</span></span><br><span class="line">                mService.mDidDexOpt = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">long</span> timeoutTime = SystemClock.uptimeMillis() + mTimeoutPeriod;</span><br><span class="line">                setBroadcastTimeoutLocked(timeoutTime);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!mService.mProcessesReady) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> timeoutTime = r.receiverTime + mTimeoutPeriod;</span><br><span class="line">            <span class="keyword">if</span> (timeoutTime &gt; now) &#123;</span><br><span class="line">                <span class="comment">// step 2</span></span><br><span class="line">                setBroadcastTimeoutLocked(timeoutTime);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>上文的step 2.setBroadcastTimeoutLocked函数： 设置广播超时具体操作，同样是发送延时消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setBroadcastTimeoutLocked</span><span class="params">(<span class="keyword">long</span> timeoutTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! mPendingBroadcastTimeoutMessage) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(BROADCAST_TIMEOUT_MSG, <span class="keyword">this</span>);</span><br><span class="line">        mHandler.sendMessageAtTime(msg, timeoutTime);</span><br><span class="line">        mPendingBroadcastTimeoutMessage = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="setBroadcastTimeoutLocked-long-timeoutTime-函数的参数timeoutTime是当前时间加上设定好的超时时间。"><a href="#setBroadcastTimeoutLocked-long-timeoutTime-函数的参数timeoutTime是当前时间加上设定好的超时时间。" class="headerlink" title="setBroadcastTimeoutLocked(long timeoutTime)函数的参数timeoutTime是当前时间加上设定好的超时时间。"></a>setBroadcastTimeoutLocked(long timeoutTime)函数的参数timeoutTime是当前时间加上设定好的超时时间。</h3><p>也就是上文的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> timeoutTime = SystemClock.uptimeMillis() + mTimeoutPeriod;</span><br></pre></td></tr></table></figure>

<p>mTimeoutPeriod 也就是前台队列的10s和后台队列的60s。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_FG_TIMEOUT = <span class="number">10</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_BG_TIMEOUT = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    ...</span><br><span class="line">    mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">&quot;foreground&quot;</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">    mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">&quot;background&quot;</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在processNextBroadcast-过程，执行完performReceiveLocked后调用cancelBroadcastTimeoutLocked"><a href="#在processNextBroadcast-过程，执行完performReceiveLocked后调用cancelBroadcastTimeoutLocked" class="headerlink" title="在processNextBroadcast()过程，执行完performReceiveLocked后调用cancelBroadcastTimeoutLocked"></a>在processNextBroadcast()过程，执行完performReceiveLocked后调用cancelBroadcastTimeoutLocked</h3><p><strong>cancelBroadcastTimeoutLocked ：处理广播消息函数 processNextBroadcast() 中 performReceiveLocked() 处理广播消息完毕则调用 cancelBroadcastTimeoutLocked() 取消超时消息。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">cancelBroadcastTimeoutLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPendingBroadcastTimeoutMessage) &#123;</span><br><span class="line">        mHandler.removeMessages(BROADCAST_TIMEOUT_MSG, <span class="keyword">this</span>);</span><br><span class="line">        mPendingBroadcastTimeoutMessage = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ContentProvider的ContentProvider-Timeout"><a href="#ContentProvider的ContentProvider-Timeout" class="headerlink" title="ContentProvider的ContentProvider Timeout"></a>ContentProvider的ContentProvider Timeout</h2><blockquote>
<p>ContentProvider Timeout是位于”ActivityManager”线程中的AMS.MainHandler收到CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG消息时触发。</p>
</blockquote>
<h1 id="Android-ANR的信息收集"><a href="#Android-ANR的信息收集" class="headerlink" title="Android ANR的信息收集"></a>Android ANR的信息收集</h1><p>无论是四大组件或者进程等只要发生ANR，最终都会调用AMS.appNotResponding()方法。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%80%BB%E7%BB%93/" rel="tag"># 总结</a>
              <a href="/tags/ANR/" rel="tag"># ANR</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/10/09/android_choreographer/" rel="prev" title="Android图形系统-Choreographer">
                  <i class="fa fa-chevron-left"></i> Android图形系统-Choreographer
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/11/24/android_hot_fix/" rel="next" title="Android 热修复方案和原理">
                  Android 热修复方案和原理 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">贾俊辉</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
