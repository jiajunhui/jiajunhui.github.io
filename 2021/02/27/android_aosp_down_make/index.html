<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;always&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script><script src="/js/config.js"></script>
<meta name="description" content="开启新世界，开始搞机啦，第一步就是先整系统源码。">
<meta property="og:type" content="article">
<meta property="og:title" content="AOSP-下载、编译、调试、刷机">
<meta property="og:url" content="http://example.com/2021/02/27/android_aosp_down_make/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="开启新世界，开始搞机啦，第一步就是先整系统源码。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make06.png">
<meta property="og:image" content="https://math.jianshu.com/math?formula=HOME/.jack-settings%E5%92%8C">
<meta property="og:image" content="https://math.jianshu.com/math?formula=HOME/.jack-server/logs/jack-server-0-0.log%EF%BC%9A%20%E5%8F%91%E7%8E%B0%E6%98%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90%E4%B8%8D%E5%AF%B9%E9%80%A0%E6%88%90%E7%9A%84%EF%BC%8C%E6%8A%8A%E6%96%87%E4%BB%B6">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make07.png">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make01.png">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make02.png">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make03.png">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make04.png">
<meta property="og:image" content="http://example.com/images/android_aosp_down_make05.png">
<meta property="article:published_time" content="2021-02-27T15:12:00.000Z">
<meta property="article:modified_time" content="2023-03-17T15:00:10.674Z">
<meta property="article:author" content="小贾">
<meta property="article:tag" content="AOSP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/android_aosp_down_make06.png">


<link rel="canonical" href="http://example.com/2021/02/27/android_aosp_down_make/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;02&#x2F;27&#x2F;android_aosp_down_make&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;02&#x2F;27&#x2F;android_aosp_down_make&#x2F;&quot;,&quot;title&quot;:&quot;AOSP-下载、编译、调试、刷机&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>AOSP-下载、编译、调试、刷机 | 奔跑的蜗牛</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">奔跑的蜗牛</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDAOSP%E6%BA%90%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">下载AOSP源码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Git"><span class="nav-number">2.1.</span> <span class="nav-text">安装Git</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Python%E7%8E%AF%E5%A2%83"><span class="nav-number">2.2.</span> <span class="nav-text">安装Python环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E6%9E%9CUbuntu%E8%87%AA%E5%B8%A6Python%E7%8E%AF%E5%A2%83%E7%9A%84%E8%AF%9D"><span class="nav-number">2.2.1.</span> <span class="nav-text">如果Ubuntu自带Python环境的话</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85repo%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">安装repo及配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%8C%E6%AD%A5%E6%BA%90%E7%A0%81"><span class="nav-number">2.4.</span> <span class="nav-text">初始化同步源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%8D%A1%E6%AD%BB"><span class="nav-number">2.5.</span> <span class="nav-text">防止下载源码执行脚本卡死</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOSP%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">AOSP源码目录结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91"><span class="nav-number">4.</span> <span class="nav-text">AOSP源码编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%89%8D%E5%87%86%E5%A4%87"><span class="nav-number">4.1.</span> <span class="nav-text">编译前准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E8%AE%BE%E7%BD%AE"><span class="nav-number">4.1.1.</span> <span class="nav-text">交换空间设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4"><span class="nav-number">4.1.2.</span> <span class="nav-text">配置交换空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E6%9C%AA%E4%BD%BF%E7%94%A8"><span class="nav-number">4.1.3.</span> <span class="nav-text">交换空间未使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEjava%E7%8E%AF%E5%A2%83"><span class="nav-number">4.2.</span> <span class="nav-text">配置java环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E5%85%A5AOSP%E6%96%87%E4%BB%B6%E5%A4%B9%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91"><span class="nav-number">4.3.</span> <span class="nav-text">进入AOSP文件夹进行编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span class="nav-number">4.4.</span> <span class="nav-text">编译错误解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E5%B0%91libncurses-so-5"><span class="nav-number">4.4.1.</span> <span class="nav-text">缺少libncurses.so.5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E5%B0%91M4"><span class="nav-number">4.4.2.</span> <span class="nav-text">缺少M4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%BB%E9%99%A4%E6%89%80%E6%9C%89%E6%9C%AC%E5%9C%B0%E5%8C%96%E8%AE%BE%E7%BD%AE"><span class="nav-number">4.4.3.</span> <span class="nav-text">去除所有本地化设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jack-server%E9%97%AE%E9%A2%98"><span class="nav-number">4.4.4.</span> <span class="nav-text">jack-server问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xmllint%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">4.4.5.</span> <span class="nav-text">xmllint的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3"><span class="nav-number">4.4.6.</span> <span class="nav-text">编译内存不足</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="nav-number">5.</span> <span class="nav-text">运行模拟器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="nav-number">5.1.</span> <span class="nav-text">启动模拟器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%A4%B1%E8%B4%A5"><span class="nav-number">5.2.</span> <span class="nav-text">启动模拟器失败</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#libncurses-so-5%E7%BC%BA%E5%B0%91"><span class="nav-number">5.2.1.</span> <span class="nav-text">libncurses.so.5缺少</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E5%B0%91%E6%96%87%E4%BB%B6userdata-qemu-img"><span class="nav-number">5.2.2.</span> <span class="nav-text">缺少文件userdata-qemu.img</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E7%95%8C%E9%9D%A2%E4%B8%80%E7%9B%B4%E5%A4%84%E4%BA%8Ephone-is-starting"><span class="nav-number">5.2.3.</span> <span class="nav-text">模拟器启动后界面一直处于phone is starting</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E6%9F%90%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="nav-number">6.</span> <span class="nav-text">AOSP源码编译某个单独的模块</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%BA%90%E7%A0%81%E5%88%B0AndroidStudio"><span class="nav-number">7.</span> <span class="nav-text">导入源码到AndroidStudio</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91idegen%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%9F%E6%88%90IDE%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6"><span class="nav-number">7.1.</span> <span class="nav-text">编译idegen模块，生成IDE项目文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%BA%90%E7%A0%81%E5%88%B0AndroidStudio-1"><span class="nav-number">7.2.</span> <span class="nav-text">导入源码到AndroidStudio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEAS"><span class="nav-number">7.2.1.</span> <span class="nav-text">配置AS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%BA%90%E7%A0%81"><span class="nav-number">7.2.2.</span> <span class="nav-text">导入源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-number">7.2.3.</span> <span class="nav-text">排除模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%BA%90%E7%A0%81%E6%AD%A3%E7%A1%AE%E8%B7%B3%E8%BD%AC"><span class="nav-number">7.2.4.</span> <span class="nav-text">配置源码正确跳转</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%9A%E8%BF%87AS%E8%B0%83%E8%AF%95%E6%BA%90%E7%A0%81"><span class="nav-number">8.</span> <span class="nav-text">通过AS调试源码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%BC%80%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="nav-number">8.1.</span> <span class="nav-text">打开模拟器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android%E5%88%B7%E6%9C%BA%E7%9F%A5%E8%AF%86"><span class="nav-number">9.</span> <span class="nav-text">Android刷机知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BootLoader"><span class="nav-number">9.1.</span> <span class="nav-text">BootLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FastBoot"><span class="nav-number">9.2.</span> <span class="nav-text">FastBoot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fastboot-bootloader-%E6%A8%A1%E5%BC%8F%E6%80%8E%E4%B9%88%E8%BF%9B%E5%85%A5%EF%BC%9F"><span class="nav-number">9.2.1.</span> <span class="nav-text">fastboot(bootloader)模式怎么进入？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastboot%E5%91%BD%E4%BB%A4"><span class="nav-number">9.2.2.</span> <span class="nav-text">fastboot命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recovery"><span class="nav-number">9.3.</span> <span class="nav-text">Recovery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E5%88%B7%E5%92%8C%E5%8D%A1%E5%88%B7"><span class="nav-number">9.4.</span> <span class="nav-text">线刷和卡刷</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%8B%E6%9C%BA%E7%A1%AC%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9F%A5%E8%AF%86"><span class="nav-number">10.</span> <span class="nav-text">手机硬件驱动知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">10.1.</span> <span class="nav-text">硬件驱动的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E7%A1%AC%E4%BB%B6%E9%A9%B1%E5%8A%A8"><span class="nav-number">10.2.</span> <span class="nav-text">如何添加硬件驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84%E9%A9%B1%E5%8A%A8"><span class="nav-number">10.2.1.</span> <span class="nav-text">下载对应的驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E9%A9%B1%E5%8A%A8"><span class="nav-number">10.2.2.</span> <span class="nav-text">生成驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%B8%A6%E6%9C%89%E9%A9%B1%E5%8A%A8%E7%9A%84AOSP"><span class="nav-number">10.2.3.</span> <span class="nav-text">编译带有驱动的AOSP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ROM%E7%BC%96%E8%AF%91%E5%8F%8A%E7%83%A7%E5%BD%95"><span class="nav-number">11.</span> <span class="nav-text">ROM编译及烧录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9C%9F%E6%9C%BA%E9%A9%B1%E5%8A%A8%E4%B8%8B%E8%BD%BD"><span class="nav-number">11.1.</span> <span class="nav-text">真机驱动下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%9C%9F%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%88%B0AOSP"><span class="nav-number">11.2.</span> <span class="nav-text">配置真机驱动到AOSP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91Rom"><span class="nav-number">11.3.</span> <span class="nav-text">编译Rom</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%83%A7%E5%BD%95Rom%E5%88%B0%E6%89%8B%E6%9C%BA"><span class="nav-number">11.4.</span> <span class="nav-text">烧录Rom到手机</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小贾"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">小贾</p>
  <div class="site-description" itemprop="description">Just do IT</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">88</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiajunhui" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiajunhui" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:junhui_jia@163.com" title="E-Mail → mailto:junhui_jia@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/jiajunhui" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/27/android_aosp_down_make/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="小贾">
      <meta itemprop="description" content="Just do IT">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="奔跑的蜗牛">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AOSP-下载、编译、调试、刷机
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-27 23:12:00" itemprop="dateCreated datePublished" datetime="2021-02-27T23:12:00+08:00">2021-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android系统开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>开启新世界，开始搞机啦，第一步就是先整系统源码。</p>
<span id="more"></span>

<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul>
<li><p>基于Ubuntu系统下的操作（Linux和MacOS也可以）。</p>
</li>
<li><p>Ubuntu设置中设置为永不休眠。</p>
</li>
<li><p>分配大一点的存储空间，至少200G（推荐500G+）。</p>
</li>
</ul>
<h1 id="下载AOSP源码"><a href="#下载AOSP源码" class="headerlink" title="下载AOSP源码"></a>下载AOSP源码</h1><h2 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h2><p>用于下载和管理源码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>

<p>安装依赖工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git-core libssl-dev libffi-dev gnupg flex bison gperf build-essential zip curl zlib1g-dev</span><br><span class="line">gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev libz-dev ccache libgl1-</span><br><span class="line">mesa-dev libxml2-utils xsltproc unzip</span><br></pre></td></tr></table></figure>

<p>接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:$PATH</span><br></pre></td></tr></table></figure>

<p>然后初始化Git，邮箱和用户名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email &quot;xxx@gmail.com&quot;</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br></pre></td></tr></table></figure>

<h2 id="安装Python环境"><a href="#安装Python环境" class="headerlink" title="安装Python环境"></a>安装Python环境</h2><p>下载Python3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Downloads</span><br><span class="line">wget https://www.python.org/ftp/python/3.7.1/Python-3.7.1.tgz</span><br></pre></td></tr></table></figure>

<p>解压Python3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf Python-3.7.1.tgz</span><br></pre></td></tr></table></figure>

<p>编译与安装Python3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>配置Python版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 2</span><br><span class="line">sudo update-alternatives --install /usr/bin/python python python3的安装地址</span><br><span class="line">(/usr/local/bin/python3.7) 3(权重号)</span><br></pre></td></tr></table></figure>

<p>选择Python版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --config python</span><br></pre></td></tr></table></figure>

<h3 id="如果Ubuntu自带Python环境的话"><a href="#如果Ubuntu自带Python环境的话" class="headerlink" title="如果Ubuntu自带Python环境的话"></a>如果Ubuntu自带Python环境的话</h3><p>已有Python环境时可能会遇到这个错误</p>
<p><code>/usr/bin/env: ‘python’: No such file or directory</code></p>
<p>首先，检查Python环境，使用python/python2/python3 –version查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 --version</span><br></pre></td></tr></table></figure>

<p>查找Python安装位置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whereis python3</span><br></pre></td></tr></table></figure>

<p>为其创建符号连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure>

<h2 id="安装repo及配置"><a href="#安装repo及配置" class="headerlink" title="安装repo及配置"></a>安装repo及配置</h2><p>repo 是一个python 脚本(所以我们上面要配置Python环境)，因为Android源码包含数百个git库，简化帮助管理git Android版本库的工具。</p>
<p>安装curl下载的库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install curl</span><br></pre></td></tr></table></figure>

<p>下载repo并设置可以运行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure>

<p>添加下载源</p>
<p>google 的AOSP 的话，因为FQ和数据量太大，且需要需要翻墙影响速度，因此优先考虑国内的镜像(本文使用的是清华的源)。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export REPO_URL=&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="初始化同步源码"><a href="#初始化同步源码" class="headerlink" title="初始化同步源码"></a>初始化同步源码</h2><p>第一次同步数据量特别大，如果网络不稳定，中间失败就要从头再来了。所以推荐使用打包的 AOSP 镜像，为一个 tar 包，大约 200G（单文件 200G，注意你的磁盘格式要支持）。这样你 就可以通过 HTTP(S) 的方式下载，该方法支持断点续传。</p>
<p>下载地址 <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar">https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar</a></p>
<p>下载完成后记得根据 checksum.txt 的内容校验一下。</p>
<p>由于所有代码都是从隐藏的 <code>.repo</code> 目录中 checkout 出来的，所以我们只保留了 <code>.repo</code> 目录，下载后解压 再 <code>repo sync</code> 一遍即可得到完整的目录。</p>
<p>使用方法如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xf aosp-latest.tar</span><br><span class="line">cd AOSP   # 解压得到的 AOSP 工程目录</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这时 ls 的话什么也看不到，因为只有一个隐藏的 .repo 目录</span></span><br><span class="line">repo sync # 正常同步一遍即可得到完整目录</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或 repo sync -l 仅checkout代码</span></span><br></pre></td></tr></table></figure>

<p>此后，每次只需运行 <code>repo sync</code> 即可保持同步。 </p>
<p>同步代码过程中如果报错，进入 <code>aosp/.repo/repo$</code></p>
<p><code>git status</code>查看是否已经落后远程分支，如果落后，git pull，然后再同步一次代码。</p>
<p>查看分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd .repo/manifests </span><br><span class="line">git branch -a</span><br></pre></td></tr></table></figure>

<p>查找并切换到对应的分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -b android-12.0.0_r30</span><br><span class="line">repo sync # 正常同步一遍即可得到完整目录</span><br></pre></td></tr></table></figure>

<p>如果仅加载具体模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync platform/prebuilts/clang/host/darwin-x86</span><br></pre></td></tr></table></figure>

<h2 id="防止下载源码执行脚本卡死"><a href="#防止下载源码执行脚本卡死" class="headerlink" title="防止下载源码执行脚本卡死"></a>防止下载源码执行脚本卡死</h2><p>通过自定义Shell脚本启动源码下载可以有效防止，同步源码时脚本被卡死的问题。</p>
<p>在AOSP文件夹中新建down.sh文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">echo “======= start repo sync =======”</span><br><span class="line">cd ~/Desktop/AOSP</span><br><span class="line">repo sync -j4</span><br><span class="line">while [ $? == 1 ]; do</span><br><span class="line">echo “====== sync failed! re-sync again =====”</span><br><span class="line">sleep 3</span><br><span class="line">repo sync -j4</span><br></pre></td></tr></table></figure>

<p>执行down.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh down.sh</span><br></pre></td></tr></table></figure>

<h1 id="AOSP源码目录结构"><a href="#AOSP源码目录结构" class="headerlink" title="AOSP源码目录结构"></a>AOSP源码目录结构</h1><ul>
<li><p>abi Application Binary Interface 应用程序二进制接口，abi相信同学们在SO库调用上遇到过，如果不支持该平台的话就说不ABI不支持。</p>
</li>
<li><p>art Android Runtime 安卓运行时。这个会提前把字节码编译成二进制机器码保存起来，执行的时候加载速度比较快。Dalvik虚拟机则是在加载以后再去编译的，所以速度上ART会比Dalvik快一点。牺牲空间来赢取时间。</p>
</li>
<li><p>bionic 基础库，Android系统与Linux内核的桥梁。Bionic 音标为 bīˈänik，翻译为”仿生”。</p>
</li>
<li><p>bootable 系统启动引导相关程序</p>
</li>
<li><p>build 用于构建Android系统的工具，也就是用于编译Android系统的</p>
</li>
<li><p>cts Compatibility Test Suite 兼容性测试</p>
</li>
<li><p>dalvik dalvik虚拟机，用于解析执行dex文件的虚拟机</p>
</li>
<li><p>developers 开发者目录</p>
</li>
<li><p>developerment 开发目录，比如说应用，application就在里面了，apps</p>
</li>
<li><p>devices 设备相关的配置信息，什么索尼、HTC、自己的产品，就可以定义在这个目录下了</p>
</li>
<li><p>docs 文档</p>
</li>
<li><p>external 开源模组相关文件</p>
</li>
<li><p>frameworks 系统架构，Android的核心了</p>
</li>
<li><p>hardware hal层代码，硬件抽象层</p>
</li>
<li><p>libcore 核心库</p>
</li>
<li><p>libnativehelper native帮助库，实现JNI的相关文件</p>
</li>
<li><p>ndk native development kit</p>
</li>
<li><p>out 输出目录，编译以后生成的目录，相关的产出就在这里了</p>
</li>
<li><p>packages 应用程序包。一些系统的应用就在这里了，比如说蓝牙，Launcher，相机，拨号之类的。</p>
</li>
<li><p>pdk Plug-in Development Kit (PDK) is designed to help you build your own pattern projects</p>
</li>
<li><p>platform_testing 平台测试</p>
</li>
<li><p>prebuilts x86/arm架构下预编译的文件</p>
</li>
<li><p>sdk software development kit</p>
</li>
<li><p>system 底层系统文件</p>
</li>
<li><p>toolchain 工具链</p>
</li>
<li><p>tools 工具文件</p>
</li>
<li><p>Makefile mk文件，用于控制编译</p>
</li>
</ul>
<h1 id="AOSP源码编译"><a href="#AOSP源码编译" class="headerlink" title="AOSP源码编译"></a>AOSP源码编译</h1><h2 id="编译前准备"><a href="#编译前准备" class="headerlink" title="编译前准备"></a>编译前准备</h2><h3 id="交换空间设置"><a href="#交换空间设置" class="headerlink" title="交换空间设置"></a>交换空间设置</h3><p>编译时非常吃内存，比如Android12,16G都是不够的，我这边主机是32G的，虚拟机分配了16G，交换空间又给了32G。（一开始虚拟机分配了8G，结果编译到95%时OOM了……）</p>
<p>Linux 的交换分区（swap），或者叫内存置换空间（swap space），是磁盘上的一块区域，可以是一个分区，也可以是一个文件，或者是他们的组合。交换分区的作用是，当系统物理内存吃紧时，Linux 会将内存中不常访问的数据保存到 swap 上，这样系统就有更多的物理内存为各个进程服务，而当系统需要访问 swap 上存储的内容时，再将 swap上的数据加载到内存中，也就是常说的 swap out 和 swap in。我们安装的Ubuntu默认一般是2G左右的swap空间，（可以提供过free -m命令查看虚拟内存与交换空间大小）使用以下命令查看swap详情：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon -s</span><br></pre></td></tr></table></figure>

<p><img src="/images/android_aosp_down_make06.png" alt="image-20230310144708667"></p>
<h3 id="配置交换空间"><a href="#配置交换空间" class="headerlink" title="配置交换空间"></a>配置交换空间</h3><p>停用交换文件：(根据自己虚拟机来指定/swapfile 还是其他的挂载文件)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff /swapfile</span><br></pre></td></tr></table></figure>

<p>删除文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /swapfile</span><br></pre></td></tr></table></figure>

<p>删除后继续创建。<br>新建swap空间，以32G为例，创建文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fallocate -l 32G /swapfile</span><br></pre></td></tr></table></figure>

<p>这里我们是命名为“swapfile”，当然你也可以随意写。设置文件权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 600 /swapfile</span><br></pre></td></tr></table></figure>

<p>挂载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkswap /swapfile</span><br></pre></td></tr></table></figure>

<p>激活启用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapon /swapfile</span><br></pre></td></tr></table></figure>

<p>接着把交换信息写入系统配置，不然Ubuntu重启后以上配置swap空间工作得重新做。<br>使用vim编辑器打开配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fstab</span><br></pre></td></tr></table></figure>

<p>如果提示vim找不到命令，使用以下命令安装vim，然后再次打开配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install vim</span><br></pre></td></tr></table></figure>

<p>在最后一行插入（vim打开后按i进入编辑模式，移动光标到最后回车换行）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/swapfile swap swap defaults 0 0</span><br></pre></td></tr></table></figure>

<p>编辑好之后按ESC键退出编辑模式，然后依次输入:wq(英文冒号+wq)保存退出，并重启即可。</p>
<h3 id="交换空间未使用"><a href="#交换空间未使用" class="headerlink" title="交换空间未使用"></a>交换空间未使用</h3><p>系统只有当虚拟内存不足才会启动Swap，比如系统默认内存只有6000KB时才会启用交换空间，但是此时系统可能已经卡死，无法启动swap，所以需要更改设置。</p>
<p>终端输入命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>在最后面添加如下语句（按i进入编辑模式，光标移到最后，插入语句）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.min_free_kbytes=1500000 #大致1.5G</span><br></pre></td></tr></table></figure>

<p>保存退出（按ESC退出编辑模式，输入:wq保存退出）然后重启开机。<br>以上配置的意思是，当系统内存不足1.5G时就启用交换空间，这是因为我分配给Ubuntu<br>的内存为8G。而如果你虚拟机分配的内存是4G，那建议不要设置1.5G就启用交换空间，<br>可以调小一些，比如调整为1G：<br>vm.min_free_kbytes=1000000</p>
<h2 id="配置java环境"><a href="#配置java环境" class="headerlink" title="配置java环境"></a>配置java环境</h2><p>已有请忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure>

<h2 id="进入AOSP文件夹进行编译"><a href="#进入AOSP文件夹进行编译" class="headerlink" title="进入AOSP文件夹进行编译"></a>进入AOSP文件夹进行编译</h2><p>初始化编译环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br></pre></td></tr></table></figure>

<p>删除上一次编译的结果，初次编译可以不需要这一步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">make clean</span></span><br><span class="line"><span class="meta">#</span><span class="bash">它会删除本次设置所生成的所有的output与中间文件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">等价于指令 rm -rf <span class="variable">$OUT</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$OUT</span>指的是out/target/product/[product_name]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">make clobber</span></span><br><span class="line"><span class="meta">#</span><span class="bash">它会删除所有设置所生成的所有的output与中间文件。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">等价于指令 rm -rf out/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">可以看到，make clobber的严格在于它把整个out目录都删除了。</span></span><br><span class="line">make clobber</span><br></pre></td></tr></table></figure>

<p>选择与设备对应的编译版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lunch XX</span><br></pre></td></tr></table></figure>

<p>选择与设备对应的编译版本.如:编译开发工程师的版本<code>lunch aosp_x86-eng</code>，可以方便debug<br><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://source.android.com/setup/build/running%23selecting-device-build">编译版本选择</a></p>
<p>如果<code>lunch</code>命令没有加对应的编译版本则会有以下信息输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">You&#x27;re building on Linux</span><br><span class="line"></span><br><span class="line">Lunch menu... pick a combo:</span><br><span class="line">     1. aosp_arm-eng //这种是必须有 arm CPU架构的 Google手机 才能尝试</span><br><span class="line">     2. aosp_arm64-eng//这种是必须有 arm64 CPU架构的 Google手机 才能尝试</span><br><span class="line">     3. aosp_barbet-userdebug//这种是 开放部分权限，运行root的版本</span><br><span class="line">     4. aosp_blueline-userdebug</span><br><span class="line">     5. aosp_blueline_car-userdebug</span><br><span class="line">     6. aosp_bonito-userdebug</span><br><span class="line">     7. aosp_bonito_car-userdebug</span><br><span class="line">     8. aosp_bramble-userdebug</span><br><span class="line">     9. aosp_bramble_car-userdebug</span><br><span class="line">     10. aosp_car_arm-userdebug//车载级别的，真正的车企设备才会尝试，arm</span><br><span class="line">CPU指令 的 车载设备</span><br><span class="line">     11. aosp_car_arm64-userdebug</span><br><span class="line">     12. aosp_car_x86-userdebug</span><br><span class="line">     13. aosp_car_x86_64-userdebug</span><br><span class="line">     14. aosp_cf_arm64_auto-userdebug</span><br><span class="line">     15. aosp_cf_arm64_phone-userdebug</span><br><span class="line">     16. aosp_cf_x86_64_foldable-userdebug</span><br><span class="line">     17. aosp_cf_x86_64_pc-userdebug</span><br><span class="line">     18. aosp_cf_x86_64_phone-userdebug</span><br><span class="line">     19. aosp_cf_x86_64_tv-userdebug</span><br><span class="line">     20. aosp_cf_x86_auto-userdebug</span><br><span class="line">     21. aosp_cf_x86_phone-userdebug</span><br><span class="line">     22. aosp_cf_x86_tv-userdebug</span><br><span class="line">     23. aosp_coral-userdebug</span><br><span class="line">     24. aosp_coral_car-userdebug</span><br><span class="line">     25. aosp_crosshatch-userdebug</span><br><span class="line">     26. aosp_crosshatch_car-userdebug</span><br><span class="line">     27. aosp_crosshatch_vf-userdebug</span><br><span class="line">     28. aosp_flame-userdebug</span><br><span class="line">     29. aosp_flame_car-userdebug</span><br><span class="line">     30. aosp_redfin-userdebug</span><br><span class="line">     31. aosp_redfin_car-userdebug</span><br><span class="line">     32. aosp_redfin_vf-userdebug</span><br><span class="line">     33. aosp_sargo-userdebug</span><br><span class="line">     34. aosp_sargo_car-userdebug</span><br><span class="line">     35. aosp_sunfish-userdebug</span><br><span class="line">     36. aosp_sunfish_car-userdebug</span><br><span class="line">     37. aosp_trout_arm64-userdebug</span><br><span class="line">     38. aosp_trout_x86-userdebug</span><br><span class="line">     39. aosp_x86-eng</span><br><span class="line">     40. aosp_x86_64-eng</span><br><span class="line">     41. arm_krait-eng</span><br><span class="line">     42. arm_v7_v8-eng</span><br><span class="line">     43. armv8-eng</span><br><span class="line">     44. armv8_cortex_a55-eng</span><br><span class="line">     45. armv8_kryo385-eng</span><br><span class="line">     46. beagle_x15-userdebug</span><br><span class="line">     47. beagle_x15_auto-userdebug</span><br><span class="line">     48. car_x86_64-userdebug</span><br><span class="line">     49. db845c-userdebug</span><br><span class="line">     50. fuchsia_arm64-eng</span><br><span class="line">     51. fuchsia_x86_64-eng</span><br><span class="line">     52. gsi_car_arm64-userdebug</span><br><span class="line">     53. gsi_car_x86_64-userdebug</span><br><span class="line">     54. hikey-userdebug</span><br><span class="line">     55. hikey64_only-userdebug</span><br><span class="line">     56. hikey960-userdebug</span><br><span class="line">     57. hikey960_tv-userdebug</span><br><span class="line">     58. hikey_tv-userdebug</span><br><span class="line">     59. pixel3_mainline-userdebug</span><br><span class="line">     60. poplar-eng</span><br><span class="line">     61. poplar-user</span><br><span class="line">     62. poplar-userdebug</span><br><span class="line">     63. qemu_trusty_arm64-userdebug</span><br><span class="line">     64. sdk_car_arm-userdebug</span><br><span class="line">     65. sdk_car_arm64-userdebug</span><br><span class="line">     66. sdk_car_x86-userdebug</span><br><span class="line">     67. sdk_car_x86_64-userdebug//这个是车载，车载AOSP运行到，车载设备</span><br><span class="line">x86_64 CPU指令的版本</span><br><span class="line">     68. silvermont-eng</span><br><span class="line">     69. uml-userdebug</span><br><span class="line">     70. yukawa-userdebug</span><br><span class="line">     71. yukawa_sei510-userdebug</span><br><span class="line"></span><br><span class="line">Which would you like? [aosp_arm-eng]</span><br></pre></td></tr></table></figure>

<p>这里需要选择编译目标的格式(选择前面的序号，按回车即可)，编译目标的格式组成为<code>BUILD-BUILDTYPE</code>，比如aosp_arm-eng的BUILD为aosp_arm，BUILDTYPE为eng。 其中BUILD表示编译出的镜像可以运行在什么环境，aosp代表Android开源项目，arm表示系统是运行在arm架构的处理器上。 更多参考官方文档<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://source.android.google.cn/source/running.html%23selecting-device-build">文档</a>。<br> BUILDTYPE 指的是编译类型，有以下三种：</p>
<ul>
<li>user：用来正式发布到市场的版本，权限受限，如没有 root 权限，不能 dedug，adb默认处于停用状态。</li>
<li>userdebug：在user版本的基础上开放了 root 权限和 debug 权限，adb默认处于启用状态。一般用于调试真机。</li>
<li>eng：开发工程师的版本，拥有最大的权限(root等)，具有额外调试工具的开发配置。一般用于模拟器。<br> 如果你没有Nexus设备，只想编译完后运行在模拟器查看，那么BUILD可以选择aosp_x86，BUILDTYPE选择eng。</li>
</ul>
<p>如果需要跑模拟器，则必须选择sdk开头的。</p>
<p>开始编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">m或者make均可</span></span><br><span class="line"><span class="meta">#</span><span class="bash">m，会根据当前CPU的能力，自动控制性能来编译</span></span><br><span class="line"><span class="meta">#</span><span class="bash">make -j4，开启多线程来编译，数字即为线程数</span></span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>

<p>j后面数字几就是多少线程，最多不超过你的cpu总线程，<br>编译成功会显示如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Creating filesystem with parameters:</span><br><span class="line">    Size: 2147483648</span><br><span class="line">    Block size: 4096</span><br><span class="line">    Blocks per group: 32768</span><br><span class="line">    Inodes per group: 8192</span><br><span class="line">    Inode size: 256</span><br><span class="line">    Journal blocks: 8192</span><br><span class="line">    Label: system</span><br><span class="line">    Blocks: 524288</span><br><span class="line">    Block groups: 16</span><br><span class="line">    Reserved block group size: 127</span><br><span class="line">Created filesystem with 2216/131072 inodes and 199826/524288 blocks</span><br><span class="line"><span class="meta">[100%</span><span class="bash"> 7669/7669] Install system fs ima.../target/product/generic_x86/system.img</span></span><br><span class="line">out/target/product/generic_x86/system.img+ maxsize=2192446080 blocksize=2112 total=2147483648 reserve=22146432</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### make completed successfully (01:24:41 (hh:mm:ss)) ####</span></span></span><br></pre></td></tr></table></figure>

<p>会在源码跟目录out/target/product/angler目录下生成镜像文件：</p>
<ul>
<li>system.img：系统镜像</li>
<li>ramdisk.img：根文件系统镜像</li>
<li>userdata.img：用户数据镜像</li>
<li>recovery.img:recovery镜像</li>
<li>boot.img:启动镜像</li>
<li>vendor.img:驱动镜像</li>
</ul>
<p>最终会在 out/target/product/generic_x86/目录生成了三个重要的镜像文件： system.img、userdata.img、ramdisk.img。大概介绍着三个镜像文件：</p>
<ul>
<li>system.img：系统镜像，里面包含了Android系统主要的目录和文件，通过init.c进行解析并mount挂载到/system目录下。</li>
<li>userdata.img：用户镜像，是Android系统中存放用户数据的，通过init.c进行解析并mount挂载到/data目录下。</li>
<li>ramdisk.img：根文件系统镜像，包含一些启动Android系统的重要文件，比如init.rc。</li>
</ul>
<h2 id="编译错误解决"><a href="#编译错误解决" class="headerlink" title="编译错误解决"></a>编译错误解决</h2><h3 id="缺少libncurses-so-5"><a href="#缺少libncurses-so-5" class="headerlink" title="缺少libncurses.so.5"></a>缺少libncurses.so.5</h3><p>报错信息:<br> <code>error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</code><br> 解决方式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<p>for 32-bit binaries :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5:i386</span><br></pre></td></tr></table></figure>

<p>for 64-bit binaries :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5</span><br></pre></td></tr></table></figure>

<h3 id="缺少M4"><a href="#缺少M4" class="headerlink" title="缺少M4"></a>缺少M4</h3><p>报错信息:<br><code>/bin/bash: m4: command not found</code><br>解决方式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install m4</span><br></pre></td></tr></table></figure>

<h3 id="去除所有本地化设置"><a href="#去除所有本地化设置" class="headerlink" title="去除所有本地化设置"></a>去除所有本地化设置</h3><p>报错信息:<br><code>FAILED: out/host/linux-x86/obj/EXECUTABLES/checkpolicy_intermediates/policy_scan.c</code><br>解决方法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LC_ALL=C</span><br></pre></td></tr></table></figure>

<p>LC_ALL=C 是为了去除所有本地化的设置，让命令能正确执行， 但是不可以修改~/.bashrc，会导致终端内中文显示为数字(应该是对应的编码)</p>
<h3 id="jack-server问题"><a href="#jack-server问题" class="headerlink" title="jack-server问题"></a>jack-server问题</h3><p><strong>jack server交互命令:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jack-admin start-server</span><br><span class="line">jack-admin kill-server</span><br><span class="line">jack-admin list-server</span><br><span class="line">jack-admin uninstall-server</span><br><span class="line">mm -j32 showcommands &amp;&gt; mm.out</span><br><span class="line">jack-admin install-server jack-launcher.jar  jack-server-4.8.ALPHA.jar</span><br><span class="line">jack-admin dump-report</span><br><span class="line">jack-admin dump-re</span><br><span class="line">jack-admin server-log  查找log所在目录</span><br></pre></td></tr></table></figure>

<p><strong>问题一：多用户同时编译时报错</strong><br>错误信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FAILED: setup-jack-server</span><br><span class="line">/bin/bash -c &quot;(prebuilts/sdk/tools/jack-admin install-server prebuilts/sdk/tools/jack-launcher.jar prebuilts/sdk/tools/jack-server-4.11.ALPHA.jar  2&gt;&amp;1 || (exit 0) ) &amp;&amp; (JACK_SERVER_VM_ARGUMENTS=\&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation\&quot; prebuilts/sdk/tools/jack-admin start-server 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update server prebuilts/sdk/tools/jack-server-4.11.ALPHA.jar 4.11.ALPHA 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update jack prebuilts/sdk/tools/jacks/jack-4.31.CANDIDATE.jar 4.31.CANDIDATE || exit 47 )&quot;</span><br><span class="line">Jack server already installed in &quot;/home/disk/lixialong/.jack-server&quot;</span><br><span class="line">Communication error with Jack server (35), try &#x27;jack-diagnose&#x27; or see Jack server log</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br></pre></td></tr></table></figure>

<p>解决方案：同时修改<img src="https://math.jianshu.com/math?formula=HOME/.jack-settings%E5%92%8C" alt="HOME/.jack-settings和">HOME/.jack-server/config.properties中的端口号（比如都改为8386/8387，端口号值为0~65535，1024下的值不要用），方可支持多用户同时编译。<br> 查看端口是否一致：cat ~/.jack-server/config.properties|grep -i port &amp;&amp; cat ~/.jack|grep -i port|grep -v LOG &amp;&amp;cat ~/.jack-settings|grep -i port</p>
<ol>
<li>$HOME/.jack-settings</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT_SERVICE=8386</span><br><span class="line">SERVER_PORT_ADMIN=8387</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>$HOME/.jack-server/config.properties</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jack.server.service.port=8386</span><br><span class="line">jack.server.admin.port=8387</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>$HOME/.jack</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT_SERVICE=8288</span><br><span class="line">SERVER_PORT_ADMIN=8289</span><br></pre></td></tr></table></figure>

<p><strong>问题二： No Jack server running. Try ‘jack-admin start-server’</strong><br>错误信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.android.jack.server.api.v01.ServerException: &#x27;./config.properties&#x27; musthave permission rw------- but have rwx------</span><br><span class="line">Caused by: java.io.IOException: &#x27;./config.properties&#x27; must have permissionrw------- but have rwx------</span><br><span class="line">... </span><br></pre></td></tr></table></figure>

<p>解决方案：通过查看文件 <img src="https://math.jianshu.com/math?formula=HOME/.jack-server/logs/jack-server-0-0.log%EF%BC%9A%20%E5%8F%91%E7%8E%B0%E6%98%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90%E4%B8%8D%E5%AF%B9%E9%80%A0%E6%88%90%E7%9A%84%EF%BC%8C%E6%8A%8A%E6%96%87%E4%BB%B6" alt="HOME/.jack-server/logs/jack-server-0-0.log： 发现是配置文件的权限不对造成的，把文件">HOME/.jack-server/config.properties的权限由rwx改为rw即可解决问题。<br><strong>问题三：未配置变量信息导致问题</strong><br>错误信息:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Communication error with Jack server (52) make: *** [out/target/common/obj/JAVA_LIBRARIES/libutil_intermediates/classes.jack] Error</span><br></pre></td></tr></table></figure>

<p>这种情况多半属于jack-admin缺少变量JACK_JAR而导致的。</p>
<p>解决方案：<br>工程根目录内执行以下三句，再进行编译。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export JACK_JAR=./out/host/linux-x86/framework/jack.jar</span><br><span class="line"></span><br><span class="line">./out/host/linux-x86/bin/jack-admin stop-server</span><br><span class="line"></span><br><span class="line">./out/host/linux-x86/bin/jack-admin start-server</span><br></pre></td></tr></table></figure>

<p><strong>问题四:TLSv1， TLSv1.1 禁用</strong><br>报错信息:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ensuring Jack server is installed and started</span><br></pre></td></tr></table></figure>

<p>解决方式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/java-8-openjdk/security/java.security</span><br></pre></td></tr></table></figure>

<p>vim里面输入/搜索jdk.tls.disabledAlgorithms= 将TLSv1， TLSv1.1 光标选中输入x删除掉取消禁用.然后wq保存.<br>修改后:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, \</span><br><span class="line">    DH keySize &lt; 1024, EC keySize &lt; 224, 3DES_EDE_CBC, anon, NULL, \</span><br><span class="line">    include jdk.disabled.namedCurves</span><br></pre></td></tr></table></figure>

<p>aosp/prebuilts/sdk/tools/ 目录下执行./jack-admin kill-server &amp;&amp; ./jack-admin start-server 成功。</p>
<h3 id="xmllint的问题"><a href="#xmllint的问题" class="headerlink" title="xmllint的问题"></a>xmllint的问题</h3><p>报错信息:<br><code>/bin/bash: xmllint: command not found</code><br>解决方案:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get  install libxml2-utils</span><br></pre></td></tr></table></figure>

<h3 id="编译内存不足"><a href="#编译内存不足" class="headerlink" title="编译内存不足"></a>编译内存不足</h3><p>报错信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Try increasing heap size with java option &#x27;-Xmx&lt;size&gt;&#x27;错误</span><br></pre></td></tr></table></figure>

<p>解决方案:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JACK_SERVER_VM_ARGUMENTS=&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4g&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jack-admin kill-server</span><br><span class="line">jack-admin start-server</span><br></pre></td></tr></table></figure>

<h1 id="运行模拟器"><a href="#运行模拟器" class="headerlink" title="运行模拟器"></a>运行模拟器</h1><h2 id="启动模拟器"><a href="#启动模拟器" class="headerlink" title="启动模拟器"></a>启动模拟器</h2><p>在编译完成之后，就可以通过以下命令运行Android虚拟机了，由于之前已经执行过source和lunch命令了，可以直接运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line">lunch sdk_car_x86_64-userdebug</span><br><span class="line">emulator</span><br></pre></td></tr></table></figure>

<h2 id="启动模拟器失败"><a href="#启动模拟器失败" class="headerlink" title="启动模拟器失败"></a>启动模拟器失败</h2><h3 id="libncurses-so-5缺少"><a href="#libncurses-so-5缺少" class="headerlink" title="libncurses.so.5缺少"></a>libncurses.so.5缺少</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aosp error while loading shared libraries: libncurses.so.5</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解决方法：</span></span><br><span class="line">sudo apt install apt-file</span><br><span class="line">sudo apt-file update</span><br><span class="line">sudo apt-file find libncurses.so.5</span><br><span class="line">sudo apt install libncurses5</span><br></pre></td></tr></table></figure>

<h3 id="缺少文件userdata-qemu-img"><a href="#缺少文件userdata-qemu-img" class="headerlink" title="缺少文件userdata-qemu.img"></a>缺少文件userdata-qemu.img</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cannot addlibrary /root/aosp/prebuilts/android-emulator/linux-</span><br><span class="line">x86_64/qemu/linux-x86_64/lib64/vulkan/libvulkan.so: failedadded library</span><br><span class="line">/root/aosp/prebuilts/android-emulator/linux-</span><br><span class="line">x86_64/lib64/vulkan/libvulkan.soemulator: ERROR:</span><br><span class="line">VkCommonOperations.cpp:537: Failed to create Vulkan instance.qemu-</span><br><span class="line">system-x86_64: Could not</span><br><span class="line">open&#x27;/root/aosp/out/target/product/generic_x86_64/userdata-qemu.img&#x27;:No</span><br><span class="line">such fileor directory</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">编译“aosp_car_x86_64-userdebug”，完成后执行emulator无法正常进入模拟器</span></span><br><span class="line"><span class="meta">#</span><span class="bash">由于编译“aosp_car_x86_64-userdebug”不会生成qemu所需镜像， 所以必须编译</span></span><br><span class="line"><span class="meta">#</span><span class="bash">SDK_xxx <span class="string">&quot;sdk_car_x86_64-userdebug&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">解决方法：</span></span><br><span class="line">source build/envsetup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">lunch aosp_car_x86_64-userdebug 【这一行是 错误的关键点】</span></span><br><span class="line"><span class="meta">#</span><span class="bash">【换成sdk后，才能启动车载模拟器】</span></span><br><span class="line">lunch sdk_car_x86_64-userdebug</span><br><span class="line">make -j4</span><br><span class="line">emulator</span><br></pre></td></tr></table></figure>

<h3 id="模拟器启动后界面一直处于phone-is-starting"><a href="#模拟器启动后界面一直处于phone-is-starting" class="headerlink" title="模拟器启动后界面一直处于phone is starting"></a>模拟器启动后界面一直处于phone is starting</h3><p><img src="/images/android_aosp_down_make07.png" alt="image"></p>
<p>解决方案</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">使用emulator命令和emulator -partition-size 200来回重试</span></span><br><span class="line"><span class="meta">#</span><span class="bash">我遇到的这种情况时一般重试两次就好了，挺奇怪的一个问题……</span></span><br><span class="line">emulator</span><br><span class="line">emulator -partition-size 200</span><br></pre></td></tr></table></figure>



<h1 id="AOSP源码编译某个单独的模块"><a href="#AOSP源码编译某个单独的模块" class="headerlink" title="AOSP源码编译某个单独的模块"></a>AOSP源码编译某个单独的模块</h1><p>上面的编译我们都是对整个Android系统进行编译的.如果我们要编译系统的Settings应用模块，这就属于源码单编某一个模块.<br> 在AOSP根目录执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line">lunch aosp_x86-eng</span><br></pre></td></tr></table></figure>

<p>进入Settings的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd packages/apps/Settings</span><br></pre></td></tr></table></figure>

<p>通过mm编译当前目录下的模块，不编译依赖模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm</span><br></pre></td></tr></table></figure>

<p>编译成功后会有提示生成文件的存放路径。除了Settings.odex文件，还会在out/target/product/generic_x86/system/priv-app/Settings目录下生成Settings.apk。<br> 此外还有以下命令可以进行单编：</p>
<ul>
<li>mmm：编译指定目录下的模块，不编译它所依赖的其它模块。</li>
<li>mma：编译当前目录下的模块及其依赖项。</li>
<li>mmma：编译指定路径下所有模块，并且包含依赖。</li>
</ul>
<p>如果对系统模块的源码进行修改，查看生成的APK文件，有两种方式：</p>
<ul>
<li>通过adb push或者adb install 来安装APK。</li>
<li>使用make snod命令，重新生成 system.img，运行模拟器查看。</li>
</ul>
<h1 id="导入源码到AndroidStudio"><a href="#导入源码到AndroidStudio" class="headerlink" title="导入源码到AndroidStudio"></a>导入源码到AndroidStudio</h1><h2 id="编译idegen模块，生成IDE项目文件"><a href="#编译idegen模块，生成IDE项目文件" class="headerlink" title="编译idegen模块，生成IDE项目文件"></a>编译idegen模块，生成IDE项目文件</h2><p>在源码中，存在idegen模块，该模块专门用来为idea工具生成系统源码的project.默认情况下aosp编译并不会生成该文件。<br> 在开始编译该模块之前，首先确保你已经编译过Android源码了，如果没有，先要进行AOSP编译.和编译普通的模块一样，我们用mmm命令编译idegen.<br> 在开始编译之前，检查out/host/linux-x86/framework/目录下是否存在idegen.jar文件，存在则说明你已经编译过该模块，否者，则需要编译.执行如下命令即可:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh 将脚本添加到系统内</span><br><span class="line">lunch 并选择要编译的项目</span><br><span class="line">mmm development/tools/idegen/ </span><br><span class="line">sudo ./development/tools/idegen/idegen.sh</span><br></pre></td></tr></table></figure>

<p>其中mmm development/tools/idegen/执行完成后会生成idegen.jar，而sodo ./development/tools/idegen/idegen.sh则会在源码目录下生成IEDA工程配置文件:android.ipr，android.iml及android.iws.</p>
<p>简单的说明一下这三个文件的作用:</p>
<ul>
<li>android.ipr:通常是保存工程相关的设置，比如编译器配置，入口，相关的libraries等</li>
<li>android.iml:则是主要是描述了modules，比如modules的路径，依赖关系等.</li>
<li>android.iws:则主要是包含了一些个人工作区的设置.</li>
</ul>
<blockquote>
<p>“android.iml”和”android.ipr”一般是”只读”的属性，我们这里建议大家，把这两个文件改成可读可写，否则，在更改一些项目配置的时候可能会出现无法保存的情况，执行如下两条命令即可。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 android.iml</span><br><span class="line">sudo chmod 777 android.ipr</span><br></pre></td></tr></table></figure>

<h2 id="导入源码到AndroidStudio-1"><a href="#导入源码到AndroidStudio-1" class="headerlink" title="导入源码到AndroidStudio"></a>导入源码到AndroidStudio</h2><h3 id="配置AS"><a href="#配置AS" class="headerlink" title="配置AS"></a>配置AS</h3><p>IDE内存优化<br> 因为源码数量非常多，所以导入时IDEA/AS会需要大量内存。所以我们需要编辑IDE的VM选项。配置文件为</p>
<p>IDEA的是IDEA_HOME/bin/idea.vmoptions<br> AS的是AS_HOME/bin/studio.vmoptions<br> 注意，AS有一个64位版本的配置文件studio64.vmoptions最好一并修改了。</p>
<p>找到上面的配置文件，将对应的内容修改为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms748m -Xmx748m</span><br></pre></td></tr></table></figure>

<p>即将VM的堆内存最小和最大都设置为748m。官方要求至少在748m以上，根据实际情况进行配置即可</p>
<h3 id="导入源码"><a href="#导入源码" class="headerlink" title="导入源码"></a>导入源码</h3><p>接下来，我们导入源码:打开Android Studio，点击File-&gt;Open，选择刚才生成的android.ipr文件即可，然后就是漫长的等待，注意此时是将源码完全导入到AS中了。<br> 如果AS运行比较慢我们就需要排除一些不需要导入的模块。</p>
<h3 id="排除模块"><a href="#排除模块" class="headerlink" title="排除模块"></a>排除模块</h3><p>很多情况下，我们希望不导入某些模块，那么就可以在导入前修改android.iml文件，通过添加配置的方式告诉AS不导入某些模块，比如现在我不想导入art模块，那么就在android.iml文件中添加:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">excludeFloder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$&quot;</span>/<span class="attr">abi</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>不难发现，其格式为:<code>&lt;excludeFloder url=&quot;file://$MODULE_DIR$&quot;/模块名&gt;</code></p>
<blockquote>
<p>注:编译生成的android.iml文件中已经默认排除了一些模块，通过搜索excludeFolder关键字可找到.</p>
</blockquote>
<p>如果比较关心framworks和packages模块，则保留framworks和packages模块，将其他模块全部排除，在android.iml中添加了以下配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/.repo&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/abi&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/art&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/bionic&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/bootable&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/build&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/cts&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/dalvik&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/developers&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/development&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/device&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/docs&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/bluetooth&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/chromium&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/emma&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/icu4c&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/jdiff&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/external/webkit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/frameworks/base/docs&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/frameworks/base/extension&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/hardware&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/kernel&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/kernel-3.18&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/libcore&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/libnativehelper&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/ndk&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/oem-release&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out/eclipse&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out/host&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out/target/common/docs&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out/target/common/obj/JAVA_LIBRARIES/android_stubs_current_intermediates&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/out/target/product&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/pdk&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/platform_testing&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/prebuilt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/prebuilts&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/rc_projects&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/sdk&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/system&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/tools&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/trusty&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludeFolder</span> <span class="attr">url</span>=<span class="string">&quot;file://$MODULE_DIR$/vendor&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>完成之后，按照上面说的步骤，使用Android Studio选中”android.ipr”打开项目即可。</p>
<blockquote>
<p>等项目加载完成后，我们还可以通过Android Studio对Exclude的Module进行调整，所以也不用害怕这里Exclude掉了有用的代码，或少Exclude了一部分代码，在项目加载完以后再进行调整就行了。此处和在android.iml文件中添加excludeFolder 的功能是一样的；</p>
</blockquote>
<p>打开”Project Structure”，中间的窗口选择”android”，在弹出的窗口中左边栏中选择”Modules”，而后在右边的窗口中选择”Sources”。<br> 在这里我们可以看到项目的所有代码目录，我们可以选中不需要的module，并点击上面的”Excluded”按钮，当被选中的目录变为橙色，即表示完成Exclude操作；<br> 如果想要取消对某代码目录的Exclude操作，选中该目录，再次点击”Excluded”按钮，等待目录变为蓝色即可。</p>
<p><img src="/images/android_aosp_down_make01.png" alt="img"></p>
<h3 id="配置源码正确跳转"><a href="#配置源码正确跳转" class="headerlink" title="配置源码正确跳转"></a>配置源码正确跳转</h3><p>当我们导入完源码后，就可以查看整个系统的源码，但是有个问题，打开的Java代码，查看集成关系或者调用关系的时候，还是会跳转到.class文件中，而不是相应的Java类，<br> 比如PhoneWindow.java继承了Window.java，但是我们跳转的时候却跳到了Window.class，并没有跳转到frameworks目录下对应的源码类，而是jar包中的类。<br> 我们需要让其跳转到相应的类中。我们就需要新建一个没有任何jar库的SDK给到系统源码项目的依赖， 这里的配置JDK/SDK，是用于解决在分析和调试源码的过程，能正确地跳转到目标源码，<br> 而非SDK中的代码。</p>
<ul>
<li>新建JDK<br> Project Structure -&gt; SDKs， 新建 JDK， 其中JDK目录可选择跟原本JDK一致即可，任意取一个名字，这里取empty_jdk 然后删除这里取empty_jdk其classpath和SourcePath的内容，确保使用Android系统源码文件</li>
</ul>
<p><img src="/images/android_aosp_down_make02.png" alt="img"></p>
<ul>
<li>配置SDK<br> Project Structure -&gt; SDKs， 选中与自己编译的AOSP对应的SDk版本(如果没有对应的就到SDKmanager里面取下载一个对应的版本) Android API 28 Platform， 然后选择其Java SDK为前面新建的empty_jdk</li>
</ul>
<p><img src="/images/android_aosp_down_make03.png" alt="img"></p>
<ul>
<li>选择SDK<br>Project Structure -&gt; Project -&gt; 选中Project SDK， 选择前面的Android API 28 Platform</li>
</ul>
<p><img src="/images/android_aosp_down_make04.png" alt="img"></p>
<ul>
<li>建立依赖<br> Project Structure -&gt; Modules -&gt; android -&gt; Dependencies: Module选择我们上面编辑过的SDK。然后点击下图绿色的+号来选择Jars or directories，将 aosp/frameworks 目录添加进来，再按照同样的步骤将aosp/external 目录， 也可添加其他所关注的源码；<br> 然后选中其他所有的依赖，点击右边的下移箭头将其他依赖移动到我们添加的目录下面。(或者将其他的所有依赖删除)</li>
</ul>
<p><img src="/images/android_aosp_down_make05.png" alt="img"></p>
<blockquote>
<p>注意，一般我们大部分人不在ubuntu下开发app ，为了能在Windows或Mac系统下也能使用Android Studio查看源码，<br> 可以按照上面的步骤，那样直接拷贝ubuntu下的android.iml和android.ipr文件到Windows或Mac系统下的android源码根目录下，<br> 然后导入Adnroid Studio中，这样就可以在这两个平台上进行查看源码了。</p>
</blockquote>
<h1 id="通过AS调试源码"><a href="#通过AS调试源码" class="headerlink" title="通过AS调试源码"></a>通过AS调试源码</h1><h2 id="打开模拟器"><a href="#打开模拟器" class="headerlink" title="打开模拟器"></a>打开模拟器</h2><p>要调试代码，首先要打开模拟器，注意不是Android Studio自带的模拟器，而是通过编译后的代码启动的模拟器，否则可能出现代码不对应的问题。<br> 直接运行emulator命令是无法启动的，执行方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source build/envsteup.sh</span><br><span class="line"></span><br><span class="line">lunch 6 //和编译时对应</span><br><span class="line"></span><br><span class="line">emulator</span><br></pre></td></tr></table></figure>

<p>接下来通过Run-&gt;Attache debugger to Android process，在弹出的Choose Process框内必须选择Show all processes，否则看不到相关的进程:然后选择system_process，就可以进行调试了。</p>
<h1 id="Android刷机知识"><a href="#Android刷机知识" class="headerlink" title="Android刷机知识"></a>Android刷机知识</h1><h2 id="BootLoader"><a href="#BootLoader" class="headerlink" title="BootLoader"></a>BootLoader</h2><p>机器首先要启动，CPU 最先执行的一段程序就是 BootLoader，是在操作系统内核运行之前运行的一段小程序。其实Bootloader就相当于电脑的bios。 通过这段小程序，进行硬件初始化，获取内存大小信息等，调整手机到适配状态，从而将系统的软硬件环境带到一个合适状态，以便为最终调用操作系统内核准备好正确的环境。<br> 。很多的手机厂商都会锁住BootLoader，这样你就只能使用官方的系统，想要第三方的ROM能够运行，或者破解官方系统这时候就需要进行bootloader解锁!这是刷机的第一步， 当然也有很多手机没有bootloader锁!我们只需要知道要想刷机就得先bootloader解锁。</p>
<h2 id="FastBoot"><a href="#FastBoot" class="headerlink" title="FastBoot"></a>FastBoot</h2><p>fastboot，它是bootloader后期进入的一个特殊阶段。例如小米手机开机同时按音量下建就会进入这个模式.也是一种模式。可以通过数据线与电脑连接，然后在电脑上执行一些命令，如刷系统镜像到手机上。fastboot可以理解为实现了一个简单的通信协议，接收命令并更新镜像文件，其他什么的干不了。<br> 需使用USB数据线连接电脑和手机的一种线刷刷机模式，大部分第三方的Recovery刷入，或者救砖均是在Fastboot模式下进行，所以这种方式称为线刷。 fastboot需要bootloader的支持，所以不是每家手机都会支持这种模式。Fastboot 可以说是一个通信协议，电脑可以通过这个通信协议，直接向手机系统不同分区中写入文件（.img 文件）。</p>
<h3 id="fastboot-bootloader-模式怎么进入？"><a href="#fastboot-bootloader-模式怎么进入？" class="headerlink" title="fastboot(bootloader)模式怎么进入？"></a>fastboot(bootloader)模式怎么进入？</h3><p>大多数安卓手机，都可以在关机状态下，然后同时按住【电源键】+【音量+】键，大约2-3s后，就可以进入Fastboot模式。 作为开发者在开机状态下可以用下面的方式进入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader</span><br></pre></td></tr></table></figure>

<h3 id="fastboot命令"><a href="#fastboot命令" class="headerlink" title="fastboot命令"></a>fastboot命令</h3><p>然后就可以执行下面的fastboot命令了:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fastboot flashing unlock    #6.0以上设备 设备必须解锁，开始刷机（这个不同的手机厂商不同）</span><br><span class="line">fastboot erase &#123;partition&#125;  # 擦除分区</span><br><span class="line">fastboot  erase  frp    # 擦除 frp 分区，frp 即 Factory Reset Protection，用于防止用户信息在手机丢失后外泄</span><br><span class="line">fastboot  flash  boot  boot.img    # 刷入 boot 分区</span><br><span class="line">fastboot  flash  system  system.img    # 刷入 system 分区</span><br><span class="line">fastboot  flash  recovery  recovery.img    # 刷入 recovery 分区</span><br><span class="line">fastboot flashall    #烧写所有分区，注意：此命令会在当前目录中查找所有img文件，将这些img文件烧写到所有对应的分区中，并重新启动手机。</span><br><span class="line">fastboot  format  data    # 格式化 data 分区</span><br><span class="line">fastboot  flashing lock    # 设备上锁，刷机完毕</span><br><span class="line">fastboot  continue    # 自动重启设备</span><br><span class="line">fastboot reboot# 重启手机</span><br><span class="line">fastboot reboot-bootloader# 重启到bootloader 刷机用</span><br><span class="line">fastboot devices  ## 发现手机，显示当前哪些手机通过fastboot连接了</span><br></pre></td></tr></table></figure>

<h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><p>如果没有进入fastboot，bootloader继续执行，如果又发现有特殊的按键组合，比如小米上是音量上键和开机键，则会进入recovery模式。它里面包含了一个kernel以及一个可执行程序recovery，以<br> 及一些初始化文件。Recovery模式指的是一种可以对安卓机内部的数据或系统进行修改的模式，也叫工程模式，像是电脑上的小型winPE系统，winPE可以在电脑上安装操作系统，或者做些删除备份、管理的工作。<br> 官方Recovery用处不大，所以通常会刷入一个第三方的Recovery ，Recovery 更类似于一个小型的管理系统。只不过功能简单，所做的管理有限。在recovery模式下，会加载了部分文件系统，所以才可以读sdcard中的update.zip进行刷机，当然，也可以清除cache和用户数据。<br> 该模式可根据用户的需要进行修改，因此有官方recovery模式以及第三方recovery模式。第三方recovery模式可以识别第三方rom包，因此可以用来刷机。而官方recovery一般不能识别第三方zip文件。好用的第三方RE:TWRP 和 CWM Recovery刷机包是称为Google Update 格式。在用Recovery恢复时，刷机包通常放在SD卡里，所以这里刷机一般称为卡刷。</p>
<h2 id="线刷和卡刷"><a href="#线刷和卡刷" class="headerlink" title="线刷和卡刷"></a>线刷和卡刷</h2><ul>
<li>线刷： 直接想手机硬盘写入*.img 文件，我个人觉得这种方法比较快捷，而且省事。但是必须借助电脑和数据线。</li>
<li>卡刷：就是利用recovery的从SD卡中更新系统的这个功能，如果你想刷第三方Rom，必须刷入个第三方recovery，只有fastboot模式才能刷recovery.img。卡刷有个限制，必须要把想要更新的ROM（Android系统）拷贝到SD卡上。如果手机已经是砖了。那只能用线刷了。</li>
</ul>
<h1 id="手机硬件驱动知识"><a href="#手机硬件驱动知识" class="headerlink" title="手机硬件驱动知识"></a>手机硬件驱动知识</h1><h2 id="硬件驱动的作用"><a href="#硬件驱动的作用" class="headerlink" title="硬件驱动的作用"></a>硬件驱动的作用</h2><p>AOSP是一个由谷歌维护的开源操作系统开发项目，既然是开源项目，也就意味着任何人都可以自由地审查和贡献代码以及修复项目仓库，而谷歌引领着大方向和大部分的开发工作。AOSP会定期为Android加入最新的安全补丁，谷歌每年也会在其I/O开发者大会上公布操作系统的新功能。除了开放贡献代码外，AOSP还可以在开源许可下自由使用和修改。<br> 比如，小米，华为等厂商根据自己的目的自由调整该项目，并开发了自己的衍生产品，包括多用途的emui和miui。需要注意的是，AOSP包含了开发者构建Android所需的一切，但它并不包括成品智能手机所需的一切。<br> 谷歌和AOSP无法为所有硬件配置提供内核设备驱动。所谓设备驱动，是指手机硬件所需的固件，比如处理器或摄像头。手机和SoC制造商，如高通和三星，必须将这些驱动程序纳入他们的Android构建中。<br> 这也是为什么从AOSP到实际设备的系统更新需要一定时间的原因。其次AOSP也不包含谷歌的软件应用套件，如Chrome浏览器、YouTube，甚至谷歌Play商店。<br> 它也不包括谷歌的一些底层技术和API，而这些技术和API可以实现移动支付、语音命令和云存储等功能，这些都是作为谷歌移动服务（GMS）单独授权的。 任何厂商想要在系统中安装GMS，都必须为自己的设备获得GMS授权和移动应用分发协议（MADA），然后通过多项兼容性测试。有Android兼容性测试套件（CTS）来验证软件和硬件以及API。<br> 正因为AOSP开源的特性，许多的硬件厂商的驱动代码并不是开源的，所以AOSP会有一个硬件抽象层 (HAL)，来保证驱动程序代码不被泄露。大多数手机厂商都是从高通等芯片厂商那里获得AOSP版本，该AOSP版本为硬件量身定坐了高通驱动程序，所以刷入真机是可以正常的运行。</p>
<h2 id="如何添加硬件驱动"><a href="#如何添加硬件驱动" class="headerlink" title="如何添加硬件驱动"></a>如何添加硬件驱动</h2><p>在上面步骤中我们编译好了AOSP可以直接通过模拟器运行.编译aosp时也会生成system.img文件，这个文件是最终刷机用的，但是system.img文件必须依赖驱动文件生成，<br> 如果没有放入对应的驱动就编译，那么生成的镜像也是无法正常刷机的。通过上文我们知道aosp 仅是一套源码，真机运行需要厂商的驱动，厂商的驱动是不包含在AOSP中的，<br> 第三方ROM(如CM等)的厂家驱动是自行提取的。但是google也开源了nexus和pixel对应的AOSP版本的硬件驱动代码.如果我们有nexus或者是pixel设备就可以下载相应的驱动进行编译，<br> 然后将编译好的系统输入到设备中去.</p>
<h3 id="下载对应的驱动"><a href="#下载对应的驱动" class="headerlink" title="下载对应的驱动"></a>下载对应的驱动</h3><p>需要根据你选择的<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://source.android.com/source/build-numbers.html">版本</a><br> 去<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://developers.google.com/android/nexus/drivers%23shamulrx21o">驱动页面</a>下载合适的驱动。</p>
<h3 id="生成驱动"><a href="#生成驱动" class="headerlink" title="生成驱动"></a>生成驱动</h3><p>将驱动文件下载后，解压到AOSP根目录，得到几个.sh文件，执行后，会在AOSP下创建vendor目录，里面包含了驱动。</p>
<h3 id="编译带有驱动的AOSP"><a href="#编译带有驱动的AOSP" class="headerlink" title="编译带有驱动的AOSP"></a>编译带有驱动的AOSP</h3><p>再次<code>make -j4</code>，此次编译的结果就包含了驱动，编译出新的系统.</p>
<h1 id="ROM编译及烧录"><a href="#ROM编译及烧录" class="headerlink" title="ROM编译及烧录"></a>ROM编译及烧录</h1><p>一般定制ROM其实就是对手机内存里的system/app文件夹的内容进行自定义，系统所有的程序都在这个文件夹里，比如浏览器、拨号器、联系人等。自己安装的软件\data\文件夹中。</p>
<h2 id="真机驱动下载"><a href="#真机驱动下载" class="headerlink" title="真机驱动下载"></a>真机驱动下载</h2><p>在上文中可以了解到厂商的驱动是不包含在AOSP中的.因此编译出来的AOSP系统源码要在真机上运行，还需要加上厂商驱动进行编译才能烧录到真机上使用.<br> Google提供了Nexus和Pixel这两个太子机的驱动，我们可以在驱动页面下载合适的驱动。<br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://developers.google.com/android/drivers%23walleye">Driver Binaries for Nexus and Pixel Devices</a></p>
<h2 id="配置真机驱动到AOSP"><a href="#配置真机驱动到AOSP" class="headerlink" title="配置真机驱动到AOSP"></a>配置真机驱动到AOSP</h2><ol>
<li>在上面链接里面,两个文件都进行下载，一个是google vendor，一个qcom。</li>
<li>解压得到<code>extract-google_devices-blueline.sh</code>，<code>extract-qcom-blueline.sh</code></li>
<li>将这两个脚本放到aosp代码目录下，进行提取<br> <code>sh extract-google_devices-blueline.sh</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vendor/</span><br><span class="line">vendor/google_devices/</span><br><span class="line">vendor/google_devices/marlin/</span><br><span class="line">vendor/google_devices/marlin/device-vendor-marlin.mk</span><br><span class="line">vendor/google_devices/marlin/android-info.txt</span><br><span class="line">vendor/google_devices/marlin/BoardConfigVendor.mk</span><br><span class="line">vendor/google_devices/marlin/BoardConfigPartial.mk</span><br><span class="line">vendor/google_devices/marlin/proprietary/</span><br><span class="line">vendor/google_devices/marlin/proprietary/vendor.img</span><br><span class="line">vendor/google_devices/marlin/device-partial.mk</span><br><span class="line"></span><br><span class="line">Files extracted successfully.</span><br></pre></td></tr></table></figure>

<p>第2个 高通驱动<br> <code>sh extract-qcom-blueline.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vendor/</span><br><span class="line">vendor/qcom/</span><br><span class="line">vendor/qcom/marlin/</span><br><span class="line">vendor/qcom/marlin/BoardConfigPartial.mk</span><br><span class="line">vendor/qcom/marlin/proprietary/</span><br><span class="line">vendor/qcom/marlin/proprietary/lib64/</span><br><span class="line">vendor/qcom/marlin/proprietary/lib64/libbcc.so</span><br><span class="line">vendor/qcom/marlin/proprietary/lib64/libLLVM_android.so</span><br><span class="line">vendor/qcom/marlin/proprietary/lib64/libiperf.so</span><br><span class="line">vendor/qcom/marlin/proprietary/lib64/libminui.so</span><br><span class="line">vendor/qcom/marlin/proprietary/ATT_profiles.xml</span><br><span class="line">vendor/qcom/marlin/proprietary/pktlogconf</span><br><span class="line">vendor/qcom/marlin/proprietary/VZW_profiles.xml</span><br><span class="line">vendor/qcom/marlin/proprietary/ROW_profiles.xml</span><br><span class="line">vendor/qcom/marlin/proprietary/libclcore_neon.bc</span><br><span class="line">vendor/qcom/marlin/proprietary/sanitizer-status</span><br><span class="line">vendor/qcom/marlin/proprietary/libiperf.so</span><br><span class="line">vendor/qcom/marlin/proprietary/qcrilhook.jar</span><br><span class="line">vendor/qcom/marlin/proprietary/libminui.so</span><br><span class="line">vendor/qcom/marlin/proprietary/libion.so</span><br><span class="line">vendor/qcom/marlin/proprietary/iperf3</span><br><span class="line">vendor/qcom/marlin/device-partial.mk</span><br><span class="line">vendor/google_devices/</span><br><span class="line">vendor/google_devices/marlin/</span><br><span class="line">vendor/google_devices/marlin/device-vendor-marlin.mk</span><br><span class="line">vendor/google_devices/marlin/android-info.txt</span><br><span class="line">vendor/google_devices/marlin/BoardConfigVendor.mk</span><br><span class="line"></span><br><span class="line">Files extracted successfully.</span><br></pre></td></tr></table></figure>

<p>执行后，会在AOSP下创建vendor目录，里面包含了驱动。编译完成后，执行<code>make fastboot adb</code>单独编译fastboot和adb。</p>
<h2 id="编译Rom"><a href="#编译Rom" class="headerlink" title="编译Rom"></a>编译Rom</h2><p>重新对AOSP进行编译.此次编译的结果就包含了驱动，编译完成后，执行make fastboot adb 单独编译fastboot和adb。</p>
<h2 id="烧录Rom到手机"><a href="#烧录Rom到手机" class="headerlink" title="烧录Rom到手机"></a>烧录Rom到手机</h2><ol>
<li>手机启用开发者模式，打开 USB 调试 adb shell 能进入。</li>
<li>开机键 + 音量- 进入 bootloader 模式。</li>
<li>电脑上能识别出来手机并装上了驱动。</li>
<li>fastboot devices 能看到设备。</li>
<li>再次执行./fastboot -w flashall将开始刷机，刷完会自动重启，over!</li>
</ol>
<p>参考资料:<br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">Android 镜像使用帮助</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.xiaomi.cn/post/10984220">MIUI ROM适配之旅第一天——认识Android手机</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.cnblogs.com/liumce/p/8027559.html">Android FrameWork 学习之Android 系统源码调试</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/luoshengyang/article/details/29688041">从CM刷机过程和原理分析Android系统结构</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/weixin_30924087/article/details/98030409">Android ROM移植</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/innost/article/details/7623951">android rom移植知识普及</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/huil0925/category_6259725_2.html">Android系统源码修改</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/uglychild/article/details/79550793">android系统的分区结构</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/u010142437/article/details/72834972">Android ROM的制作与烧录</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/zhonglunshun/article/details/70256727">android系统源码中添加app源码（源码部署移植）</a></p>
<p>参考资料:<br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.cnblogs.com/caoxinyu/p/10568480.html">Ubentu编译Android源码（AOSP）</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://mouxuejie.com/blog/2019-11-17/aosp-setup/">AOSP源码下载/编译/刷机/调试</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/zy199701/article/details/106478670/">Android rom移植一</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://blog.sina.com.cn/s/blog_b278ce3b010186bw.html">目前通用的Android拼包移植方法均是正向移植</a><br> <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/u010783226/article/details/94406309">Android驱动开发全过程</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/AOSP/" rel="tag"># AOSP</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/03/17/android_tencent_shadow_introduction/" rel="prev" title="Tencent插件化框架Shadow">
                  <i class="fa fa-chevron-left"></i> Tencent插件化框架Shadow
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/02/android_aosp_built_in_app/" rel="next" title="AOSP-预置APP历险记">
                  AOSP-预置APP历险记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小贾</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
